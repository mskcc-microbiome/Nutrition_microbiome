---
title: "Changed visualization per R1 request"
output: html_document
date: "2025-10-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggbeeswarm)
library(cowplot)
```

```{r}
meta <- read_csv('../data/153_combined_META.csv')

points_alpha <- 0.2
```

# microbiome diversity across different conditioning regimen intensities.

```{r}
intensity_break <- meta %>%
  # Reorder the levels for a more logical plot
  mutate(intensity = factor(intensity, levels = c("nonablative", "reduced", "ablative"))) %>%
  # Add a count for each group for plotting
  add_count(intensity, name = "n_samples") %>% 
  ggplot(aes(x = intensity, y = log(simpson_reciprocal))) +
  geom_quasirandom(alpha = points_alpha, width = 0.2) +
  geom_boxplot(width = 0.15, fill = "white", color = "red", linewidth = 1, outlier.shape = NA, alpha = 0.7) +
  
  geom_text(
    aes(label = paste("n =", n_samples), y = -0.5), # Adjust y-position as needed
    stat = "unique", size = 3.5
  ) +
  
  # This is the key function to flip the plot 90 degrees.
  coord_flip() +
  labs(
    title = bquote("Unadjusted "~alpha*"-Diversity by Conditioning Intensity"),
    x = "Conditioning Regimen Intensity",
    y = "log(Inverse Simpson Diversity)"
  ) +
  theme_minimal()
intensity_break
```

# break down by abx and sweets 

## break by median sweets   

```{r}
library(viridis)
# First, calculate the median sweets intake ONLY for samples where sweets were consumed.
# This avoids the median being skewed by all the zeros.
median_sweets_intake <- meta %>%
  filter(fg_sweets > 0) %>%
  summarize(median_val = median(fg_sweets, na.rm = TRUE)) %>%
  pull(median_val)

# Now, create the six distinct exposure groups.
plot_data <- meta %>%
  mutate(
    # The case_when statement defines the logic for each of the six groups.
    exposure_group = case_when(
      !empirical & fg_sweets == 0 ~ "No Abx, No Sweets",
      empirical & fg_sweets == 0 ~ "Abx, No Sweets",
      !empirical & fg_sweets > 0 & fg_sweets <= median_sweets_intake ~ "No Abx, Low Sweets",
      !empirical & fg_sweets > median_sweets_intake ~ "No Abx, High Sweets",
      empirical & fg_sweets > 0 & fg_sweets <= median_sweets_intake ~ "Abx, Low Sweets",
      empirical & fg_sweets > median_sweets_intake ~ "Abx, High Sweets"
    )
  ) %>%
  # Filter out any potential NA groups if they exist
  filter(!is.na(exposure_group)) %>%
  # Add sample sizes to the labels for clarity on the plot.
  add_count(exposure_group, name = "n_samples") %>%
  # Convert to a factor to control the plotting order.
  mutate(exposure_group = factor(exposure_group, levels = rev(c(
    "No Abx, No Sweets", "No Abx, Low Sweets", "No Abx, High Sweets",
    "Abx, No Sweets", "Abx, Low Sweets", "Abx, High Sweets"
  ))))

# --- Plot Generation ---
g4_break_abx <- ggplot(plot_data, aes(x = exposure_group, y = log(simpson_reciprocal))) +
  geom_quasirandom(alpha = points_alpha, width = 0.25) +
  geom_boxplot(width = 0.1, fill = "white", color = "red", linewidth = 1, outlier.shape = NA, alpha = 0.7) +
 
  coord_flip() +

  # Use a color palette suitable for categorical data and remove the legend.
   # Add the sample size labels
  geom_text(
    aes(label = paste("n =", n_samples), y = -0.5), # Adjust y-position as needed
    stat = "unique", size = 3.5
  ) +

  # Update the labels and title to reflect the new breakdown.
  labs(
    title = bquote("Unadjusted "~alpha*"-Diversity by Antibiotics and Sweets Intake"),
    subtitle = "Sweets consumption is stratified by the median intake of consumers",
    x = "Exposure Group\n(in 2 days prior to sample)",
    y = "Log(Inverse Simpson Diversity)"
  ) +
  theme_minimal()

```
```{r}
whisker_data <- plot_data %>%
  group_by(exposure_group) %>%
  summarise(
    q1 = quantile(log(simpson_reciprocal), 0.25, na.rm = TRUE),
    q3 = quantile(log(simpson_reciprocal), 0.75, na.rm = TRUE),
    iqr = q3 - q1,
    lower_whisker_bound = q1 - 1.5 * iqr,
    upper_whisker_bound = q3 + 1.5 * iqr,
    min_data = min(log(simpson_reciprocal), na.rm = TRUE),
    max_data = max(log(simpson_reciprocal), na.rm = TRUE),
    
    # The actual whisker end is the min/max data point within the 1.5*IQR range
    whisker_lower_end = lower_whisker_bound,
    whisker_upper_end = upper_whisker_bound,
    .groups = 'drop'
  )

# --- Plot Generation ---
ggplot(plot_data, aes(x = exposure_group, y = log(simpson_reciprocal), fill = exposure_group)) +

  # Original Violin plot

  # Original Boxplot with red, thick outlines
  geom_boxplot(width = 0.1, fill = "white", color = "red", linewidth = 1, outlier.shape = NA, alpha = 0.7) +

  # Jittered raw data points
  geom_jitter(width = 0.1, alpha = 0.3, shape = 16, height = 0) +

  # ADDING BLUE LINES FOR WHISKER ENDS
  geom_segment(data = whisker_data, 
               aes(x = exposure_group, xend = exposure_group, 
                   y = whisker_lower_end, yend = whisker_lower_end),
               color = "blue", linewidth = 1.5, linetype = "solid", 
               inherit.aes = FALSE) +
  # geom_segment(data = whisker_data, 
  #              aes(x = exposure_group, xend = exposure_group, 
  #                  y = whisker_upper_end, yend = whisker_upper_end),
  #              color = "blue", linewidth = 1.5, linetype = "solid", 
  #              inherit.aes = FALSE) +
  # You might want to add a very small horizontal line at the end to make it a cap
  geom_segment(data = whisker_data, 
               aes(x = as.numeric(exposure_group) - 0.1, xend = as.numeric(exposure_group) + 0.1, 
                   y = whisker_lower_end, yend = whisker_lower_end),
               color = "blue", linewidth = 1.5, inherit.aes = FALSE) +
  geom_segment(data = whisker_data, 
               aes(x = as.numeric(exposure_group) - 0.1, xend = as.numeric(exposure_group) + 0.1, 
                   y = whisker_upper_end, yend = whisker_upper_end),
               color = "blue", linewidth = 1.5, inherit.aes = FALSE) +


  coord_flip() +
  scale_fill_viridis_d(guide = "none", option = "magma", begin=0.1, end=0.9) +
  labs(
    title = bquote("Unadjusted "~alpha*"-Diversity by Antibiotics and Sweets Intake"),
    subtitle = paste0("Sweets consumption is stratified by the median intake of consumers (median=", 
                      round(median_sweets_intake, 2), "g)"),
    x = "",
    y = "Log(Inverse Simpson Diversity)"
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 18),
    plot.subtitle = element_text(color = "gray40"),
    axis.title = element_text(size = 14)
  )
```


# break down TPN and sweets, need to exclude the EN exposed samples since that is considered to be sweets 

```{r}
plot_tpn <- meta %>% 
  filter(!EN) %>% 
  select(pid, sampleid, TPN, fg_sweets, simpson_reciprocal) %>%
  mutate(
    # Define sweets exposure as consuming any amount > 0.
    sweets_exposure = fg_sweets > 0,
    # Use case_when for clear, readable logic to create the four groups.
    exposure_group = case_when(
      !TPN & !sweets_exposure ~ "No TPN, No Sweets",
      !TPN &  sweets_exposure ~ "No TPN, Sweets",
       TPN & !sweets_exposure ~ "TPN, No Sweets",
       TPN &  sweets_exposure ~ "TPN, Sweets"
    )
  ) %>%
  # Add a count of samples for each group.
  add_count(exposure_group, name = "n_samples") %>%
  # Create a new label that includes the group name and sample size.
  mutate(group_label = paste0(exposure_group, " (n=", n_samples, ")")) %>%
  # Convert the new label to a factor to control the plotting order.
  # The order is reversed because coord_flip() plots from bottom to top.
  mutate(group_label = factor(group_label, levels = rev(c(
    "No TPN, No Sweets", "No TPN, Sweets",
    "TPN, No Sweets", "TPN, Sweets"
  ))))

# --- Plot Generation ---
tpn_break <- ggplot(plot_tpn, aes(x = exposure_group, y = log(simpson_reciprocal))) +
  geom_quasirandom(alpha = points_alpha, width = 0.25) +
  geom_boxplot(width = 0.15, fill = "white", color = "red", linewidth = 1, outlier.shape = NA, alpha = 0.7) +
  
  # Add the sample size labels
  geom_text(
    aes(label = paste("n =", n_samples), y = -0.5), # Adjust y-position as needed
    stat = "unique", size = 3.5
  ) +
  coord_flip() +

  # Add clear, descriptive labels.
  labs(
    title = bquote("Unadjusted "~alpha*"-Diversity by Total Parenteral Nutrition and Sweets"),
    x = "Exposure Group\n(in 2 days prior to sample)",
    y = "log(Inverse Simpson Diversity)"
  ) +

  theme_minimal() +
  theme(axis.text.x = element_text( hjust = 1)) # Angle labels if they overlap
tpn_break
```

# assemble 

```{r}
final_plot <- plot_grid(intensity_break, g4_break_abx , tpn_break,
                ncol  = 1,
                rel_heights = c(1,1.7, 1),
                labels ='auto',
                align = 'vh', axis = 'lrtb')


title <- ggdraw() + 
  draw_label("Rebuttal Fig X",fontface = 'bold', x = 0,hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 0))

combined <- plot_grid(
  title, final_plot,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.05, 1)
) +theme(plot.margin = unit(c(1,1,1,1), "cm"))

ggsave('../data/R44_breakdown_beeswarm.pdf',
      width = 8.5, height = 11, units = "in", device = 'pdf', 
      dpi = 300)       
```