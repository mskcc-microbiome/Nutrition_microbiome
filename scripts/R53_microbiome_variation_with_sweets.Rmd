---
title: correlating patients baseline microbiome variation with their sweets intake
  long term average
output: html_document
date: "2025-11-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggpubr)
library(cowplot)
library(scales)
library(viridis)
```

Extended Fig. E5 shows patient-specific deviations (random intercepts, $(1 | pid)$). These are meant to capture the "baseline" diversity of a patient after your model has already mathematically subtracted the effects of antibiotics, diet (including sweets), and conditioning intensity. If I color-code E5 by average sweet intake and see a clear gradient (e.g., all the "low deviation" patients are high-sweet eaters), it means your model didn't fully capture the sweets effect in the fixed terms. There is "leftover" sweet-related variance "leaking" into the random effects.

```{r}
dtb <- read_csv('../data/152_combined_DTB.csv')
```
```{r}
df <- dtb %>%
  mutate(Food_code = as.character(Food_code))

# Calculate the average daily sweets intake for each patient
patient_avg_sweets <- df %>%
  # Group by patient to perform calculations for each one
  group_by(pid) %>%
  summarise(
    total_sweets_grams = sum(
      dehydrated_weight[str_starts(Food_code, "9")], 
      na.rm = TRUE
    ),

    total_eating_days = n_distinct(fdrt, na.rm = TRUE)
    
  ) %>%

  mutate(
    avg_daily_sweets = total_sweets_grams / (total_eating_days )
  )

# View the result
print(patient_avg_sweets)
```

```{r}
# --- 3. Process Patient-Specific Intercepts ---
posterior_draws_df <- read_csv('../data/171_div_model_fg_post_interaction.csv')

# This code takes your wide-format posterior draws and calculates the median for each patient
intercept_medians <- posterior_draws_df %>%
  # Pivot all patient-level intercept columns into a long format
  pivot_longer(
    cols = starts_with("r_pid"),
    names_to = "parameter",
    values_to = "draw"
  ) %>%
  # Extract the patient ID (e.g., "P11") from the complex parameter name
  mutate(
    # This regex looks for text between "r_pid[" and the first comma
    pid = str_extract(parameter, "(?<=r_pid\\[)[^,]+")
  ) %>%
  # Filter out any rows that didn't match (e.g., other model parameters)
  filter(!is.na(pid)) %>%
  # Now, calculate the median of all draws for each patient
  group_by(pid) %>%
  summarise(median_intercept = median(draw, na.rm = TRUE),
    lower_ci = quantile(draw, 0.025, na.rm = TRUE),
    upper_ci = quantile(draw, 0.975, na.rm = TRUE))
```
# correlation plot

```{r}
# --- 4. Join, Correlate, and Plot ---

# Join the two dataframes by patient ID
combined_data <- inner_join(patient_avg_sweets, intercept_medians, by = "pid") %>%
  # --- NEW: Add log2 transformed column for plot coloring ---
  # We add 1 as a pseudocount to handle log2(0)
  mutate(log2_avg_daily_sweets = log2(avg_daily_sweets + 1))

# --- 4a. Run Correlation Test ---
# We use Spearman for a robust, non-parametric correlation
correlation_test <- cor.test(
  combined_data$avg_daily_sweets, 
  combined_data$median_intercept, 
  method = "spearman"
)

# Print the test results (rho and p-value) to the console
print("--- Correlation Test Results ---")
print(correlation_test)


# --- 4b. Create annotation label ---
# Extract rho and p-value
rho <- correlation_test$estimate
p_val <- correlation_test$p.value

# Create a formatted string for the p-value manually
# This avoids the error from scales::pvalue()
if (p_val < 0.001) {
  p_string <- "p < 0.001"
} else {
  # Format to 3 decimal places
  p_string <- sprintf("p = %.2f", p_val) 
}

# Create a formatted string for the plot
annotation_string <- paste(
  sprintf("Spearman's rho = %.2f", rho),
  p_string, # Use our new manually formatted p-value string
  sep = "\n" # Put rho and p-value on separate lines
)


# --- 4c. Generate Scatterplot ---
correlation_plot <- ggplot(combined_data, aes(x = avg_daily_sweets, y = median_intercept)) +
  geom_point(alpha = 0.7, size = 2) +
  # Add a linear regression line to visualize the trend
  geom_smooth(method = "lm", se = T, color = "blue") +
  
  # --- NEW: Add the annotation text to the plot ---
  # This places the text in the top-right corner
  annotate(
    "text",
    x = Inf,  # Inf means the far-right of the plot
    y = Inf,  # Inf means the far-top of the plot
    label = annotation_string, 
    hjust = 1.1,  # Nudge text left (so it's not off-screen)
    vjust = 1.1,  # Nudge text down (so it's not off-screen)
    size = 4,
    color = "black"
  ) +
  
  labs(
    title = "\nCorrelation: Average Daily Sweets Intake vs. Patient-Specific Diversity Deviation",
    x = "Average Daily Sweets Intake (g / day)",
    y = "Median Patient-Specific Intercept (from Fig. E5)"
  ) +
  theme_minimal() 

# Print the plot
print(correlation_plot)
```

# forest plot

```{r}
# also color the forest plot lines and median points based on the Average Daily Sweets Intake
# --- 5. NEW: Generate Color-Coded Forest Plot ---

print("--- Generating Color-Coded Forest Plot ---")

forest_plot <- ggplot(combined_data, 
       # Aesthetics:
       aes(
         # x-axis is the intercept value
         x = median_intercept, 
         
         # y-axis is the patient ID, reordered by their median intercept
         y = reorder(pid, median_intercept), 
         
         # Define the CI bounds
         xmin = lower_ci, 
         xmax = upper_ci,
         
         # Color everything by the average daily sweets
         color = log2_avg_daily_sweets 
       )) +
  
  # Add the horizontal lines for the 95% CI
  geom_errorbarh(height = 0.5, size = 0.8) + 
  
  # Add the point for the median
  geom_point(size = 1) +
  
  # Add the vertical line at 0.0
  geom_vline(xintercept = 0, linetype = "dashed", color = "blue", alpha = 0.7) +
  
  scale_color_viridis_c(
    option = "turbo", # "viridis" (default), "magma", "plasma", "inferno"
    name = "log2(Avg. Daily \nSweets (g) + 1)" # Legend title
  ) +
  
  labs(
    title = "Patient-Specific Diversity Deviations (Ranked)",
    subtitle = "Color-coded by average daily sweet intake",
    x = "Patient-Specific Deviation from Average log(Diversity)",
    y = "Patient (Sorted by Median Deviation)"
  ) +
  
  # A minimal theme to look clean
  theme_minimal() +
  
  # Hide the patient labels on the y-axis (too many to read)
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )



# the final version after lab meeting discussion and so many other discussions
final_plot <- plot_grid( correlation_plot , 
                         forest_plot ,
                ncol  = 1,
                rel_heights = c(.5,2),
                labels = 'auto',
                align = 'vh', axis = 'lr')

title <- ggdraw() + 
  draw_label("Rebuttal Fig X",fontface = 'bold', x = 0,hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 0))


combined <- plot_grid(
  title, final_plot,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
) +theme(plot.margin = unit(c(1,1,1,1), "cm"))

ggsave('../data/R53_randomintercept_and_sweets.pdf',
      width = 8.5, height = 19, units = "in", device = 'pdf', 
      dpi = 300)  
```

