---
title: "baseline sugar degradation"
output: html_document
date: "2025-09-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(vegan)
library(ggpubr)
library(cowplot)
```

```{r}
metadata_df <- read_csv('../data/153_combined_META.csv') %>% 
  select(pid, sampleid, sdrt) %>% 
  left_join(read_rds('../data/R02_cleaned_clinical_outcome.rds') %>% select(pid, modal_diet) %>%
  mutate(modal_diet = as.character(modal_diet),
         modal_diet = if_else(modal_diet == 'High intake', 'Higher-intake', 'Lower-intake/sugar-enriched'),
         modal_diet = factor(modal_diet, levels = c( 'Lower-intake/sugar-enriched', 'Higher-intake'))))

abundance_table <- read_csv('../data/R25_asv_counts.csv')
```
# beta diversity comparison

```{r}
# 1. Find the earliest (baseline) sample for each patient
baseline_metadata <- metadata_df %>%
  filter(sdrt <= 0) %>% # Keep only samples on or before transplant day
  group_by(pid) %>%
  slice_min(order_by = sdrt, n = 1) %>%
  ungroup()

# Tally and print the number of patients per cluster in the baseline analysis
patient_tally <- baseline_metadata %>%
  count(modal_diet)

print("Number of patients per modal_diet in the baseline analysis:")
print(patient_tally)
```


```{r}
# 2. Filter the abundance table to only include these baseline samples
baseline_abundance <- abundance_table %>%
  filter(sampleid %in% baseline_metadata$sampleid) %>% 
  select(- count) %>% 
  spread('asv_key','count_relative', fill = 0)

# 3. Filter low-prevalence ASVs from the abundance table
# This step removes noise and improves statistical power.
# First, separate the sample IDs from the abundance data.
sample_ids <- baseline_abundance$sampleid
asv_matrix <- baseline_abundance %>% select(-sampleid)

# Calculate the prevalence of each ASV (the proportion of samples it appears in)
prevalence <- colSums(asv_matrix > 0) / nrow(asv_matrix)

# Keep only ASVs that are present in at least 10% of the samples
asv_matrix_filtered <- asv_matrix[, prevalence >= 0.10]

# 4. Calculate the Bray-Curtis distance matrix
#    Make sure the order of rows in abundance matches metadata for the test.
#    It's good practice to arrange both by sampleid to be certain.
baseline_metadata <- baseline_metadata %>% 
  arrange(sampleid) %>%
  filter(sampleid %in% sample_ids) # Ensure metadata matches the filtered abundance samples

# The asv_matrix_filtered is already in the correct order from the steps above
bray_dist <- vegdist(asv_matrix_filtered, method = "bray")

# 5. Run the PERMANOVA test
#    This tests if the 'modal_diet' grouping explains the distances between samples
permanova_result <- adonis2(bray_dist ~ modal_diet, data = baseline_metadata, permutations = 999)
  
# 6. Look at the results
print(permanova_result)

```
```{r}
# 7. Perform Principal Coordinate Analysis (PCoA) for visualization
pcoa <- cmdscale(bray_dist, k = 2, eig = TRUE)
pcoa_points <- as.data.frame(pcoa$points)
colnames(pcoa_points) <- c("PCoA1", "PCoA2")

# Combine PCoA coordinates with metadata for plotting
plot_data <- bind_cols(baseline_metadata, pcoa_points)

# Extract R-squared and p-value from PERMANOVA results for annotation
r2_value <- permanova_result$R2[1]
p_value <- permanova_result$`Pr(>F)`[1]
plot_annotation <- paste0("PERMANOVA\nRÂ² = ", round(r2_value, 3), "\np = ", p_value)

# 8. Create and display the PCoA plot
pcoa_plot <- ggplot(plot_data, aes(x = PCoA1, y = PCoA2, color = modal_diet)) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  labs(
    title = "Baseline Microbiome Composition by Dietary Cluster",
    x = paste0("PCoA1 (", round(100 * pcoa$eig[1] / sum(pcoa$eig), 1), "%)"),
    y = paste0("PCoA2 (", round(100 * pcoa$eig[2] / sum(pcoa$eig), 1), "%)"),
    color = "Dietary Cluster"
  ) +
  scale_color_manual(values = c( "darkslateblue",  "darkgoldenrod2"), name = '') +
  annotate(
    "text", 
    x = min(plot_data$PCoA1), 
    y = max(plot_data$PCoA2), 
    label = plot_annotation, 
    hjust = 0, 
    vjust = 1, 
    size = 3,
    fontface = "bold", color = 'red'
  ) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "bottom") + coord_fixed()

print(pcoa_plot)

```
# key simple sugar fermenters relab comparison

```{r}
# find the genus relab of those key genus in the baseline samples
asv_taxonomy_table <- read_csv('../data/171_quality_asv_relab_pident97_genus.csv')
```
```{r}
# ---  Compare abundance of key genera ---

# 9. Define key genera and prepare data
key_genera <- c("Bifidobacterium", "Lactobacillus", "Faecalibacterium", "Roseburia", "Ruminococcus")

# Use the long-format ASV table and filter for baseline samples and key genera
# Then, group by sample and genus to sum abundances, in case a genus is represented by multiple ASVs
genus_abundance <- asv_taxonomy_table %>%
  filter(sampleid %in% baseline_metadata$sampleid) %>%
  filter(genus %in% key_genera) %>%
  group_by(sampleid, genus) %>%
  summarise(relative_abundance = sum(count_relative), .groups = 'drop')

# Join with metadata to get cluster information
genus_plot_data <- genus_abundance %>%
  left_join(baseline_metadata, by = 'sampleid')

# Calculate the pseudo-abundance (half of the smallest non-zero relative abundance)
# This is crucial for log transformation when zeros are present.
pseudo_abundance <- min(genus_plot_data$relative_abundance[genus_plot_data$relative_abundance > 0]) / 2

# Add the log10 transformed abundance column
genus_plot_data <- genus_plot_data %>%
  mutate(log10_relab = log10(relative_abundance + pseudo_abundance))


# 10. Create and display the faceted boxplot using log10 transformed data
genus_boxplot <- ggplot(genus_plot_data, aes(x = modal_diet, y = log10_relab, fill = modal_diet)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.6) +
  facet_wrap(~genus, scales = "free_y") +
  theme_bw() +
  labs(
    title = "Relative Abundance of Key Genera at Baseline",
    x = "",
    y = "Log10(Relative Abundance)"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_blank(),
    legend.position = "none" # Hide legend as colors are clear from x-axis
  ) +
  scale_fill_manual(values = c( "darkslateblue",  "darkgoldenrod2"), name = '') +
  stat_compare_means(method = "wilcox.test", label = "p.format", label.y.npc = 0.9, label.x.npc = 0.4)

print(genus_boxplot)
```
# assemble 

```{r}
final_plot <-  plot_grid(pcoa_plot,
                        genus_boxplot,
                         rel_heights = c(1.5,1.5),
                 label_size = 12, ncol  = 1,
                labels = "auto", 
                align = 'vh', axis = 'lrtb')

title <- ggdraw() + 
  draw_label("Rebuttal Fig X",fontface = 'bold',x = 0,hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 0))

combined <- plot_grid(
  title, final_plot,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
) +theme(plot.margin = unit(c(1,1,1,1), "cm"))

ggsave('../data/R39_patients_baseline_sugar_degradation.pdf',
      width = 8.5, height = 11, units = "in", device = 'pdf', 
      dpi = 300)  
```


