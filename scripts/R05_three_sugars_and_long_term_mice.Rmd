---
title: "The fructose data"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggpubr)
library(readxl)
library(janitor)
library(scales)
```

# the new mice data: three different kinds of sugars 

The tube weight need to be adjusted.    

```{r}
three <- read_excel('/Volumes/peledlab/Projects/2024_Angel Rebuttal Exp /Healthy mice Biapenem_Diet_Exp/Angel Rebuttal_Exp2_Healthy mice Diet_Fructose_Sucrose_Glucose_v2.xlsx') %>% 
  mutate(CFUs_per_GramStool = (((((Colonies_counted*(100/Plated_volume_ul))/100)/(10^Dilution_factor) )*1000)/Stool_weight_mg)+1)  %>% 
  clean_names() %>% 
  separate(treatment, into = c('abx_treatment', 'diet_treatment'), sep = '\\+', remove = T) %>% 
  mutate(diet_treatment = if_else(diet_treatment == 'F','fructose',if_else(diet_treatment == 'G','glucose', if_else(diet_treatment == 'PH','vehicle', 'sucrose'))),
         abx_treatment = if_else(abx_treatment == 'B','biapenem','DPBS'),
         #diet_treatment = factor(diet_treatment, levels = c('vehicle','sucrose', 'fructose', 'glucose')),
         abx_treatment = factor(abx_treatment, levels = c('DPBS','biapenem'))) 
  
  
three %>% count(abx_treatment, diet_treatment) 

plotdf <- three %>% 
  mutate(day = factor(day)) %>% 
  arrange(abx_treatment,diet_treatment,  day) %>% 
  mutate(xvar = str_glue('{abx_treatment}__{diet_treatment}__{day}')) %>% 
  mutate(grp = str_glue('{abx_treatment}__{diet_treatment}')) %>% 
  mutate(grp = factor(grp, levels = c('DPBS__vehicle','DPBS__sucrose','DPBS__glucose','DPBS__fructose','biapenem__vehicle','biapenem__sucrose','biapenem__glucose','biapenem__fructose')))

plotdf %>% count(xvar)
```

```{r}
g3_days <- plotdf %>%    
  ggboxplot(x = 'xvar', y = 'cf_us_per_gram_stool',add = 'jitter', 
             xlab = '', ylab = 'Enterococcal\n CFU/gram',, add.params = list(alpha = 0.5, shape = 16),
            width = 0.6,color  = 'grp')+
   scale_color_manual(values = c('gray76','#ffbcdc','gold','forestgreen','gray32','deeppink2','yellow','green')) +
  #stat_compare_means(comparisons = list(c('biapenem__vehicle__3','biapenem__sucrose__3'), c('biapenem__vehicle__6','biapenem__sucrose__6')),label= "p.signif", method= 'wilcox.test',tip.length = 0.04,exact=T,correct=T) +
  scale_y_log10(breaks = c(1 %o% 10^(-1:12)),  labels = trans_format("log10", math_format(10^.x))) +
  #scale_x_discrete(labels=rep(c(0,3,6),4)) + 
  theme(axis.text =  element_text(size = 10),axis.title=element_text(size=10),legend.position = 'none',aspect.ratio=1/1.3,
        axis.text.x = element_text(angle = 90))

g3_days
ggsave('../data/197_three_cfu.pdf', width = 9)
```
```{r}
# plot 1 : the f3 setting but extend to day 9,14,21
f3_five <- three %>% 
  mutate(day = factor(day)) %>% 
  arrange(abx_treatment,desc(diet_treatment),  day) %>% 
  mutate(xvar = str_glue('{abx_treatment}__{diet_treatment}__{day}')) %>% 
  mutate(grp = str_glue('{abx_treatment}__{diet_treatment}')) %>% 
  filter(diet_treatment != 'fructose' & diet_treatment != 'glucose' ) %>% 
  mutate(grp = factor(grp, levels = c('DPBS__vehicle','DPBS__sucrose','biapenem__vehicle','biapenem__sucrose'))) 

f3_five_days <- f3_five %>%    
  ggboxplot(x = 'xvar', y = 'cf_us_per_gram_stool',add = 'jitter', 
             xlab = '', ylab = 'Enterococcal\n CFU/gram',, add.params = list(alpha = 0.5, shape = 16),
            width = 0.6,color  = 'grp')+
   scale_color_manual(values = c('gray76','#ffbcdc','gray32','deeppink2')) +
  stat_compare_means(comparisons = list(
    c('biapenem__vehicle__3','biapenem__sucrose__3'), 
    c('biapenem__vehicle__6','biapenem__sucrose__6'),
    c('biapenem__vehicle__9','biapenem__sucrose__9'),
  c('biapenem__vehicle__14','biapenem__sucrose__14'),
  c('biapenem__vehicle__21','biapenem__sucrose__21')),
    label= "p.signif", method= 'wilcox.test',tip.length = 0.04,exact=T,correct=T) +
  scale_y_log10(breaks = c(1 %o% 10^(-1:12)),  labels = trans_format("log10", math_format(10^.x))) +
  #scale_x_discrete(labels=rep(c(0,3,6,9,14,21),4)) + 
  theme(axis.text =  element_text(size = 10),axis.title=element_text(size=10),legend.position = 'none',aspect.ratio=1/1.3,
        axis.text.x = element_text(angle = 90))
f3_five_days
f3_five %>% count(xvar)
```
```{r}
# plot 2: three total sugars but only day 0,3,6
f3_sugars <- three %>% 
  arrange(abx_treatment,desc(diet_treatment),  day) %>% 
  mutate(xvar = str_glue('{abx_treatment}__{diet_treatment}__{day}')) %>% 
  mutate(grp = str_glue('{abx_treatment}__{diet_treatment}')) %>% 
  filter(!day %in% c(9,14,21) ) %>% 
  mutate(grp = factor(grp, levels = c('DPBS__vehicle','DPBS__sucrose','DPBS__glucose','DPBS__fructose','biapenem__vehicle','biapenem__sucrose','biapenem__glucose','biapenem__fructose'))) 

f3_sugars %>% count(grp)


f3_sugars_days <- f3_sugars %>%    
  ggboxplot(x = 'xvar', y = 'cf_us_per_gram_stool',add = 'jitter', 
             xlab = '', ylab = 'Enterococcal\n CFU/gram',, add.params = list(alpha = 0.5, shape = 16),
            width = 0.6,color  = 'grp')+
   scale_color_manual(values = c('gray76','#ffbcdc','gold','forestgreen','gray32','deeppink2','yellow','green')) +
  stat_compare_means(comparisons = list(
    c('biapenem__vehicle__3','biapenem__sucrose__3'), 
    c('biapenem__vehicle__6','biapenem__sucrose__6'),
    c('biapenem__vehicle__3','biapenem__glucose__3'), 
    c('biapenem__vehicle__6','biapenem__glucose__6'),
    c('biapenem__vehicle__3','biapenem__fructose__3'), 
    c('biapenem__vehicle__6','biapenem__fructose__6')
    
    ),
    label= "p.signif", method= 'wilcox.test',tip.length = 0.04,exact=T,correct=T) +
  scale_y_log10(breaks = c(1 %o% 10^(-1:12)),  labels = trans_format("log10", math_format(10^.x))) +
  #scale_x_discrete(labels=rep(c(0,3,6),8)) + 
  theme(axis.text =  element_text(size = 10),axis.title=element_text(size=10),legend.position = 'none',aspect.ratio=1/1.3,
        axis.text.x = element_text(angle = 90))

f3_sugars_days
```

```{r}
# the median fold change and the p value for the star in the above figure on day 3
deltas <- f3_sugars %>%
  mutate(grp = str_glue('{abx_treatment}_{diet_treatment}')) %>% 
  select(grp, day, mouse_identifier, cf_us_per_gram_stool) %>% 
  spread('day','cf_us_per_gram_stool') %>%
  rename(d0 = `0`, d3 = `3`,d6 = `6`) %>%
  # remove any rows that has NA in D3
  filter(!is.na(d3))

# the fold change on day 3
day3fc <- deltas %>% 
  filter(str_detect(grp, 'biapenem')) %>% 
  select(grp, mouse_identifier, d3) %>% 
  spread('grp','d3') %>% 
  filter(!is.na(biapenem_vehicle)) %>% 
  mutate(fc_fructose = round(biapenem_fructose/biapenem_vehicle, 2),
         fc_glucose = round(biapenem_glucose/biapenem_vehicle, 2)) 
```


```{r fc_fructose}
median(day3fc$fc_fructose)

res_fructose <- wilcox.test(d3 ~ grp, data = deltas %>% 
  filter(grp %in% c('biapenem_fructose','biapenem_vehicle')) %>% 
  select(grp, mouse_identifier, d3),
                   exact = FALSE)
res_fructose
```

```{r fc_glucose}
median(day3fc$fc_glucose, na.rm = T)

res_glucose <- wilcox.test(d3 ~ grp, data = deltas %>% 
  filter(grp %in% c('biapenem_glucose','biapenem_vehicle')) %>% 
  select(grp, mouse_identifier, d3),
                   exact = FALSE)
res_glucose
```

