---
title: "New clinical: IR with CD4"
output: html_document
date: "2025-07-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(broom)
```

# clean data from Oriana's data of CD4 count

```{r}
link <- read_csv('../../MSS_pipeline-/scripts/food_tree/data/152_pid_match.csv')
ptb <- read_csv('../../MSS_pipeline-/scripts/food_tree/data/156_combined_PTB.csv')
meta <- read_csv('../data/153_combined_META.csv')
```

What Oriana's dataline pull has :
- CD3-56+16+ Absolute: This counts your Natural Killer (NK) cells. These are cells that lack the T-cell marker (CD3-) but have the classic NK cell markers (CD56+ and CD16+). NK cells are part of your innate immune system, acting as rapid first-responders to kill infected or cancerous cells.
- CD3-19+ B Cells Absolute: This is the count of your B Cells. They are identified by being negative for the T-cell marker (CD3-) but positive for the B-cell marker (CD19+). B cells are famous for producing antibodies.
- CD3+4-8+ CD8+ T Cells Absolute: This is your count of Cytotoxic T Cells (also called CD8+ T cells). They are a type of T cell (CD3+) that has the CD8 marker but lacks the CD4 marker. Their job is to directly find and kill infected or cancerous cells. Think of them as the immune system's special forces.
- CD3+4+8- CD4+ T Cells Absolute: This measures your Helper T Cells (also called CD4+ T cells). They are T cells (CD3+) that have the CD4 marker but lack CD8. These cells are the "generals" of the immune army; they coordinate the entire immune response.

```{r}
# below is all the counts from the pt that I have also included stool samples in this cohort 
dat <- readxl::read_excel('/Volumes/vandenBrinkLab/Oriana/IR/data_pull/MED30338 DataLine Results.xlsx', sheet = 2) %>% 
  mutate(mrn = as.numeric(MRN)) %>% 
  inner_join(link) %>% 
  filter(pid %in% meta$pid) %>% 
  left_join(ptb %>% mutate(source_and_gvhdppx = str_glue('{source}+{gvhd_ppx}')) %>%  select(mrn, hct, source_and_gvhdppx, day_exposed)) %>% 
  mutate(test_date = ymd(LR_PERFORMED_DTE),
         test_day = as.numeric(test_date - hct),
         source_and_gvhdppx = factor(source_and_gvhdppx ),
        LR_RESULT_VALUE = as.numeric(LR_RESULT_VALUE) ) %>% 
  select(mrn, pid,  hct, test_day, LCI_SUBTEST_NAME, LR_RESULT_VALUE, source_and_gvhdppx, day_exposed) %>% 
  janitor::clean_names()

dat
```

# CD4

peri-engraftment diversity and the day 100/day 180 CD4 using +/- 30 days as the window  

```{r}
#Day 100: Look for a measurement between Day +70 and Day +130.
#Day 180: Look for a measurement between Day +150 and Day +210." 
#and For any patient who has multiple CD4 measurements within your chosen window, you should select the one that is closest in time to the landmark day (i.e., closest to Day 100 or Day 180).
cd4_day100 <- dat %>%
  # Keep only the CD4 lab results
  filter(lci_subtest_name == 'CD3+4+8- CD4+ T Cells Absolute') %>%
  # Filter for rows within the Day 100 window 
  filter(test_day >= 70 & test_day <= 130) %>%
  # For each patient, calculate the time difference to the landmark day
  mutate(time_diff = abs(test_day - 100)) %>%
  # Group by patient ID to select the best measurement for each one
  group_by(pid, source_and_gvhdppx) %>%
  # Keep only the row with the minimum time difference
  # with_ties = FALSE ensures we only get one row if there's a tie
  slice_min(order_by = time_diff, n = 1, with_ties = FALSE) %>%
  # Ungroup to finish the operation
  ungroup() %>%
  # Add a column to identify which landmark this data belongs to
  mutate(landmark = "Day_100") %>%
  # Rename columns for clarity
  rename(cd4_value = lr_result_value, cd4_day = test_day) %>%
  select(pid, landmark, cd4_day, cd4_value, time_diff, source_and_gvhdppx, day_exposed) %>% 
  filter(!is.na(cd4_value))

# --- Step 3: Extract CD4 Count for Day 180 Landmark ---

cd4_day180 <- dat %>%
  # Keep only the CD4 lab results
  filter(lci_subtest_name == 'CD3+4+8- CD4+ T Cells Absolute') %>%
  # Filter for rows within the Day 180 window 
  filter(test_day >= 150 & test_day <= 210) %>%
  # For each patient, calculate the time difference to the landmark day
  mutate(time_diff = abs(test_day - 180)) %>%
  # Group by patient ID to select the best measurement for each one
  group_by(pid, source_and_gvhdppx) %>%
  # Keep only the row with the minimum time difference
  # with_ties = FALSE ensures we only get one row if there's a tie
  slice_min(order_by = time_diff, n = 1, with_ties = FALSE) %>%
  # Ungroup to finish the operation
  ungroup() %>%
  # Add a column to identify which landmark this data belongs to
  mutate(landmark = "Day_180") %>%
  # Rename columns for clarity
  rename(cd4_value = lr_result_value, cd4_day = test_day) %>%
  select(pid, landmark, cd4_day, cd4_value, time_diff, source_and_gvhdppx, day_exposed)%>% 
  filter(!is.na(cd4_value))


# --- Step 4: Combine and View the Results ---

# Combine the results from both landmarks into a single, clean table
final_landmark_cd4 <- bind_rows(cd4_day100, cd4_day180) %>%
  arrange(pid, landmark)

# Print the final table
print(final_landmark_cd4)

```

```{r}
stool_df_with_window <- meta %>%
  select(sampleid, sdrt, simpson_reciprocal, pid,intensity, empirical ) %>% 
  mutate(intensity = factor(intensity))

peri_engraftment_diversity <- stool_df_with_window %>%
  # Filter for rows within the peri-engraftment window
  filter(sdrt >= 7 & sdrt <= 21) %>%
  
  # Group by patient ID to calculate the average for each one
  group_by(pid, intensity) %>%
  
  # Calculate the mean of the diversity metric for all samples in the window
  # na.rm = TRUE will handle any missing diversity values gracefully
  summarise(
    peri_engraftment_diversity = median(simpson_reciprocal, na.rm = TRUE),
    # It's also useful to know how many samples were averaged
    n_samples_in_window = n()
  ) %>%
  
  # Ungroup to finish the operation
  ungroup() 

d100_df <- peri_engraftment_diversity %>% 
  inner_join(cd4_day100)

d180_df <- peri_engraftment_diversity %>% 
  inner_join(cd4_day180)
```

## raw data viz

```{r}
# Combine the two data frames into one for easier plotting.
# The 'landmark' column will be used to distinguish the time points.
combined_df <- bind_rows(d100_df, d180_df) %>%
  # Make 'landmark' a factor with specified levels to ensure Day 100 is on the left.
  mutate(landmark = factor(landmark, levels = c("Day_100", "Day_180")))


# --- Step 3: Create the Faceted Plot ---
ggplot(combined_df, aes(x = peri_engraftment_diversity, y = log1p(cd4_value))) +
  # Add the points for the scatter plot.
  geom_point(alpha = 0.8, color = "black") +
  
  # Add the linear regression line to each facet. The 'se = FALSE' hides the confidence interval ribbon.
  geom_smooth(method = "lm", se = T, color = "blue", formula = y ~ x) +
  
  # This is where the magic happens for faceting.
  # It creates a grid of plots, separated by 'landmark' and 'source_and_gvhdppx'.
  facet_wrap(~ landmark + source_and_gvhdppx, ncol = 4) + 
  
  # Add clean, descriptive labels for the axes and title.
  labs(
    x = "Peri-engraftment Alpha Diversity",
    y = "log(Absolute CD4 Count)"
  ) +
  
  # Use a minimal, clean theme suitable for publication.
  theme_minimal() +
  theme(
    strip.text = element_text(size = 8, face = "bold"), # Make facet labels easier to read
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  )
```

## modeling 

```{r}
correlation_model <- lm(log1p(cd4_value) ~   source_and_gvhdppx  + peri_engraftment_diversity  , data = d100_df)

# Get a summary of the model to extract statistics
model_summary <- summary(correlation_model)
model_summary
```


```{r}
correlation_model <- lm(log1p(cd4_value) ~ peri_engraftment_diversity + source_and_gvhdppx , data = d180_df)

# Get a summary of the model to extract statistics
model_summary <- summary(correlation_model)

```


