---
title: "New clinical: IR with CD4"
output: html_document
date: "2025-07-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(broom)
library(cowplot)
library(patchwork)
library(ggh4x)
```

# clean data from Oriana's data of CD4 count

```{r}
link <- read_csv('../../MSS_pipeline-/scripts/food_tree/data/152_pid_match.csv')
ptb <- read_csv('../../MSS_pipeline-/scripts/food_tree/data/156_combined_PTB.csv')
meta <- read_csv('../data/153_combined_META.csv')
```

What Oriana's dataline pull has :
- CD3-56+16+ Absolute: This counts your Natural Killer (NK) cells. These are cells that lack the T-cell marker (CD3-) but have the classic NK cell markers (CD56+ and CD16+). NK cells are part of your innate immune system, acting as rapid first-responders to kill infected or cancerous cells.
- CD3-19+ B Cells Absolute: This is the count of your B Cells. They are identified by being negative for the T-cell marker (CD3-) but positive for the B-cell marker (CD19+). B cells are famous for producing antibodies.
- CD3+4-8+ CD8+ T Cells Absolute: This is your count of Cytotoxic T Cells (also called CD8+ T cells). They are a type of T cell (CD3+) that has the CD8 marker but lacks the CD4 marker. Their job is to directly find and kill infected or cancerous cells. Think of them as the immune system's special forces.
- CD3+4+8- CD4+ T Cells Absolute: This measures your Helper T Cells (also called CD4+ T cells). They are T cells (CD3+) that have the CD4 marker but lack CD8. These cells are the "generals" of the immune army; they coordinate the entire immune response.

```{r}
# below is all the counts from the pt that I have also included stool samples in this cohort 
dat <- readxl::read_excel('/Volumes/vandenBrinkLab/Oriana/IR/data_pull/MED30338 DataLine Results.xlsx', sheet = 2) %>%
  mutate(mrn = as.numeric(MRN)) %>%
  inner_join(link) %>%
  filter(pid %in% meta$pid) %>%
  left_join(ptb %>% mutate(source_and_gvhdppx = str_glue('{source}+{gvhd_ppx}')) %>%  select(mrn, hct, source_and_gvhdppx, day_exposed)) %>%
  mutate(test_date = ymd(LR_PERFORMED_DTE),
         test_day = as.numeric(test_date - hct),
         source_and_gvhdppx = factor(source_and_gvhdppx ),
        LR_RESULT_VALUE = as.numeric(LR_RESULT_VALUE) ) %>%
  select(mrn, pid,  hct, test_day, LCI_SUBTEST_NAME, LR_RESULT_VALUE, source_and_gvhdppx, day_exposed) %>%
  janitor::clean_names()

dat %>% write_rds('../data/R28_IR_data_cleaned.rds')
```

# CD4

peri-engraftment diversity and the day 100/day 180 CD4 using +/- 30 days as the window  

```{r}
dat <- read_rds('../data/R28_IR_data_cleaned.rds')
#Day 10read_rds()#Day 100: Look for a measurement between Day +70 and Day +130.
#Day 180: Look for a measurement between Day +150 and Day +210." 
#and For any patient who has multiple CD4 measurements within your chosen window, you should select the one that is closest in time to the landmark day (i.e., closest to Day 100 or Day 180).
cd4_day100 <- dat %>%
  # Keep only the CD4 lab results
  filter(lci_subtest_name == 'CD3+4+8- CD4+ T Cells Absolute') %>%
  # Filter for rows within the Day 100 window 
  filter(test_day >= 70 & test_day <= 130) %>%
  # For each patient, calculate the time difference to the landmark day
  mutate(time_diff = abs(test_day - 100)) %>%
  # Group by patient ID to select the best measurement for each one
  group_by(pid, source_and_gvhdppx) %>%
  # Keep only the row with the minimum time difference
  # with_ties = FALSE ensures we only get one row if there's a tie
  slice_min(order_by = time_diff, n = 1, with_ties = FALSE) %>%
  # Ungroup to finish the operation
  ungroup() %>%
  # Add a column to identify which landmark this data belongs to
  mutate(landmark = "Day_100") %>%
  # Rename columns for clarity
  rename(cd4_value = lr_result_value, cd4_day = test_day) %>%
  select(pid, landmark, cd4_day, cd4_value, time_diff, source_and_gvhdppx, day_exposed) %>% 
  filter(!is.na(cd4_value))

# --- Step 3: Extract CD4 Count for Day 180 Landmark ---

cd4_day180 <- dat %>%
  # Keep only the CD4 lab results
  filter(lci_subtest_name == 'CD3+4+8- CD4+ T Cells Absolute') %>%
  # Filter for rows within the Day 180 window 
  filter(test_day >= 150 & test_day <= 210) %>%
  # For each patient, calculate the time difference to the landmark day
  mutate(time_diff = abs(test_day - 180)) %>%
  # Group by patient ID to select the best measurement for each one
  group_by(pid, source_and_gvhdppx) %>%
  # Keep only the row with the minimum time difference
  # with_ties = FALSE ensures we only get one row if there's a tie
  slice_min(order_by = time_diff, n = 1, with_ties = FALSE) %>%
  # Ungroup to finish the operation
  ungroup() %>%
  # Add a column to identify which landmark this data belongs to
  mutate(landmark = "Day_180") %>%
  # Rename columns for clarity
  rename(cd4_value = lr_result_value, cd4_day = test_day) %>%
  select(pid, landmark, cd4_day, cd4_value, time_diff, source_and_gvhdppx, day_exposed)%>% 
  filter(!is.na(cd4_value))


# --- Step 4: Combine and View the Results ---

# Combine the results from both landmarks into a single, clean table
final_landmark_cd4 <- bind_rows(cd4_day100, cd4_day180) %>%
  arrange(pid, landmark)

# Print the final table
print(final_landmark_cd4)

```

```{r}
stool_df_with_window <- meta %>%
  select(sampleid, sdrt, simpson_reciprocal, pid,intensity, empirical ) %>% 
  mutate(intensity = factor(intensity))

peri_engraftment_diversity <- stool_df_with_window %>%
  # Filter for rows within the peri-engraftment window
  filter(sdrt >= 7 & sdrt <= 21) %>%
  
  # Group by patient ID to calculate the average for each one
  group_by(pid, intensity) %>%
  
  # Calculate the mean of the diversity metric for all samples in the window
  # na.rm = TRUE will handle any missing diversity values gracefully
  summarise(
    peri_engraftment_diversity = median(simpson_reciprocal, na.rm = TRUE),
    # It's also useful to know how many samples were averaged
    n_samples_in_window = n()
  ) %>%
  
  # Ungroup to finish the operation
  ungroup() 

d100_df <- peri_engraftment_diversity %>% 
  inner_join(cd4_day100)

d180_df <- peri_engraftment_diversity %>% 
  inner_join(cd4_day180)
```

## raw data viz

```{r}
# Combine the two data frames into one for easier plotting.
# The 'landmark' column will be used to distinguish the time points.
combined_df <- bind_rows(d100_df, d180_df) %>%
  # Make 'landmark' a factor with specified levels to ensure Day 100 is on the left.
  mutate(landmark = factor(landmark, levels = c("Day_100", "Day_180")))

# Group by the faceting variables and count the number of observations (n).
# Then, create a label string like "n = 15".
count_labels <- combined_df %>%
  group_by(landmark, source_and_gvhdppx) %>%
  summarise(n = n(), .groups = 'drop') %>% # Use .groups = 'drop' to avoid grouping issues later
  mutate(label = paste("n =", n))

# Define a color palette for the landmark days.
# Using ggplot's standard teal and red for contrast.
landmark_colors <- c(
  "Day_100" = "#F8766D", 
  "Day_180" = "#00BFC4"  
)

# Dynamically create the color vector for the facet strips.
# This repeats each landmark color for the number of prophylaxis groups.
strip_colors <- rep(landmark_colors, each = nlevels(combined_df$source_and_gvhdppx))

# --- Step 3: Create the Faceted Plot ---
scatter_plot <- ggplot(combined_df, aes(x = peri_engraftment_diversity, y = log1p(cd4_value))) +
  # Add the points for the scatter plot.
  geom_point(alpha = 0.8, color = "black") +
  
   # The regression line and confidence interval are also colored by landmark.
  # The fill aesthetic is used for the confidence ribbon's color.
  geom_smooth( method = "lm", se = TRUE, alpha = 0.15, formula = y ~ x) +
  
  # Add the count annotations using geom_text.
  # 'data = count_labels' tells this layer to use our pre-calculated counts.
  # x = Inf and y = Inf place the label in the top-right corner.
  # hjust and vjust are used to nudge the text so it's not cut off.
  geom_text(
    data = count_labels, 
    aes(label = label), 
    x = Inf, 
    y = Inf, 
    hjust = 1.1, 
    vjust = 1.5, 
    size = 3, 
    color = "black"
  ) +
  
  # Use ggh4x::facet_wrap2 to apply the custom colors to the facet strips.
  ggh4x::facet_wrap2(
    ~ landmark + source_and_gvhdppx,
    ncol = 4,
    strip = strip_themed(
      # Color the background of each strip using our dynamically created color vector.
      background_x = elem_list_rect(fill = strip_colors),
      # Use white text for better contrast against the colored backgrounds.
      text_x = elem_list_text(color = "white", face = "bold")
    )
  ) +
  
  # Apply the custom color palettes for both color (lines/points) and fill (ribbons).
  scale_color_manual(values = landmark_colors) +
  scale_fill_manual(values = landmark_colors) +
  
  # Add clean, descriptive labels for the axes and title.
  labs(
    x = "Peri-engraftment Alpha Diversity",
    y = "log(Absolute CD4 Count)"
  ) +
  
   scale_x_continuous(
    breaks = seq(0, 25, 9)
  ) +
  # Use a minimal, clean theme suitable for publication.
  theme_minimal() +
  theme(
    strip.text = element_text(size = 8, face = "bold"), # Make facet labels easier to read
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  )
scatter_plot
```

## modeling 

```{r}
model_d100 <- lm(log1p(cd4_value) ~ source_and_gvhdppx  + peri_engraftment_diversity  , data = d100_df)

model_d180 <- lm(log1p(cd4_value) ~ peri_engraftment_diversity + source_and_gvhdppx , data = d180_df)
```

```{r}
# ---  Tidy Model Outputs and Combine ---
# Use broom::tidy() to extract coefficients and 95% confidence intervals for each model.
# Then, add a 'landmark' column to identify which model the results came from.
tidy_d100 <- tidy(model_d100, conf.int = TRUE) %>%
  mutate(landmark = "Day 100")

tidy_d180 <- tidy(model_d180, conf.int = TRUE) %>%
  mutate(landmark = "Day 180")

# Combine the tidy results into a single data frame for plotting.
combined_models <- bind_rows(tidy_d100, tidy_d180) %>%
  # Filter out the intercept term as it's typically not shown in coefficient plots.
  filter(term != "(Intercept)") %>%
  # Clean up the predictor names for better plot labels.
  mutate(term = str_remove_all(term, "source_and_gvhdppx")) 

# --- Step 3: Create Individual Plots ---

# Plot for Day 100 (with Y-axis labels)
p1 <- combined_models %>%
  filter(landmark == "Day 100") %>%
  ggplot(aes(x = estimate, y = fct_rev(term))) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2, size = 1, color = "coral") +
  geom_point(size = 3, color = "coral") +
  labs(
    title = "Day 100",
    x = "Coefficient Estimate",
    y = "Predictor Variable"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.major.y = element_blank(),
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

# Plot for Day 180 (WITHOUT Y-axis labels)
p2 <- combined_models %>%
  filter(landmark == "Day 180") %>%
  ggplot(aes(x = estimate, y = fct_rev(term))) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2, size = 1, color = "turquoise3") +
  geom_point(size = 3, color = "turquoise3") +
  labs(
    title = "Day 180",
    x = "Coefficient Estimate",
    y = NULL # Remove the y-axis title
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = element_blank(), # Remove y-axis text/ticks
    panel.grid.major.y = element_blank(),
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

# --- Step 4: Combine Plots with Patchwork ---
# The '+' operator from patchwork places the plots side-by-side.
# plot_annotation adds a single, overarching title to the combined figure.
coeff_plot <- p1 + p2 

```

# assemble 

```{r}
final_plot <-  plot_grid(scatter_plot,
                        coeff_plot,
                         rel_heights = c(1.5,1.5),
                 label_size = 12, ncol  = 1,
                labels = "auto", 
                align = 'vh', axis = 'rtb')

title <- ggdraw() + 
  draw_label("Rebuttal Fig X",fontface = 'bold',x = 0,hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 0))

combined <- plot_grid(
  title, final_plot,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
) +theme(plot.margin = unit(c(1,1,1,1), "cm"))

ggsave('../data/R28_patients_IR_CD4_and_peri_diversity.pdf',
      width = 8.5, height = 11, units = "in", device = 'pdf', 
      dpi = 300)  
```
