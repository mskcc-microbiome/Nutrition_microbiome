---
title: "Transient or sustained" 
output: html_document
date: "2025-07-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggpubr) 
library(cowplot)
```

```{r}
g_relab <- read_csv('../data/022_ALL173_stool_samples_genus_counts.csv') %>% 
  spread('genus','relab', fill = 0) %>% 
  select(sampleid, Enterococcus_relab = Enterococcus)

enterococcus_abundance <- read_csv('../data/153_combined_META.csv') %>% 
  full_join(g_relab) %>% 
  mutate(Entero_log10 = log10(Enterococcus_relab + 1e-05)) %>% 
  select(pid, sdrt, sampleid,Enterococcus_relab, Entero_log10 )
```
# distribution of the data 

```{r}
library(patchwork) 

# ---  Calculate Summary Statistics Per Patient ---

# First, get the total number of samples for each patient.
total_samples_per_patient <- enterococcus_abundance %>%
  group_by(pid) %>%
  summarise(total_samples = n()) %>%
  ungroup()

# Next, calculate the number of bloom days at both thresholds.
bloom_days_per_patient <- enterococcus_abundance %>%
  # Create logical columns indicating if a sample is a bloom at each threshold
  mutate(
    is_bloom_10 = Enterococcus_relab > 0.10,
    is_bloom_30 = Enterococcus_relab > 0.30
  ) %>%
  # Group by patient to sum up the bloom days
  group_by(pid) %>%
  summarise(
    bloom_days_10 = sum(is_bloom_10, na.rm = TRUE),
    bloom_days_30 = sum(is_bloom_30, na.rm = TRUE)
  ) %>%
  ungroup()

# --- 3. Create the Plots ---

# Plot 1: Distribution of the total number of samples per patient
p1 <- ggplot(total_samples_per_patient, aes(x = total_samples)) +
  geom_histogram(binwidth = 1, fill = "skyblue", color = "black", alpha = 0.8) +
  scale_x_continuous(breaks = seq(0, 30, by = 5)) + # Adjust sequence as needed
  labs(
    title = "A) Distribution of Samples per Patient",
    x = "Total Number of Stool Samples Collected for each patient",
    y = "Number of Patients"
  ) +
  theme_minimal(base_size = 11) +
  theme(plot.title = element_text(face = "bold"))

# Plot 2: Distribution of the number of bloom days
# We need to pivot the data to a longer format to plot both thresholds together.
p2 <- bloom_days_per_patient %>%
  pivot_longer(
    cols = c(bloom_days_10, bloom_days_30),
    names_to = "threshold",
    values_to = "bloom_days"
  ) %>%
  mutate(
    threshold = factor(threshold,
                       levels = c("bloom_days_10", "bloom_days_30"),
                       labels = c("Bloom Definition: >10% Abundance", "Bloom Definition: >30% Abundance"))
  ) %>%
  ggplot(aes(x = bloom_days)) +
  # Use a single histogram geom, the faceting will split it.
  geom_histogram(binwidth = 1, fill = "#404080", color = "white", alpha = 0.9) +
  # Create separate panels for each threshold definition.
  facet_wrap(~ threshold, scales = "free_y") +
  labs(
    title = "B) Distribution of Enterococcus Bloom Days",
    x = "Number of Samples in Bloom State for each patient",
    y = "Number of Patients"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold"),
    strip.text = element_text(face = "bold") # Bolds the facet titles
  )
```


```{r}
#  Calculate Antibiotic Exposure Duration within Sampling Window ---
# calculate the days of exposure to any of the broad spectrum abx from the earlist day of the stool sample collection to the latest day of the stool sampling 
abx_exposure <- read_csv('../data/R32_meds_expanded_all_medication_classified_for_each_day.csv')

# First, determine the earliest and latest stool sample day for each patient.
# This defines the relevant time window for our analysis.
patient_sampling_window <- enterococcus_abundance %>%
  group_by(pid) %>%
  summarise(
    first_sample_day = min(sdrt, na.rm = TRUE),
    last_sample_day = max(sdrt, na.rm = TRUE)
  ) %>%
  ungroup()

# Now, calculate the number of broad-spectrum antibiotic days that fall
# within each patient's specific sampling window.
antibiotic_days_in_window <- abx_exposure %>%
  # Add the sampling window start/end dates to the antibiotic data
  left_join(patient_sampling_window, by = "pid") %>%
  # Only consider antibiotic exposures that happened during the sampling period
  filter(day >= first_sample_day & day <= last_sample_day) %>%
  # Filter for only the 'broad_spectrum' category
  filter(exposure_category == "broad_spectrum") %>%
  # Count the number of broad-spectrum days for each patient
  group_by(pid) %>%
  summarise(broad_spectrum_exposure_days = n()) %>%
  ungroup()
```

```{r}
generate_bloom_plot <- function(abundance_data, antibiotic_data, threshold) {
  
  # --- 1. Data Processing ---
  
  # Calculate the number of bloom days for each patient based on the threshold.
  bloom_duration <- abundance_data %>%
    filter(Enterococcus_relab > threshold) %>%
    group_by(pid) %>%
    summarise(bloom_days = n(), .groups = "drop")
  
  # Get the total number of samples for each patient to normalize by.
  total_samples_per_patient <- abundance_data %>%
    group_by(pid) %>%
    summarise(total_samples = n(), .groups = "drop")
    
  # Create a master list of all unique patients.
  all_patients <- abundance_data %>%
    distinct(pid)
  
  # Combine all the data frames. Using left_join ensures all patients are kept.
  analysis_data <- all_patients %>%
    left_join(antibiotic_data, by = "pid") %>%
    left_join(bloom_duration, by = "pid") %>%
    left_join(total_samples_per_patient, by = "pid") %>%
    # Replace NA values with 0 for patients with no blooms or no antibiotic exposure.
    mutate(
      broad_spectrum_exposure_days = replace_na(broad_spectrum_exposure_days, 0),
      bloom_days = replace_na(bloom_days, 0)
    ) %>%
    # Calculate the proportion of time in bloom.
    mutate(
      proportion_in_bloom = bloom_days / total_samples
    )
    
  # --- 2. Plotting ---
  
  # Create the plot object.
  plot <- ggplot(analysis_data, aes(x = broad_spectrum_exposure_days, y = proportion_in_bloom)) +
    geom_point(alpha = 0.7, size = 3, color = "#0072B2") +
    geom_smooth(method = "lm", se = FALSE, color = "#D55E00", linetype = "dashed") +
    # Use stat_cor to display the Spearman correlation and p-value.
    stat_cor(method = "spearman", label.x.npc = "left", label.y.npc = "top", size = 5) +
    # Format y-axis as percentages.
    scale_y_continuous(labels = scales::percent_format()) +
    labs(
      #title = "Sustained Antibiotic Exposure is Linked to\nProportion of Time in Bloom",
      x = "Total Days of Broad-Spectrum Antibiotic Exposure",
      # The y-axis label is now dynamic, based on the function's 'threshold' input.
      y = paste0("Proportion of Time in Bloom\n(>", threshold * 100, "% Abundance)")
    ) +
    theme_minimal(base_size = 11) +
    theme(
      plot.title = element_text(face = "bold", size = 12),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(color = "grey80", fill = NA)
    )
    
  # Return the final plot object.
  return(plot)
}


# Now, call the function for each threshold.
plot_0.1 <- generate_bloom_plot(enterococcus_abundance, antibiotic_days_in_window, 0.1)
plot_0.3 <- generate_bloom_plot(enterococcus_abundance, antibiotic_days_in_window, 0.3)


# Or, arrange them side-by-side for a direct comparison using ggarrange.
combined_plot <- ggarrange(plot_0.1, plot_0.3, ncol = 2, nrow = 1)

# Display the combined plot.
print(combined_plot)

```

# the days between the first and last day of Entercoccus relab >= XXXX

```{r}
# This function calculates the summary statistics for a given threshold.
# This avoids repeating code.
calculate_duration <- function(data, threshold) {
  data %>%
    group_by(pid) %>%
    summarise(
      first_sdrt_high_entero = min(sdrt[Enterococcus_relab >= threshold], na.rm = TRUE),
     last_sdrt_high_entero = max(sdrt[Enterococcus_relab >= threshold], na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    mutate(
      first_sdrt_high_entero = if_else(is.infinite(first_sdrt_high_entero), NA_real_, first_sdrt_high_entero),
      duration_days = if_else(is.na(first_sdrt_high_entero), NA_real_, as.numeric(last_sdrt_high_entero - first_sdrt_high_entero + 1)),
      threshold_label = paste(">=", threshold) # Add a label for plotting
    ) %>%
    filter(!is.na(duration_days) & duration_days > 1) # Remove patients who never met the threshold, and only keeping the patients that have at least 2 samples that in the bloom state
}

# Calculate summaries for both thresholds and combine them into one dataframe.
summary_0.1 <- calculate_duration(enterococcus_abundance, 0.1)
summary_0.3 <- calculate_duration(enterococcus_abundance, 0.3)
combined_summary <- bind_rows(summary_0.1, summary_0.3)

# --- Plotting Section ---

# Create a helper dataframe for annotations (patient counts).
annotation_data <- combined_summary %>%
  group_by(threshold_label) %>%
  summarise(patient_count = n(), .groups = 'drop')

# Create the faceted plot.
duration_days_estimate <- ggplot(combined_summary, aes(x = "", y = duration_days)) +
  geom_boxplot(width = 0.4, outlier.shape = NA) +
  geom_jitter(width = 0.1, alpha = 0.6, color = "steelblue") +
  #stat_summary(fun = mean, geom = "point", shape = 23, size = 4, fill = "white") +
  
  # Use facet_wrap to create separate plots for each threshold.
  # This is the key to ensuring the y-axes are on the same scale.
  facet_wrap(~ threshold_label) +
  
  # Add the patient count annotations to each facet.
  geom_text(data = annotation_data, 
            aes(x = 1.4, y = Inf, label = paste("n =", patient_count, "patients")), 
            vjust = 2) +
  scale_y_continuous(
    breaks = seq(0, 36, 4)
  ) +
  labs(
    title = "Duration of Enterococcus Dominance by Threshold",
    y = "Duration (days)",
    x = ""
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(face = "bold") # Make facet labels bold
  )

```
```{r}
# looking at the few patients that had the duration >= 20 days for the threshold of 0.3
# Define the list of patients to be plotted.
patients_of_interest <- c("P53", "P54", "P24", "P40", "P82")

# Filter the main dataframe to only include data for these specific patients.
plot_data <- enterococcus_abundance %>%
  filter(pid %in% patients_of_interest)

# --- Plotting Section ---

# Create the time course plots using ggplot.
ggplot(plot_data, aes(x = sdrt, y = Enterococcus_relab)) +
  # Add points for each individual sample time.
  geom_point(color = "steelblue", size = 2) +
  # Add lines to connect the points for each patient, showing the trajectory.
  geom_line(color = "steelblue", alpha = 0.8) +
  # Add a horizontal dashed line at the 0.3 relative abundance threshold.
  geom_hline(yintercept = 0.3, linetype = "dashed", color = "red") +
  # Use facet_wrap to create a separate plot for each patient.
  # 'scales = "free_x"' allows the x-axis to be different for each patient,
  # which is useful if they have different sampling time ranges.
  facet_wrap(~ pid) +
  # Add informative labels and a title.
  labs(
    title = "Time Course of Enterococcus Relative Abundance",
    x = "Study Day (sdrt)",
    y = "Relative Abundance"
  ) +
  # Apply a clean theme.
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(face = "bold") # Make the patient ID labels bold.
  )

```

# assemble 

```{r}

final_plot <-  plot_grid( duration_days_estimate , combined_plot,
                 label_size = 12, nrow  =2,
                 rel_heights = c(1.2,2),labels = "auto", 
                align = 'vh', axis = 'lrtb')


title <- ggdraw() + 
  draw_label("Rebuttal Fig X",fontface = 'bold',x = 0,hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 0))

combined <- plot_grid(
  title, final_plot,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
) +theme(plot.margin = unit(c(1,1,1,1), "cm"))

ggsave('../data/R34_pt_enterococcus_bloom.pdf',
      width = 8.5, height = 11, units = "in", device = 'pdf', 
      dpi = 300)  
```

