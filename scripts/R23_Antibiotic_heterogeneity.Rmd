---
title: "Antibiotic heterogeneity"
output: html_document
date: "2025-06-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(lme4)
library(lmerTest) # This enhances lmer() to provide p-values
library(emmeans)  # For pairwise comparisons
library(tidyverse)
library(rstatix)
library(brms)   
library(ggpubr)
library(tidybayes)
library(cowplot)
library(ggridges)
library(brmstools)
library(bayesplot)
options(mc.cores = parallel::detectCores())
rstan::rstan_options(auto_write = TRUE)
theme_set(theme_tidybayes() + panel_border())
ncores <- parallel::detectCores()
```

# The Exclusion Analysis: 

removing the patients who got antibiotics for neutropenic fever, bloodstream infections, or C. diff. The remaining cohort will mostly consist of patients on no antibiotics or only prophylactic ones.

```{r}
med <- read_csv('~/Downloads/Data_S4_Medication_Exposures_in_the_Two_Days_Prior_to_Stool_Sample_Collection.csv') %>%
    distinct() %>% 
    group_by(sampleid, sdrt) %>%
  summarise(
    exposure_category = case_when(
      any(drug_category_for_this_study == "broad_spectrum") ~ "broad_spectrum",  # Only broad_spectrum or both
      any(drug_category_for_this_study == "fluoroquinolones") ~ "fluoroquinolones",
      any(drug_category_for_this_study == "other_antibacterials") ~ "other_antibacterials",
      TRUE ~ "not_antibacterial"
    ), .groups = "drop")


meta <- read_csv('../data/153_combined_META.csv') %>% 
  mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(pid = factor(pid)) %>% 
  mutate(fg_egg = fg_egg/100,
         fg_fruit = fg_fruit/100,
         fg_grain = fg_grain/100,
         fg_legume = fg_legume/100,
         fg_meat = fg_meat/100,
         fg_milk = fg_milk/100,
         fg_oils = fg_oils/100,
         fg_sweets = fg_sweets/100,
         fg_veggie = fg_veggie/100) %>% 
  full_join(med, by = join_by(sampleid, sdrt)) 

meta_subset <- meta %>% 
  # remove the samples exposed to broad spectrum abx
  filter(exposure_category!= 'broad_spectrum') %>% 
  # make the samples exposed to any abx to be "exposed"
  mutate(any_abx = if_else(exposure_category == 'not_antibacterial', F, T))


mod <- log(simpson_reciprocal) ~ 0 +        
                intensity+
                any_abx+
               fg_fruit:any_abx+
                fg_meat:any_abx+
                fg_milk:any_abx+
                fg_oils:any_abx+
                fg_egg:any_abx+
                fg_grain:any_abx+
                fg_sweets:any_abx+
                fg_legume:any_abx+
                fg_veggie:any_abx+
                TPN+
                EN+
               (1 | pid) +
                (1 | timebin)
get_prior(mod,data = meta_subset )
```


```{r}
div_priors <- c(# for the food group variables 
            prior(normal(0, 1), class = 'b', coef = "any_abxFALSE:fg_egg"),
            prior(normal(0, 1), class = 'b', coef = "any_abxFALSE:fg_fruit"),
            prior(normal(0, 1), class = 'b', coef = "any_abxFALSE:fg_grain"),
            prior(normal(0, 1), class = 'b', coef = "any_abxFALSE:fg_legume"),
            prior(normal(0, 1), class = 'b', coef = "any_abxFALSE:fg_meat"),
            prior(normal(0, 1), class = 'b', coef = "any_abxFALSE:fg_milk"),
            prior(normal(0, 1), class = 'b', coef = "any_abxFALSE:fg_oils"),
            prior(normal(0, 1), class = 'b', coef = "any_abxFALSE:fg_sweets"),
            prior(normal(0, 1), class = 'b', coef = "any_abxFALSE:fg_veggie"),
            # interaction terms
            prior(normal(0, 1), class = 'b', coef = "any_abxTRUE:fg_egg"),
            prior(normal(0, 1), class = 'b', coef = "any_abxTRUE:fg_fruit"),
            prior(normal(0, 1), class = 'b', coef = "any_abxTRUE:fg_grain"),
            prior(normal(0, 1), class = 'b', coef = "any_abxTRUE:fg_legume"),
            prior(normal(0, 1), class = 'b', coef = "any_abxTRUE:fg_meat"),
            prior(normal(0, 1), class = 'b', coef = "any_abxTRUE:fg_milk"),
            prior(normal(0, 1), class = 'b', coef = "any_abxTRUE:fg_oils"),
            prior(normal(0, 1), class = 'b', coef = "any_abxTRUE:fg_sweets"),
            prior(normal(0, 1), class = 'b', coef = "any_abxTRUE:fg_veggie"),

            # for the TPN
            prior(normal(0, 0.1), class = 'b', coef = "TPNTRUE"),
            # for the EN
            prior(normal(0, 0.1), class = 'b', coef = "ENTRUE"),
            # for the empirical
            prior(normal(0, 0.5), class = 'b', coef = "any_abxTRUE"),
            # for the intensity
            prior(normal( 2, .1), class = 'b', coef = "intensityablative"),
            prior(normal( 2, .1), class = 'b', coef = "intensityreduced"),
            prior(normal( 2, .1), class = 'b', coef = "intensitynonablative")
            )

model_div_original <- brm( mod,  
              data = meta_subset, 
              warmup = 1000, iter = 3000, 
              prior = div_priors,
              cores = ncores, 
              chains = 2, 
               control = list(adapt_delta = 0.99),
              seed = 123, sample_prior = T)
```


```{r}
model_div_original %>%
  gather_draws(`^b_.*`, regex = TRUE) %>% # This is the magic line!
  filter(.variable %in% c('b_any_abxTRUE:fg_sweets','b_any_abxTRUE')) %>%
  mutate(.variable = fct_reorder(.variable, .value)) %>%
  ggplot(aes(x = .value, y = .variable)) + # fct_rev makes the order more intuitive
  stat_pointinterval( .width = 0.95, fatten_point = 1.5) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") + # add a line at 0 for reference
  labs(
    title = "",
    x = "Coefficient Value",
    y = "Parameter"
  ) +
  theme_minimal()+
  theme(legend.position = "none") 
```

## boxplots comparing alpha-diversity and Enterococcus abundance across different antibiotic exposure groups

boxplots comparing alpha-diversity and Enterococcus abundance across different antibiotic exposure groups (No Abx vs. Prophylactic vs. Broad-Spectrum). This will visually prove that the broad-spectrum group has a uniquely severe dysbiosis.

```{r}
# create df that has the med group , Enterococcus relab and the alpha diversity together
g_relab <- read_csv('../data/022_ALL173_stool_samples_genus_counts.csv') %>% 
  spread('genus','relab', fill = 0) %>% 
  select(sampleid, Enterococcus_relab = Enterococcus)

disrupted <- meta %>% 
  full_join(g_relab) %>% 
  select(sampleid, sdrt, pid,simpson_reciprocal, Enterococcus_relab, exposure_category , timebin)
```
```{r}
df <- disrupted %>% filter(exposure_category != 'other_antibacterials')
# --- 1. MODELING ---
# Fit the new mixed-effects model with two random intercepts
model_diversity_adj <- lmer(
  simpson_reciprocal ~ exposure_category + (1 | pid) + (1 | timebin),
  data = df 
)

# The "Tukey" method (Tukey's Honest Significant Difference) is a standard and highly respected procedure specifically designed to adjust the p-values for all pairwise comparisons within a family of tests. It controls the "family-wise error rate," which is the probability of making even one false positive discovery.
stats_to_plot <- emmeans(model_diversity_adj, ~ exposure_category) %>%
  pairs(adjust = "tukey") %>%
  as_tibble() %>%
  separate(
    col = contrast,
    into = c("group1", "group2"),
    sep = " - ",
    remove = FALSE
  ) %>% 
  mutate(p.value = round(p.value, 2))

exposure_colors <- c(
  "not_antibacterial" = "#1B9E77",
  "fluoroquinolones" = "#D95F02",
  "broad_spectrum" = "#7570B3"
)
```


```{r}
diversity_plot <- ggplot(df, aes(x = exposure_category, y = simpson_reciprocal)) +
  # Use geom_violin for a better sense of the distribution, with boxplots inside
  #geom_violin(aes(fill = exposure_category), alpha = 0.6, trim = FALSE) +
  geom_boxplot(width = 0.15, outlier.shape = NA, fill = "white") +
  # Add individual data points with some transparency
  geom_jitter(width = 0.1, alpha = 0.1, size = 1.5) +
  # Use the custom color palette
  scale_fill_manual(values = exposure_colors) +
  # Add the statistical annotations, now showing the p-value
  stat_pvalue_manual(
    stats_to_plot,
    label = "p.value", # Use a formatted p-value
    tip.length = 0.01,
    y.position = c(40, 46, 50) # Manually adjust y-axis position for the bars
  ) +
  # Add cleaner labels and a more descriptive title
  labs(
    title = "Microbiome Diversity by Antibiotic Exposure",
    subtitle = "Adjusted for patient and time effects",
    x = NULL, # Remove x-axis title for a cleaner look
    y = "Alpha Diversity (Simpson Reciprocal)"
  ) +
  # Use a classic, publication-ready theme
  theme_bw(base_size = 14) +
  theme(
    legend.position = "none", # Hide legend as the x-axis is clear
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1) # Angle labels if they overlap
  )
diversity_plot
```
```{r}
# --- Fit the model with ONLY the confounders ---
# This model captures the variation due to patient and time
nuisance_model <- lmer(simpson_reciprocal ~ (1 | pid) + (1 | timebin), data = df)

# Extract the Residuals
# The residuals are what's left of your diversity data after the effects of pid and week have been mathematically accounted for.

df$time_and_pid_adjusted_diversity <- residuals(nuisance_model) 


# --- Perform pairwise Wilcoxon tests on the residuals ---
# The formula means "test time_adjusted_diversity grouped by exposure_category"
stat.test <- df %>%
  wilcox_test(time_and_pid_adjusted_diversity ~ exposure_category) %>%
  add_significance("p.adj") # Adds a column with significance stars, e.g., *, **, ns

# Prepare the stats table for ggplot by calculating the bracket positions
stat.test <- stat.test %>%
  add_xy_position(x = "exposure_category")
```


```{r}
ggplot(df, aes(x = exposure_category, y = time_and_pid_adjusted_diversity)) +
  # Add a horizontal line at 0. A value of 0 means "average after adjustment".
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  
  geom_boxplot(, alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.3) +
  
 # --- ADD THIS LAYER TO PUT THE STATS ON THE PLOT ---
  stat_pvalue_manual(
    stat.test,
    label = "p.adj.signif", # Use significance stars for a clean look
    tip.length = 0.01,
    bracket.nudge.y = 1 # Adjust to move brackets up slightly
  ) +
  
  labs(
    title = "Microbiome Diversity After Adjusting for Time and Patient Effects",
    subtitle = "Plotting the residuals of a time + patient model",
    x = "Antibiotic Exposure Category",
    y = "Time and patients\nAdjusted Diversity (Residuals)"
  ) +
  theme_bw(base_size = 14) +
  theme(legend.position = "none")        
```

