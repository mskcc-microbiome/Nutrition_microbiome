---
title: "Clinical outcome"
output: html_document
date: "2024-07-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(LCAtoolbox)
library(gtsummary)
library(ggsurvfit)
library(tidycmprsk)
library(survival)
library(ggpubr)
library(gt)
library(cowplot)
library(survminer)
library(patchwork)
library(geepack)
```


# load the cleaned data

```{r}
#load("../data/df_main_Dec10.Rdata") 
# link <- read_csv('../../MSS_pipeline-/scripts/food_tree/data/152_pid_match.csv')
# 
# df_main <- df_main |>
#   mutate(gvhdppx_CNI = as.numeric(gvhd_ppx == "CNI-based"),
#          gvhdppx_PTCy = as.numeric(gvhd_ppx == "PTCy-based"))
# 
# 
# colnames(df_main)
# df_main <- df_main %>%
#   select(source:gvhdppx_PTCy) %>%
#   mutate(mrn = as.numeric(mrn_str)) %>%
#   full_join(link) %>%
#   select(-d100_a_gvhd_onset, -mrn_str, -agvhd_onset,  -mrn) %>%
#   relocate(pid, .before = 'source')
# 
# df_main %>% write_rds('../data/R02_cleaned_clinical_outcome2.rds')

# the below table has the pid
df_main <- read_rds('../data/R02_cleaned_clinical_outcome.rds') %>%
  mutate(modal_diet = as.character(modal_diet),
         modal_diet = if_else(modal_diet == 'High intake', 'Higher-intake', 'Lower-intake/sugar-enriched'),
         modal_diet = factor(modal_diet, levels = c( 'Lower-intake/sugar-enriched', 'Higher-intake'))) %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(source_and_gvhdppx = str_glue('{source}+{gvhd_ppx}'),
         source_and_gvhdppx = factor(source_and_gvhdppx, levels = c('TCD+TCD','Cord+CNI-based','Unmodified+CNI-based','Unmodified+PTCy-based')),
         day_exposed_cat = factor(day_exposed_cat, levels = c('Short exposure (< 8 days)','Long exposure (>= 8 days)'))) %>% 
  mutate(day_exposed_cat = str_replace(day_exposed_cat, ' \\(.+\\)','')) %>% 
  mutate(abx_diet_cat = str_glue('{modal_diet}, {day_exposed_cat}'))
df_main %>% count(abx_diet_cat)
 
```
 
```{r}
colnames(df_main)
df_main %>% count(type_gvhd_simple)
df_main %>% count(abx_diet_cat)
```
 
# OS model

## survival 

```{r survival}
# survival between two clusters
OS_clusers <- survfit2(Surv(OStime_30,OSevent)~ modal_diet  , data = df_main |> filter(OStime_30 > 0 )) %>%
  ggsurvfit(linewidth = 0.8) +
  add_pvalue("annotation",size=5) +
  add_risktable()+
  ylab("Survival probability") +
  xlab("Days relative to HCT, landmarked at day 12")+
   scale_color_manual(values = c( "darkslateblue",  "darkgoldenrod2"), name = '') +
  ylim(c(0,1)) +
  ggtitle("")+
  theme(aspect.ratio = 1/1.5, legend.position = c(0.5, 0.3))
OS_clusers

survival_plot <- list(
  ggsurvfit::ggsurvfit_build(OS_clusers)
) |> 
  wrap_plots()

```

```{r}
# Kaplan-Meier survival curves for 4 groups
plot_colors <- c(
  "Higher-intake, Short exposure" = "#8B4513", # SaddleBrown (or a similar brown)
  "Higher-intake, Long exposure"  = "#FFD700", # Gold (Yellow)
  "Lower-intake/sugar-enriched, Short exposure"  = "#ADD8E6", # LightBlue
  "Lower-intake/sugar-enriched, Long exposure"   = "#00008B"  # DarkBlue
)

OS_clusers_4 <- survfit2(Surv(OStime_30,OSevent)~ abx_diet_cat  , data = df_main |> filter(OStime_30 > 0 )) %>%
  ggsurvfit(linewidth = 0.8) +
  scale_colour_manual(values = plot_colors) +
  add_pvalue("annotation",size=5) +
  add_risktable()+
  ylab("Survival probability") +
  xlab("Days relative to HCT, landmarked at day 12")+
   #scale_color_manual(values = c( "darkslateblue",  "darkgoldenrod2"), name = '') +
  ylim(c(0,1)) +
  ggtitle("")+
  theme(aspect.ratio = 1/1.5, legend.position = c(0.5, 0.3))
OS_clusers_4

survival_plot <- list(
  ggsurvfit::ggsurvfit_build(OS_clusers_4)
) |> 
  wrap_plots()     

# "At Risk" Table : For each group, this table tells you the number of patients who were still alive and being followed (i.e., had not yet experienced the event and had not been censored) at specific time points shown on the X-axis (0, 100, 200, 300 days landmarked). When the number "at risk" becomes very small (e.g., single digits), the survival curve estimates for that group at later time points become less reliable because they are based on fewer patients.
# Understanding Censoring: Drops in the "at risk" numbers that don't correspond to steps down in the curve can indicate censoring (patients lost to follow-up, or the study ended before they had an event).
# "Events" : For each group, this table typically shows the cumulative number of events (e.g., deaths) that have occurred up to the specific time points on the X-axis.
# "landmarked at day 12": This means the analysis effectively starts at HCT day 12. Only patients who were alive at day 12 are included, and their follow-up time begins from this point. This is often done to avoid "immortal time bias," where patients who survive longer have more opportunity to, for example, receive a longer duration of treatment, which could skew results if not accounted for.
```

## Table S3 model fit

```{r OS_model}
# rename the columns so that they look nice in the output table!
input_df <- df_main |> 
  filter(OStime_30 > 0) %>% 
  rename(`Diet-pattern cluster` = modal_diet,
         `Abx exposure(days)` =day_exposed,
         `Conditioning intensity` = intensity,
         Graft_type_and_GvHD_prophylaxis = source_and_gvhdppx) %>% 
  mutate(Graft_type_and_GvHD_prophylaxis = case_when(
    Graft_type_and_GvHD_prophylaxis == 'TCD+TCD' ~ 'T-cell depleted PBSC',
    Graft_type_and_GvHD_prophylaxis == 'Cord+CNI-based' ~ 'Cord blood + CNI-based',
    Graft_type_and_GvHD_prophylaxis == 'Unmodified+CNI-based' ~ 'Unmodified graft + CNI-based',
    Graft_type_and_GvHD_prophylaxis == 'Unmodified+PTCy-based' ~ 'Unmodified graft + PTCy-based'
  )) %>% 
  mutate(Graft_type_and_GvHD_prophylaxis = factor(Graft_type_and_GvHD_prophylaxis, levels = c('T-cell depleted PBSC','Cord blood + CNI-based','Unmodified graft + CNI-based','Unmodified graft + PTCy-based'))) %>% 
    rename(`Graft source and GvHD prophylaxis` = Graft_type_and_GvHD_prophylaxis) %>% 
   mutate(`Diet-pattern cluster` = case_when(
    `Diet-pattern cluster` == 'Lower-intake/sugar-enriched' ~ 'Cluster 1 (Lower-intake/sugar-enriched)',
    `Diet-pattern cluster` == 'Higher-intake' ~ 'Cluster 2 (Higher-intake)' 
  )) 



fit <- coxph(Surv(OStime_30,OSevent)~`Diet-pattern cluster`*`Abx exposure(days)`  + `Conditioning intensity` + `Graft source and GvHD prophylaxis`,
             data= input_df)

fit |> 
  tbl_regression(exponentiate = FALSE) |> 
  bold_p() |> 
  as_gt() |> 
  gtsave(filename="../data/09_OS_model_multi.png")


# just print the multivar table to the correct size

title <- ggdraw() + 
  draw_label(
    "Table S3",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    plot.margin = margin(0, 0, 0, 5)
  )


table_OS <- ggdraw() + draw_image("../data/09_OS_model_multi.png", scale = .8)
    
combined <- plot_grid(
  title, table_OS,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.05, 1)
)+theme(plot.margin = unit(c(1,1,1,1), "cm"))

ggsave('../results//Table_S3_OS_multivariate_R09.pdf',
      width = 210, height = 297, units = "mm", device = 'pdf', plot = combined, dpi = 300)  
```
 
## F3C  

```{r}
## The following lines construct a Wald test on the association between abx exposure and OS for high intake patients.
diff <- sum(coef(fit)[c(2,9)])
p <- aod::wald.test(Sigma=vcov(fit)[c(2,9),c(2,9)],
                    b=coef(fit)[c(2,9)],
                    L=t(c(1,1)))

## Visualizing associations between abx and OS for low and high intake patient groups:
loghr <- data.frame(exposure = 0:20,
                    hr = exp(c(coef(fit)[2]*0:20,
                               diff*0:20)),
                    group = c(rep("Lower intake",21),
                              rep("Higher intake",21)),
                    ub = exp(c((coef(fit)[2]+sqrt(vcov(fit)[2,2])*1.96)*0:20,
                               (diff+1.96*sqrt(sum(vcov(fit)[c(2,9),c(2,9)])))*0:20)),
                    lb = exp(c((coef(fit)[2]-sqrt(vcov(fit)[2,2])*1.96)*0:20,
                               (diff-1.96*sqrt(sum(vcov(fit)[c(2,9),c(2,9)])))*0:20))
)
```


```{r abx_VS_diet_logHR}
abx_diet_logHR <- loghr |> 
  ggplot(aes(x=exposure,y=hr)) + 
  geom_line(aes(color=group), size = 1.5)+
  geom_ribbon(aes(ymin=lb,ymax=ub),alpha=0.2) +
  geom_hline(yintercept = 1,color="black",linetype=2)+
  scale_y_continuous(transform = "log",labels=function(x) sprintf("%.0f", x))+
  #facet_grid(.~group, labeller = labeller(facet_var = c("Higher intake" = "Lower intake", "Lower intake" = "Higher intake"))) +
  facet_grid(.~group) +
  ylab("log(Hazard ratio) compared to\nnon-exposure patients") + 
  xlab("Number of days exposed to broad-spectrum\nantibiotics between day -7 to 12\nrelative to transplant") + theme_light()+
  scale_color_manual(values = c( "darkgoldenrod2", "darkslateblue"), name = '') +
  theme(aspect.ratio = 1,  legend.position = 'none') 

abx_diet_logHR
```

# me  
 
```{r}
fit_original <- coxph(Surv(OStime_30,OSevent)~modal_diet*day_exposed  +intensity + source_and_gvhdppx,
             data= df_main)
colnames(df_main)
```


```{r}
# --- 1. Extract Coefficients and Variance-Covariance Matrix ---
model_coefs <- coef(fit_original)
model_vcov <- vcov(fit_original)

# --- 2. Identify the EXACT Coefficient Names ---
# Run this line to see the names R assigned:
names(model_coefs)
```


```{r}
abx_coef_name <- "day_exposed" 
interaction_coef_name <- "modal_dietHigher-intake:day_exposed" 

# Check if the names exist in the model output
if (!abx_coef_name %in% names(model_coefs)) {
  stop("The specified name for the antibiotic exposure coefficient was not found in the model. Check names(coef(fit)).")
}
if (!interaction_coef_name %in% names(model_coefs)) {
  stop("The specified name for the interaction coefficient was not found in the model. Check names(coef(fit)).")
}
```


```{r}
# --- 3. Calculate Log(HR) and SE for Cluster 1 (Reference) ---

# Log(HR) is just the coefficient for the main effect
loghr_c1 <- model_coefs[abx_coef_name]

# Standard Error (SE) is the square root of the variance (diagonal element of vcov matrix)
se_c1 <- sqrt(model_vcov[abx_coef_name, abx_coef_name])

# --- 4. Calculate Log(HR) and SE for Cluster 2 ---

# Log(HR) is the sum of the main effect and the interaction term
loghr_c2 <- model_coefs[abx_coef_name] + model_coefs[interaction_coef_name]

# Standard Error (SE) for the sum requires variances and covariance:
# SE_sum = sqrt(Var(A) + Var(B) + 2*Cov(A, B))
var_abx <- model_vcov[abx_coef_name, abx_coef_name]
var_int <- model_vcov[interaction_coef_name, interaction_coef_name]
cov_abx_int <- model_vcov[abx_coef_name, interaction_coef_name]

se_c2 <- sqrt(var_abx + var_int + 2 * cov_abx_int)

# --- 5. Calculate 95% Confidence Intervals ---
# CI = Estimate +/- Z * SE (where Z is approx 1.96 for 95% CI)
z_crit <- qnorm(0.975) # More precise Z-value for 95%

ci_c1_low <- loghr_c1 - z_crit * se_c1
ci_c1_high <- loghr_c1 + z_crit * se_c1

ci_c2_low <- loghr_c2 - z_crit * se_c2
ci_c2_high <- loghr_c2 + z_crit * se_c2

# --- 6. Display Results ---
results <- data.frame(
  Cluster = c("Cluster 1:Lower-intake/sugar-enriched", "Cluster 2:Higher-intake"),
  LogHR = c(loghr_c1, loghr_c2),
  SE = c(se_c1, se_c2),
  CI_Lower = c(ci_c1_low, ci_c2_low),
  CI_Upper = c(ci_c1_high, ci_c2_high)
) %>% 
  mutate(Cluster = factor(Cluster, levels = c('Cluster 2:Higher-intake','Cluster 1:Lower-intake/sugar-enriched')))

```


```{r}
ggplot(results, aes(x = LogHR, y = Cluster, color = Cluster)) +
  # Add horizontal error bars using the calculated CIs
  geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper), height = 0.1, linewidth = 0.8) +
  # Add points for the log HR estimates
  geom_point(shape = 15, size = 4) + # Shape 15 is a solid square
  # Add vertical line at log HR = 0 (no effect)
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", linewidth = 0.5) +
  # Apply the custom colors
  scale_color_manual(values = c( "darkgoldenrod2", "darkslateblue")) +
  # Set axis labels
  labs(
    x = "Log HR per day\nof antibiotic exposure",
    y = NULL # Remove y-axis title
  ) +
  # Customize the theme
  theme_classic() + # A clean theme
  theme(
    #axis.line.y = element_blank(), # Remove y-axis line
    axis.ticks.y = element_blank(), # Remove y-axis ticks
    axis.text.y = element_text(hjust = 1, size = 10), # Align y-axis labels, adjust size
    axis.title.x = element_text(size = 11), # Adjust x-axis title size
    legend.position = "none" # Hide the legend
  ) +
  # Set x-axis limits - adjust these based on your actual CI ranges for a good view
  coord_cartesian(xlim = c(-0.15, 0.25))  
```
 

#  now F3

```{r}
# the legend for the stacked bar graph
bar_leg <-  plot_grid(ggpubr::get_legend(Average_intake))
ggsave('../data/09_bar_leg.pdf')
```

```{r}
title <- ggdraw() + 
  draw_label(
    "Fig. 3",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    plot.margin = margin(0, 0, 0, 5)
  )

top <- plot_grid(pdiet2, pdiet2_comp, Average_intake_plot, Average_composition,
                 label_size = 12, ncol = 2,labels = c('A','B','C','D'),
                align = 'vh', axis = 'lrtb')




bottom <- plot_grid(survival_plot, abx_diet_logHR,
                 label_size = 12, ncol = 2,labels = c('E','F'),rel_widths  = c(1,1),
                align = 'vh', axis = 'lrtb')

all <- plot_grid(top, bottom, align = 'vh', axis = 'lrtb', nrow = 2, rel_heights = c(2,1.5))
 
combined <- plot_grid(
  title, all,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.05, 1)
)+theme(plot.margin = unit(c(1,1,1,1), "cm"))

ggsave('../data/09_clinical_outcome.pdf',
      width = 210, height = 297, units = "mm", device = 'pdf', plot = combined, dpi = 300)  
```

# Sugar density and OS

```{r}
dtb <- read_csv('../data/152_combined_DTB.csv')

daily_intake <- dtb %>%
  # Group by patient ID (pid) and day relative to transplant (fdrt)
  group_by(pid, fdrt) %>%
  # Calculate the sum of calories and sugar for each day
  summarise(
    total_caloric_intake = sum(Calories_kcal, na.rm = TRUE),
    sugar_intake_grams = sum(Sugars_g, na.rm = TRUE)
  ) %>%
  ungroup()

# --- Step 2: Calculate Calorie-Adjusted Sugar Intake ---
# This pipe will now take the aggregated daily data, calculate the average 
# sugar density (grams per 1000 kcal), and prepare it for the model.
patient_summary <- daily_intake %>%
  # Filter for the specified time window of day -7 to day 12
  filter(fdrt >= -7 & fdrt <= 12) %>%

  # Calculate the daily sugar density (grams of sugar per 1000 kcal)
  mutate(
    daily_sugar_density = if_else(total_caloric_intake > 0,
                                  sugar_intake_grams / (total_caloric_intake / 1000),
                                  0) # If no calories, density is 0
  ) %>%

  # Group by patient to create a single summary row for each one
  group_by(pid) %>%
  summarise(
    # also summarize the absolute gram weight intake
    avg_sugar_daily_intake_gram = mean(sugar_intake_grams, na.rm = TRUE),
    # This is your diet COMPOSITION variable
    avg_sugar_density_per_1000kcal = mean(daily_sugar_density, na.rm = TRUE),
    # This is your diet QUANTITY variable
    avg_total_caloric_intake = mean(total_caloric_intake, na.rm = TRUE)
  ) %>%
  ungroup() %>% 
  inner_join(df_main %>% select(pid, OStime_30, OSevent, intensity, source_and_gvhdppx, day_exposed, source, gvhd_ppx, age, sex, Disease = disease.simple)) %>%
  mutate(
    # Create a factor "High" or "Low" based on the median of the cohort
    SugarCal_cat_high = if_else(avg_sugar_density_per_1000kcal > median(avg_sugar_density_per_1000kcal, na.rm = TRUE),
                                          "High", "Low"),
    SugarCal_cat_high = factor(SugarCal_cat_high, levels = c('Low','High'))
  )
```

## two scatter correlation

```{r}
# --- Plot 1: Raw Sugar Intake vs. Total Calories ---
# This plot shows the relationship between the total amount of food eaten
# and the absolute amount of sugar consumed. We expect a strong positive correlation,
# as people who eat more food in general will also eat more sugar.
plot_raw_sugar <- ggplot(patient_summary, aes(x = avg_total_caloric_intake / 1000, y = avg_sugar_daily_intake_gram)) +
  geom_point(alpha = 0.6, color = "black") +
  geom_smooth(method = "lm", se = FALSE, color = "darkred") +
  # This function from ggpubr calculates and adds the Pearson correlation coefficient
  stat_cor(method = "spearman", label.x = 1, label.y = 170, p.accuracy = 0.001) +
  labs(
    title = "Raw Sugar Intake vs. Total Calories",
    x = "Average Daily Caloric Intake (in 1000s kcal)",
    y = "Average Daily Raw Sugar Intake (grams)"
  ) +
  theme_minimal()

# --- Plot 2: Calorie-Adjusted Sugar vs. Total Calories ---
# This plot checks if our calorie-adjustment worked. After normalizing sugar
# intake to a standard energy unit (grams per 1000 kcal), there should be
# little to no correlation with total calories. This confirms we have
# successfully removed total intake as a confounder.
plot_adjusted_sugar <- ggplot(patient_summary, aes(x = avg_total_caloric_intake / 1000, y = avg_sugar_density_per_1000kcal)) +
  geom_point(alpha = 0.6, color = "green4") +
  geom_smooth(method = "lm", se = FALSE, color = "darkred") +
  # Calculate and add the Pearson correlation for this plot
  stat_cor(method = "spearman", label.x = 1, label.y = 170, p.accuracy = 0.001) +
  labs(
    title = "Calorie-Adjusted Sugar vs. Total Calories",
    x = "Average Daily Caloric Intake (in 1000s kcal)",
    y = "Average Sugar Density (grams per 1000 kcal)"
  ) +
  theme_minimal()


# --- Arrange and display both plots side-by-side ---
# This makes it easy to compare the two relationships directly.
ggarrange(plot_raw_sugar, plot_adjusted_sugar, ncol = 2)

```

## multivariate model 

Model 2: With Interaction (the non-significant one)
Surv ~ SugarCal_cat_high * day_exposed + ...

This model asks much more complex, conditional questions:

"What is the survival difference between high-sugar and low-sugar groups specifically when antibiotic exposure is zero?" (This is the new meaning of the SugarCal_cat_highHigh term).

"What is the effect of antibiotics specifically for the low-sugar group?" (This is the new meaning of the day_exposed term).

"Is the effect of antibiotics different in the high-sugar group compared to the low-sugar group?" (This is the SugarCal_cat_highHigh:day_exposed interaction term).

The Drastic Difference Explained
Your results changed so dramatically because the interaction term re-defines the main effects.

In the second model, the coefficient for SugarCal_cat_highHigh (p=0.64) is no longer measuring the overall effect of being in the high-sugar group. It's now measuring the effect only for a hypothetical patient who had zero days of antibiotic exposure. In your cohort, it's very likely that almost no one had zero exposure, so this coefficient is trying to estimate an effect in a situation with very little data, which is why it's not significant.

Likewise, the effect of day_exposed (p=0.28) is now the effect only for the low-sugar group.

The crucial term, SugarCal_cat_highHigh:day_exposed, is asking if the two "slopes" (the risk from antibiotics) are different between the sugar groups. With a p-value of 0.33, the model is telling you that it cannot confidently say the effect of antibiotics is statistically different between the two groups.


```{r}
fit <- coxph(Surv(OStime_30,OSevent)~ SugarCal_cat_high * day_exposed + source_and_gvhdppx + intensity ,
             data=patient_summary |> filter(OStime_30 > 0))

diff <- sum(coef(fit)[c(2,8)])  ### This is the hazard ratio

p <- aod::wald.test(Sigma=vcov(fit)[c(2,8),c(2,8)],
                    b=coef(fit)[c(2,8)],
                    L=t(c(1,1)))

se <- sqrt((vcov(fit)[2,2] + vcov(fit)[8,8] + 2*vcov(fit)[2,8]))

```

## model table output

```{r}
publication_table <- tbl_regression(
  fit,
  exponentiate = FALSE, # This converts log(HR) to Hazard Ratios (HR), which are more interpretable
  # The 'label' argument maps variable names to publication-ready labels.
  # The formula structure is list(variable_name ~ "Desired Label")
  label = list(
    SugarCal_cat_high ~ "Calorie-Adjusted Sugar Intake",
    day_exposed ~ "Abx exposure(days)",
    source_and_gvhdppx ~ "Graft source and GvHD prophylaxis",
    intensity ~ "Conditioning intensity"
    # Note: The interaction term label is automatically created from the main variable labels.
  )
  ) %>%
  # Improve the table's appearance and clarity
  bold_p(t = 0.05) %>% # Make p-values < 0.05 bold
  bold_labels() %>%
  # Add a clear title and a source note for context
  as_gt() %>% # Convert to a gt object for better customization
  gt::tab_header(
    title = "Multivariable Cox Model for Overall Survival"
  ) 
# --- Step 3: Display the Table ---
# In RStudio or a Quarto/RMarkdown document, this will render a beautiful HTML table.
publication_table %>% 
  gt::gtsave(filename = "../data/R09_sugar_density_model_multivariate_output.png") 
```

```{r}
res <- data.frame(Variable=c("Days of abx exposure | low sugar grams/1000Kcal",
                             "Days of abx exposure | high sugar grams/1000Kcal"),
                  log.estimate = c(coef(fit)[2],diff),
                  log.conf.low = c(coef(fit)[2] - 1.96*sqrt(vcov(fit)[2,2]),
                                   diff - 1.96*se),
                  log.conf.high = c(coef(fit)[2] + 1.96*sqrt(vcov(fit)[2,2]),
                                    diff + 1.96*se),
                  estimate = exp(c(coef(fit)[2],diff)),
                  conf.low = exp(c(coef(fit)[2] - 1.96*sqrt(vcov(fit)[2,2]),
                                   diff - 1.96*se)),
                  conf.high = exp(c(coef(fit)[2] + 1.96*sqrt(vcov(fit)[2,2]),
                                    diff + 1.96*se)),
                  p.value = c(0.3,
                              p$result$chi2[3]))

# wrangle results into pre-plotting table form
res_plot <- res |>
  # round estimates and 95% CIs to 2 decimal places for journal specifications
  mutate(across(
    c(estimate, conf.low, conf.high),
    ~ str_pad(
      round(.x, 2),
      width = 4,
      pad = "0",
      side = "right"
    )
  ),
  # add an "-" between HR estimate confidence intervals
  estimate_lab = paste0(estimate, " (", conf.low, "-", conf.high, ")")) |>
  # round p-values to two decimal places, except in cases where p < .001
  mutate(p.value = case_when(
    p.value < .001 ~ "<0.001",
    round(p.value, 2) == .05 ~ as.character(round(p.value,3)),
    p.value < .01 ~ str_pad( # if less than .01, go one more decimal place
      as.character(round(p.value, 3)),
      width = 4,
      pad = "0",
      side = "right"
    ),
    TRUE ~ str_pad( # otherwise just round to 2 decimal places and pad string so that .2 reads as 0.20
      as.character(round(p.value, 2)),
      width = 4,
      pad = "0",
      side = "right"
    )
  )) |>
  # add a row of data that are actually column names which will be shown on the plot in the next step
  bind_rows(
    data.frame(
      Variable = "Variable",
      estimate_lab = "Hazard Ratio (95% CI)",
      conf.low = "",
      conf.high = "",
      p.value = "p-value"
    )
  ) |>
  mutate(Variable = fct_rev(fct_relevel(Variable, "Variable")))

glimpse(res_plot)

p_mid <- 
  res |>
  ggplot(aes(y = fct_rev(Variable))) + 
  theme_classic()+
  geom_point(aes(x=log.estimate), shape=15, size=3) +
  geom_linerange(aes(xmin=log.conf.low, xmax=log.conf.high)) +
  geom_vline(xintercept = 0, linetype="dashed") +
  labs(x="Log Hazard Ratio", y="") +
  coord_cartesian(ylim=c(1,3), xlim=c(-.1, .2)) +
  annotate("text", x = -.1, y = 3, label = "Lower risk",hjust=0) +
  annotate("text", x = .1, y = 3, label = "Higher risk") + 
  theme(axis.line.y = element_blank(),
        axis.ticks.y= element_blank(),
        axis.text.y= element_blank(),
        axis.title.y= element_blank())
p_mid


p_left <-
  res_plot  |>
  ggplot(aes(y = Variable)) +
  geom_text(aes(x = 0, label = Variable), hjust = 0, fontface = "bold") +
  geom_text(
    aes(x = 2, label = estimate_lab),
    hjust = 0,
    fontface = ifelse(res_plot$estimate_lab == "Hazard Ratio (95% CI)", "bold", "plain")
  )+
  theme_void() +
  coord_cartesian(xlim = c(0, 4))

p_left

# right side of plot - pvalues
p_right <-
  res_plot  |>
  ggplot() +
  geom_text(
    aes(x = 0, y = Variable, label = p.value),
    hjust = 0,
    fontface = ifelse(res_plot$p.value == "p-value", "bold", "plain")
  ) +
  theme_void() 

p_right

library(patchwork)
layout <- c(
  area(t = 0, l = 0, b = 30, r = 9), # left plot, starts at the top of the page (0) and goes 30 units down and 3 units to the right
  area(t = 1, l = 8, b = 30, r = 11), # middle plot starts a little lower (t=1) because there's no title. starts 1 unit right of the left plot (l=4, whereas left plot is r=3), goes to the bottom of the page (30 units), and 6 units further over from the left plot (r=9 whereas left plot is r=3)
  area(t = 0, l = 11, b = 30, r = 15) # right most plot starts at top of page, begins where middle plot ends (l=9, and middle plot is r=9), goes to bottom of page (b=30), and extends two units wide (r=11)
)
# final plot arrangement
coeff_plot <- p_left + p_mid + p_right + plot_layout(design = layout)
```
## patient characteristics

```{r}
final <- patient_summary %>% 
  select(age, sex, Disease , source,  intensity, gvhd_ppx, SugarCal_cat_high , day_exposed) %>% 
  mutate(Disease = case_when(
    Disease == 'NHL' ~ "Non-Hodgkin's lymphoma",
    # Myelodysplastic/myeloproliferative neoplasms
    Disease == 'MDS/MPN' ~ 'MDS/MPN',
    Disease == 'AML' ~ 'Acute myeloid leukemia',
    Disease == 'ALL' ~ 'Acute lymphoid leukemia',
    Disease == 'CLL' ~ 'Chronic lymphocytic leukemia',
    Disease == 'CML' ~ 'Other',
    Disease == 'Hodgkins' ~ "Other",
    Disease == 'Myeloma' ~ 'Myeloma', 
    Disease == 'AA' ~ 'Other',
    Disease == 'other' ~ 'Other'
  )) %>% 
  mutate(source = case_when(
    source == 'Unmodified' ~ "Unmodified bone marrow or PBSC",
    source == 'Cord' ~ "Cord blood",
    source == 'TCD' ~ "T-cell depleted PBSC"
  )) %>% 
  mutate(sex = case_when(
    sex == 'F' ~ "Female",
    sex == 'M' ~ "Male"
  )) %>% 
  mutate(intensity = case_when(
    intensity == 'nonablative' ~ "Nonmyeloablative",
    intensity == 'ablative' ~ "Ablative",
    intensity == 'reduced' ~ "Reduced intensity"
  )) %>% 
  mutate(gvhd_ppx = case_when(
    gvhd_ppx == 'CNI-based' ~ "CNI-based",
    gvhd_ppx == 'PTCy-based' ~ "PTCy-based",
    gvhd_ppx == 'TCD' ~ "T-cell depleted PBSC"
  ))  %>% 
  mutate(intensity = fct_reorder(intensity, intensity, .fun=length, .desc = T),
         source = fct_reorder(source, source, .fun=length, .desc = T),
         Disease = fct_reorder(Disease, Disease, .fun=length, .desc = T),
         sex = fct_reorder(sex, sex, .fun=length, .desc = T)) %>% 
  rename(`Graft type` = source, 
         #`HCT-CI` = ci,
         `Intensity of conditioning regimen` = intensity ) %>% 
  rename(Sex = sex, Age = age, `GvHD prophylaxis` = gvhd_ppx,
         `Days exposed to broad-spectrum antibiotics` = day_exposed)

```

```{r}
final %>% 
  tbl_summary(
    statistic = list(all_continuous() ~ "{median} ({IQR})", all_categorical() ~ "{n} ({p}%)"),
    by=SugarCal_cat_high
  ) %>%
 # Improve the table's appearance and clarity
  add_p() %>%
  bold_labels() %>%
   # Use the `all_stat_cols()` selector to target the columns for the "by" variable
  # modify_header(
  #   all_stat_cols() ~ "**Calorie-Adjusted Sugar Intake, {level}**"
  # ) %>%
  # 1. Now, convert the gtsummary object to a gt object
  as_gt() %>%
  # 2. Now you can use any functions from the 'gt' package
  tab_header(
    title = "Patient Characteristics by Calorie-Adjusted Sugar Intake"
  ) %>% 
  gt::gtsave(filename = "../data/R09_patient_summary_binarized.png")
```

## assemble 

```{r}
patient_char <- ggdraw() + draw_image("../data/R09_patient_summary_binarized.png", scale = 1)

model_output <- ggdraw() + draw_image("../data/R09_sugar_density_model_multivariate_output.png", scale = 1)

two <- plot_grid( plot_raw_sugar ,  plot_adjusted_sugar ,
                ncol  = 2,
                labels = 'auto',
                #rel_heights = c(1,2,1),
                align = 'vh', axis = 'lrtb')

top_left <- plot_grid(two ,
                        model_output, 
                ncol  = 1,
                labels = c(NA, "c"),
                rel_heights = c(1,2),
                align = 'vh', axis = 'lrtb')


top_ <- plot_grid(top_left ,
                        patient_char, 
                ncol  = 2,
                labels = c(NA, "d"),
                rel_widths =   c(1,1),
                align = 'vh', axis = 'lrtb')

final_plot <- plot_grid(top_ ,
                        coeff_plot, 
                ncol  = 1,
                labels = c(NA, "e"),
                rel_heights  =   c(3,1),
                align = 'vh', axis = 'lrtb')

title <- ggdraw() + 
  draw_label("Rebuttal Fig X",fontface = 'bold', x = 0,hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 0))

combined <- plot_grid(
  title, final_plot,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.05, 1)
) +theme(plot.margin = unit(c(1,1,1,1), "cm"))

ggsave('../data/R09_sugar_density_OS.pdf',
      width = 17, height = 19, units = "in", device = 'pdf', 
      dpi = 300)       
```

