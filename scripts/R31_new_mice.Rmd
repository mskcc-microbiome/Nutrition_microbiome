---
title: "New mice"
output: html_document
date: "2025-07-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(janitor)
library(cowplot)
library(patchwork)
library(scales)
library(lme4)
library(lmerTest)
library(ggeffects)
library(gt)
library(gtsummary)
library(ggpubr)
library(broom)
library(rstatix)
```


```{r}
dat <- read_csv('../data/7_9_25Biapenem Rebuttal Experiment.csv') %>% 
  filter(!is.na(Total_weight_stool_and_tube_mg) ) %>% 
  mutate(CFUs_per_GramStool = (((((Colonies_counted*(100/Plated_volume_ul))/100)/(10^Dilution_factor) )*1000)/Stool_weight_mg)+1)  %>%
  clean_names() %>%
  mutate(logCFU = log10(cf_us_per_gram_stool)) %>% 
  select(experiment:mouse_identifier, logCFU) %>% 
  filter(str_detect(treatment, 'Biapenem'))


plot_data <- dat %>%
  mutate(
    treatment = factor(treatment, levels = c("Biapenem_Only", "Biapenem_Sucrose"))
  )

# Create the plot using ggplot2
ggplot(plot_data, aes(x = factor(day), y = logCFU)) +
  # First, draw the lines for each individual mouse.
  # The `group = mouse_identifier` is the key aesthetic that tells ggplot
  # to connect the points belonging to each mouse.
  geom_line(
    aes(group = mouse_identifier),
    color = "gray50", # A neutral color for the background lines
    alpha = 0.9     # Make them slightly transparent
  ) +
  # Add individual points for each measurement
  geom_point(
    alpha = 0.9,
    color = "gray50"
  ) +
  # Now, overlay the boxplots on top.
  # The `fill` adds some color, and `alpha` makes them semi-transparent
  # so the lines and points underneath remain visible.
  geom_boxplot(
    aes(fill = treatment),
    outlier.shape = NA, # Hides the outlier points, as we are already plotting all points
    alpha = 0.7
  ) +
  # Create separate plot panels for each treatment group.
  facet_grid(group~treatment) +
  # Use a nice color scheme and remove the fill legend since the
  # panel titles already provide that information.
  scale_fill_manual(values = c("Biapenem_Only" = "#82B3A8", "Biapenem_Sucrose" = "#E09C6C"), guide = "none") +
  # Add informative labels and a title.
  labs(
    title = "Enterococcus Growth Over Time by Treatment",
    subtitle = "Lines connect measurements from individual mice",
    x = "Day",
    y = "Enterococcus Abundance (log CFU/gram)"
  ) +
  # Use a clean, classic theme.
  theme_bw(base_size = 12) +
  # Make some final theme adjustments.
  theme(
    plot.title = element_text(face = "bold", size = 16),
    strip.text = element_text(face = "bold", size = 12), # Makes panel titles bold
    legend.position = "none" # No legend needed
  )

ggsave('../data/R31_room_counts.pdf', width = 7, height = 12)
```

```{r}
fc_data <- dat %>% 
  mutate(day = str_glue('day{day}')) %>% 
  spread('day','logCFU') %>% 
  mutate(fc = day6/day1)

max_finite_fc <- fc_data %>%
  filter(is.finite(fc)) %>%
  summarise(max_val = max(fc)) %>%
  pull(max_val)

plot_data <- fc_data %>%
  mutate(
    # Replace Inf with a value 10% higher than the max finite value
    fc_plot = if_else(is.infinite(fc), max_finite_fc * 1.1, fc),
    # Create a new column to indicate which points were originally infinite
    is_inf = is.infinite(fc)
  )

# Create the plot using ggplot2
ggplot(plot_data, aes(x = treatment, y = fc_plot, fill = treatment)) +
  # Add boxplots to show the distribution of fold changes
  geom_boxplot(
    alpha = 0.6,
    outlier.shape = NA # We will plot all points with geom_jitter
  ) +
  # Add jittered points to show each individual mouse.
  # We can use a different shape for the points that were originally infinite.
  geom_jitter(
    aes(shape = is_inf),
    width = 0.2,
    size = 2.5,
    alpha = 0.8
  ) +
  # Create separate plot panels for each experimental group
  facet_wrap(~group) +
  # Use a log10 scale for the y-axis, which is standard for fold-change data
  scale_y_log10(
    name = "Fold Change (log10 scale)",
    # Add a horizontal line at y=1 for reference (no change)
    breaks = c(0.1, 1, 10, 100),
    labels = c("0.1", "1", "10", "100")
  ) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray30") +
  # Customize the shapes used for the points
  scale_shape_manual(
    name = "",
    values = c(`FALSE` = 21, `TRUE` = 24), # Circle for finite, triangle for infinite
    labels = c(`FALSE` = "Finite FC", `TRUE` = "Infinite FC (Capped)"),
    guide = guide_legend(override.aes = list(fill = "gray50"))
  ) +
  stat_compare_means(
    method = "wilcox.test",
    comparisons = list(c("Biapenem_Only", "Biapenem_Sucrose")),
    label = "p.format" # Display the p-value in a standard format
  ) +
  # Customize the fill colors for the boxplots
  scale_fill_manual(
    name = "Treatment",
    values = c("Biapenem_Only" = "#82B3A8", "Biapenem_Sucrose" = "#E09C6C")
  ) +
  # Add informative labels and a title
  labs(
    title = "Enterococcus Fold Change from Day 1 to Day 6",
    subtitle = "Faceted by Jax room",
    x = ""
  ) +
  # Use a clean, classic theme
  theme_bw(base_size = 12) +
  # Make some final theme adjustments
  theme(
    plot.title = element_text(face = "bold", size = 16),
    strip.text = element_text(face = "bold", size = 11),
    axis.text.x = element_text(angle = 25, hjust = 1),
    legend.position = "bottom"
  )

ggsave('../data/R31_foldchange.jpg', width = 7, height = 9)
```

# old mice

```{r}
newest <- readxl::read_excel('../data/Sucrose_All Experiments Consolidated .xlsx') %>% 
  mutate(Log_CFUs_per_GramStool = log10((((((Colonies_counted*(100/Plated_volume_ul))/100)/(10^Dilution_factor) )*1000)/Stool_weight_mg)+1) ) %>%   
  filter(Day != 1) %>%  
  separate(Treatment, into = c('diet_treatment','abx_treatment'), sep = ', ', remove = T) %>% 
  mutate(diet_treatment = if_else(diet_treatment == 'Vehicle','vehicle','sucrose'),
         abx_treatment = if_else(str_detect(abx_treatment, 'Bia'),'biapenem',abx_treatment),
         diet_treatment = factor(diet_treatment, levels = c('vehicle','sucrose')),
         abx_treatment = factor(abx_treatment, levels = c('PBS','biapenem'))) %>% 
  mutate(CFUs_per_GramStool = (((((Colonies_counted*(100/Plated_volume_ul))/100)/(10^Dilution_factor) )*1000)/Stool_weight_mg)+1) %>% 
  select(Experiment:Mouse_identifier, CFUs_per_GramStool, Log_CFUs_per_GramStool)

newest %>% count(Experiment, Treatment)
```

# room, only replated RB08 including the sucrose and control group as they were also from RB08 

```{r}
experiment_data <- read_csv('../data/7_9_25Biapenem Rebuttal Experiment_updated.csv') %>% 
  filter(Group == 'RB08'| Group == 'sucrose' | Group == 'control') %>% 
  mutate(CFUs_per_GramStool = (((((Colonies_counted*(100/Plated_volume_ul))/100)/(10^Dilution_factor) )*1000)/Stool_weight_mg)+1)  %>%
  clean_names() %>%
  mutate(logCFU = log10(cf_us_per_gram_stool)) 

RB08_7_9_25 <- experiment_data %>% 
  select(treatment:mouse_identifier, log10_cf_us_per_gram_stool = logCFU)

```
```{r}
processed_data <- experiment_data %>%
  # The value '0' can't be plotted on a log scale. We'll replace it with a small number (e.g., 1)
  # to include it in the plot, as is common practice.
  mutate(cf_us_per_gram_stool = if_else(cf_us_per_gram_stool == 0, 1, cf_us_per_gram_stool)) %>%
  # Create separate columns for 'antibiotic_treatment' and 'diet_treatment' from the 'group' column.
  mutate(
    antibiotic_treatment = case_when(
      str_detect(treatment, "Biapenem") ~ "biapenem",
      str_detect(treatment, "PBS") ~ "PBS",
      TRUE ~ "Unknown"
    ),
    diet_treatment = case_when(
      str_detect(treatment, "Sucrose") ~ "sucrose",
      str_detect(treatment, "Only") ~ "vehicle",
      TRUE ~ "Unknown"
    ),
    # Ensure the treatments are ordered correctly for the plot layout.
    antibiotic_treatment = factor(antibiotic_treatment, levels = c("PBS", "biapenem")),
    diet_treatment = factor(diet_treatment, levels = c("vehicle", "sucrose"))
  ) %>%
  # Create a single grouping variable for the x-axis by combining the treatment and day information.
  mutate(
    plot_group = paste(antibiotic_treatment, diet_treatment, day, sep = "_"),
    # Create a unique ID for each mouse's trajectory within its specific treatment group.
    trajectory_group = paste(antibiotic_treatment, diet_treatment, mouse_identifier, sep = "_")
  ) %>%
  # Convert the new grouping variable to a factor and set the levels to enforce the desired plot order.
  mutate(
    plot_group = factor(plot_group, levels = c(
      "PBS_vehicle_1", "PBS_vehicle_3", "PBS_vehicle_6",
      "PBS_sucrose_1", "PBS_sucrose_3", "PBS_sucrose_6",
      "biapenem_vehicle_1", "biapenem_vehicle_3", "biapenem_vehicle_6",
      "biapenem_sucrose_1", "biapenem_sucrose_3", "biapenem_sucrose_6"
    ))
  )
```


```{r}
# --- Plotting ---
# Generate the plot using ggplot2
ggplot(processed_data, aes(x = plot_group, y = cf_us_per_gram_stool, fill = diet_treatment)) +
  
  # Add vertical lines to visually separate the main treatment blocks.
  geom_vline(xintercept = c(3.5, 6.5, 9.5), color = "gray80", linetype = "dashed") +

  # Add boxplots. The fill color is mapped to the diet treatment.
  # Outliers are not plotted here as geom_jitter will show all individual points.
  geom_boxplot(outlier.shape = NA, alpha = 0.8) +
  
   # Add thin lines to track the trajectory of each individual mouse.
  geom_line(aes(group = trajectory_group), color = "gray50", linewidth = 0.5, alpha = 0.7) +
  
  # Add individual data points with some horizontal jitter to prevent overlap.
  geom_point(aes(color = diet_treatment), width = 0.2, size = 2) +
  
  # Use a logarithmic scale for the y-axis, which is essential for this type of CFU data.
  # We customize the labels to show scientific notation (10^2, 10^3, etc.).
  scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x) 10^x, n = 9),
    labels = scales::trans_format("log10", scales::math_format(10^.x))
  ) +
  
  # Set the x-axis tick labels to show the day for each group.
  scale_x_discrete(labels = rep(c("1", "3", "6"), 4)) +
  
  # Manually set the colors to match the publication figure (gray for vehicle, pink for sucrose).
  scale_fill_manual(values = c("vehicle" = "gray", "sucrose" = "#FF69B4")) +
  scale_color_manual(values = c("vehicle" = "gray40", "sucrose" = "red")) +
  
  # Add labels for the axes and title.
  labs(
    y = "Enterococcal\nCFU/gram",
    x = "Treatment Group",
    title = "RB08"
  ) +
  
  # Add annotations below the x-axis to label the main groups.
  annotate("text", x = 2, y = 0.1, label = "PBS\nvehicle", size = 3.5) +
  annotate("text", x = 5, y = 0.1, label = "PBS\nsucrose", size = 3.5) +
  annotate("text", x = 8, y = 0.1, label = "Biapenem\nvehicle", size = 3.5) +
  annotate("text", x = 11, y = 0.1, label = "Biapenem\nsucrose", size = 3.5) +
  
  # Apply a clean, classic theme suitable for publication.
  theme_classic() +
  
  # Further theme adjustments for a polished look.
  theme(
    axis.title = element_text(size = 12),
    axis.text.x = element_text(size = 10, vjust = -1), # Adjust position of day numbers
    axis.text.y = element_text(size = 10),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    legend.position = "none" # Hide the legend as the colors are explained by the fill.
  ) +
  # Extend the plot margin to make room for the annotations.
  coord_cartesian( clip = "off")
```

# weight data 

```{r}
weight_data <- readxl::read_excel('../data/7_9_25 weights_biapenem_rebuttal_experiment.xlsx') %>% 
  clean_names() %>% 
  mutate(group = if_else(str_detect(treatment, 'PBS'), 'RB08', group)) %>% 
  rename(room = group)

processed_weights <- weight_data %>%
  # Determine the number of unique treatments within each room.
  group_by(room) %>%
  mutate(n_treatments = n_distinct(treatment)) %>%
  ungroup() %>%
  # Create a numeric ordering column based on the user's conditional logic.
  mutate(
    treatment_order = case_when(
      # For rooms with 4 treatments (CFU plot order)
      n_treatments == 4 & treatment == "PBS_vehicle" ~ 1,
      n_treatments == 4 & treatment == "PBS_sucrose" ~ 2,
      n_treatments == 4 & treatment == "Biapenem_Only" ~ 3,
      n_treatments == 4 & treatment == "Biapenem_Sucrose" ~ 4,
      # For rooms with 2 treatments
      n_treatments == 2 & treatment == "Biapenem_Only" ~ 1,
      n_treatments == 2 & treatment == "Biapenem_Sucrose" ~ 2,
      TRUE ~ 99 # Default case
    ),
    # Create a unique group for each mouse's trajectory.
    trajectory_group = paste(room, treatment,  mouse_identifier, sep = "_"),
    # Create the group for the x-axis, then reorder it based on our custom logic.
    plot_group = paste(treatment, day, sep = "_"),
    plot_group = fct_reorder(plot_group, treatment_order)
  )
```


```{r}
# --- Plotting ---
# Generate the plot using ggplot2
ggplot(processed_weights, aes(x = plot_group, y = weight)) +
  
  # Add boxplots to show the distribution of weights.
  geom_boxplot(aes(fill = treatment), outlier.shape = NA, alpha = 0.6) +
  
  # Add thin lines to track the trajectory of each individual mouse.
  geom_line(aes(group = trajectory_group), color = "gray20", linewidth = 0.5, alpha = 0.7) +
  
  # Add individual data points.
  geom_jitter(aes(color = treatment), width = 0.1, size = 2, alpha = 0.8) +
  
  # Create separate panels for each room, allowing the x-axis to adjust.
  facet_wrap(~ room, scales = "free_x", nrow = 1) +
  
  # Manually set colors to distinguish treatments.
  scale_fill_brewer(palette = "Pastel1") +
  scale_color_brewer(palette = "Set1") +
  
  # Add labels for the axes and title.
  labs(
    title = "Mouse Weight Trajectories Across Rooms and Treatments",
    x = "Day of Experiment",
    y = "Weight (grams)"
  ) +
  
  # Apply a clean, minimal theme.
  theme_bw() +
  
  # Further theme adjustments for a polished look.
  theme(
    strip.text = element_text(size = 10, face = "bold"), # Facet labels
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), # Rotate labels for readability
    legend.position = "none"
  )


```
# RB07 in May  

```{r}
experiment_data <- read_csv('../data/Biapenem_Testing_May_2025.csv') %>% 
  filter(!is.na(Stool_weight_mg)) %>% 
  mutate(CFUs_per_GramStool = (((((Colonies_counted*(100/Plated_volume_ul))/100)/(10^Dilution_factor) )*1000)/Stool_weight_mg)+1)  %>%
  clean_names() %>%
  mutate(logCFU = log10(cf_us_per_gram_stool)) 

processed_data <- experiment_data %>%
  # The value '0' can't be plotted on a log scale. We'll replace it with a small number (e.g., 1)
  # to include it in the plot, as is common practice.
  mutate(cf_us_per_gram_stool = if_else(cf_us_per_gram_stool == 0, 1, cf_us_per_gram_stool)) %>%
  # Create separate columns for 'antibiotic_treatment' and 'diet_treatment' from the 'group' column.
  mutate(
    antibiotic_treatment = case_when(
      str_detect(treatment, "Biapenem") ~ "biapenem",
      str_detect(treatment, "PBS") ~ "PBS",
      TRUE ~ "Unknown"
    ),
    diet_treatment = case_when(
      str_detect(treatment, "Sucrose") ~ "sucrose",
      str_detect(treatment, "Plain_Hydrogel") ~ "vehicle",
      TRUE ~ "Unknown"
    ),
    # Ensure the treatments are ordered correctly for the plot layout.
    antibiotic_treatment = factor(antibiotic_treatment, levels = c("PBS", "biapenem")),
    diet_treatment = factor(diet_treatment, levels = c("vehicle", "sucrose"))
  ) %>%
  # Create a single grouping variable for the x-axis by combining the treatment and day information.
  mutate(
    plot_group = paste(antibiotic_treatment, diet_treatment, day, sep = "_"),
    # Create a unique ID for each mouse's trajectory within its specific treatment group.
    trajectory_group = paste(antibiotic_treatment, diet_treatment, mouse_identifier, sep = "_")
  ) %>%
  # Convert the new grouping variable to a factor and set the levels to enforce the desired plot order.
  mutate(
    plot_group = factor(plot_group, levels = c(
      "PBS_vehicle_0", "PBS_vehicle_3", "PBS_vehicle_6",
      "PBS_sucrose_0", "PBS_sucrose_3", "PBS_sucrose_6",
      "biapenem_vehicle_0", "biapenem_vehicle_3", "biapenem_vehicle_6",
      "biapenem_sucrose_0", "biapenem_sucrose_3", "biapenem_sucrose_6"
    ))
  )

ggplot(processed_data, aes(x = plot_group, y = cf_us_per_gram_stool, fill = diet_treatment)) +
  
  # Add vertical lines to visually separate the main treatment blocks.
  geom_vline(xintercept = c(3.5, 6.5, 9.5), color = "gray80", linetype = "dashed") +

  # Add boxplots. The fill color is mapped to the diet treatment.
  # Outliers are not plotted here as geom_jitter will show all individual points.
  geom_boxplot(outlier.shape = NA, alpha = 0.8) +
  
   # Add thin lines to track the trajectory of each individual mouse.
  geom_line(aes(group = trajectory_group), color = "gray50", linewidth = 0.5, alpha = 0.7) +
  
  # Add individual data points with some horizontal jitter to prevent overlap.
  geom_point(aes(color = diet_treatment), width = 0.2, size = 2) +
  
  # Use a logarithmic scale for the y-axis, which is essential for this type of CFU data.
  # We customize the labels to show scientific notation (10^2, 10^3, etc.).
  scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x) 10^x, n = 9),
    labels = scales::trans_format("log10", scales::math_format(10^.x))
  ) +
  
  # Set the x-axis tick labels to show the day for each group.
  scale_x_discrete(labels = rep(c("0", "3", "6"), 4)) +
  
  # Manually set the colors to match the publication figure (gray for vehicle, pink for sucrose).
  scale_fill_manual(values = c("vehicle" = "gray", "sucrose" = "#FF69B4")) +
  scale_color_manual(values = c("vehicle" = "gray40", "sucrose" = "red")) +
  
  # Add labels for the axes and title.
  labs(
    y = "Enterococcal\nCFU/gram",
    x = "Treatment Group",
    title = "RB07 in May"
  ) +
  
  # Add annotations below the x-axis to label the main groups.
  annotate("text", x = 2, y = 0.1, label = "PBS\nvehicle", size = 3.5) +
  annotate("text", x = 5, y = 0.1, label = "PBS\nsucrose", size = 3.5) +
  annotate("text", x = 8, y = 0.1, label = "Biapenem\nvehicle", size = 3.5) +
  annotate("text", x = 11, y = 0.1, label = "Biapenem\nsucrose", size = 3.5) +
  
  # Apply a clean, classic theme suitable for publication.
  theme_classic() +
  
  # Further theme adjustments for a polished look.
  theme(
    axis.title = element_text(size = 12),
    axis.text.x = element_text(size = 10, vjust = -1), # Adjust position of day numbers
    axis.text.y = element_text(size = 10),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    legend.position = "none" # Hide the legend as the colors are explained by the fill.
  ) +
  # Extend the plot margin to make room for the annotations.
  coord_cartesian( clip = "off")
```
# RB07 in Feb

I think this is a no fiber experiment

```{r}
experiment_data <- readxl::read_excel('../data/No Fiber CFU MetaData 2025 2.xlsx') %>% 
  filter(!is.na(Stool_weight_mg)) %>% 
  mutate(CFUs_per_GramStool = (((((Colonies_counted*(100/Plated_volume_ul))/100)/(10^Dilution_factor) )*1000)/Stool_weight_mg)+1)  %>%
  clean_names() %>%
  mutate(logCFU = log10(cf_us_per_gram_stool)) 


processed_data <- experiment_data %>%
  # The value '0' can't be plotted on a log scale. We'll replace it with a small number (e.g., 1)
  # to include it in the plot, as is common practice.
  mutate(cf_us_per_gram_stool = if_else(cf_us_per_gram_stool == 0, 1, cf_us_per_gram_stool)) %>%
  # Create separate columns for 'antibiotic_treatment' and 'diet_treatment' from the 'group' column.
  mutate(
    antibiotic_treatment = case_when(
      str_detect(treatment, "Biapenem") ~ "biapenem",
      str_detect(treatment, "PBS") ~ "PBS",
      TRUE ~ "Unknown"
    ),
    diet_treatment = case_when(
      str_detect(treatment, "Sucrose") ~ "sucrose",
      str_detect(treatment, "Plain_Hydrogel") ~ "vehicle",
      TRUE ~ "Unknown"
    ),
    # Ensure the treatments are ordered correctly for the plot layout.
    antibiotic_treatment = factor(antibiotic_treatment, levels = c("PBS", "biapenem")),
    diet_treatment = factor(diet_treatment, levels = c("vehicle", "sucrose"))
  ) %>%
  # Create a single grouping variable for the x-axis by combining the treatment and day information.
  mutate(
    plot_group = paste(antibiotic_treatment, diet_treatment, day_relative_to_antibiotics, sep = "_"),
    # Create a unique ID for each mouse's trajectory within its specific treatment group.
    trajectory_group = paste(antibiotic_treatment, diet_treatment, mouse_identifier, sep = "_")
  ) %>%
  # Convert the new grouping variable to a factor and set the levels to enforce the desired plot order.
  mutate( 
    plot_group = factor(plot_group, levels = c(
      "PBS_vehicle_-7", "PBS_vehicle_0", "PBS_vehicle_3", "PBS_vehicle_6",
      "PBS_sucrose_-7",  "PBS_sucrose_0", "PBS_sucrose_3", "PBS_sucrose_6",
      "biapenem_vehicle_-7", "biapenem_vehicle_0", "biapenem_vehicle_3", "biapenem_vehicle_6",
      "biapenem_sucrose_-7", "biapenem_sucrose_0", "biapenem_sucrose_3", "biapenem_sucrose_6"
    ))
  )

ggplot(processed_data, aes(x = plot_group, y = logCFU, fill = diet_treatment)) +
  
  # Add vertical lines to visually separate the main treatment blocks.
  geom_vline(xintercept = c(4.5, 8.5, 12.5), color = "gray80", linetype = "dashed") +

  # Add boxplots. The fill color is mapped to the diet treatment.
  # Outliers are not plotted here as geom_jitter will show all individual points.
  geom_boxplot(outlier.shape = NA, alpha = 0.8) +
  
   # Add thin lines to track the trajectory of each individual mouse.
  geom_line(aes(group = trajectory_group), color = "gray50", linewidth = 0.5, alpha = 0.7) +
  
  # Add individual data points with some horizontal jitter to prevent overlap.
  geom_point(aes(color = diet_treatment), width = 0.2, size = 2) +
  
  # Use a logarithmic scale for the y-axis, which is essential for this type of CFU data.
  # We customize the labels to show scientific notation (10^2, 10^3, etc.).
  # scale_y_log10(
  #   breaks = scales::trans_breaks("log10", function(x) 10^x, n = 9),
  #   labels = scales::trans_format("log10", scales::math_format(10^.x))
  # ) +
  
  # Set the x-axis tick labels to show the day for each group.
  #scale_x_discrete(labels = rep(c("-7","0", "3", "6"), 4)) +
  
  # Manually set the colors to match the publication figure (gray for vehicle, pink for sucrose).
  scale_fill_manual(values = c("vehicle" = "gray", "sucrose" = "#FF69B4")) +
  scale_color_manual(values = c("vehicle" = "gray40", "sucrose" = "red")) +
  
  # Add labels for the axes and title.
  labs(
    y = "Enterococcal\nCFU/gram (log10)",
    x = "Treatment Group",
    title = "RB07 in Feb"
  ) +
  # 
  # # Add annotations below the x-axis to label the main groups.
  # annotate("text", x = 2, y = 0.1, label = "PBS\nvehicle", size = 3.5) +
  # annotate("text", x = 5, y = 0.1, label = "PBS\nsucrose", size = 3.5) +
  # annotate("text", x = 8, y = 0.1, label = "Biapenem\nvehicle", size = 3.5) +
  # annotate("text", x = 11, y = 0.1, label = "Biapenem\nsucrose", size = 3.5) +
  
  # Apply a clean, classic theme suitable for publication.
  theme_classic() +
  
  # Further theme adjustments for a polished look.
  theme(
    axis.title = element_text(size = 12),
    axis.text.x = element_text(size = 10, vjust = -1, angle = 90), # Adjust position of day numbers
    axis.text.y = element_text(size = 10),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    legend.position = "none" # Hide the legend as the colors are explained by the fill.
  ) +
  # Extend the plot margin to make room for the annotations.
  coord_cartesian( clip = "off")
```
# EM07: 7_25

```{r}
experiment_data <- read_csv('../data/7_25_25_biapenem_rebuttal_EM07.xlsx - Sheet1.csv') %>%  
   filter(!is.na(Stool_weight_mg)) %>% clean_names()
```


```{r}
processed_data <- experiment_data %>%
  # Create separate columns for 'antibiotic_treatment' and 'diet_treatment' from the 'group' column.
  mutate(
    antibiotic_treatment = case_when(
      str_detect(treatment, "Biapenem") ~ "biapenem",
      str_detect(treatment, "PBS") ~ "PBS",
      TRUE ~ "Unknown"
    ),
    diet_treatment = case_when(
      str_detect(treatment, "Sucrose") ~ "sucrose",
      str_detect(treatment, "Only") ~ "vehicle",
      TRUE ~ "Unknown"
    ),
    # Ensure the treatments are ordered correctly for the plot layout.
    antibiotic_treatment = factor(antibiotic_treatment, levels = c("PBS", "biapenem")),
    diet_treatment = factor(diet_treatment, levels = c("vehicle", "sucrose"))
  ) %>%
  # Create a single grouping variable for the x-axis by combining the treatment and day information.
  mutate(
    plot_group = paste(antibiotic_treatment, diet_treatment, day, sep = "_"),
    # Create a unique ID for each mouse's trajectory within its specific treatment group.
    trajectory_group = paste(antibiotic_treatment, diet_treatment, mouse_identifier, sep = "_")
  ) %>%
  # Convert the new grouping variable to a factor and set the levels to enforce the desired plot order.
  mutate(
    plot_group = factor(plot_group, levels = c(
      "PBS_vehicle_0", "PBS_vehicle_3", "PBS_vehicle_6", 
      "PBS_sucrose_0", "PBS_sucrose_3", "PBS_sucrose_6", 
      "biapenem_vehicle_0", "biapenem_vehicle_3", "biapenem_vehicle_6", 
      "biapenem_sucrose_0", "biapenem_sucrose_3", "biapenem_sucrose_6"
    ))
  )
```


```{r}
ggplot(processed_data, aes(x = plot_group, y = cf_us_per_gram_stool, fill = diet_treatment)) +
  
  # Add vertical lines to visually separate the main treatment blocks.
  geom_vline(xintercept = c(3.5, 6.5, 9.5), color = "gray80", linetype = "dashed") +

  # Add boxplots. The fill color is mapped to the diet treatment.
  # Outliers are not plotted here as geom_jitter will show all individual points.
  geom_boxplot(outlier.shape = NA, alpha = 0.8) +
  
   # Add thin lines to track the trajectory of each individual mouse.
  geom_line(aes(group = trajectory_group), color = "gray50", linewidth = 0.5, alpha = 0.7) +
  
  # Add individual data points with some horizontal jitter to prevent overlap.
  geom_point(aes(color = diet_treatment), width = 0.2, size = 2) +
  
  # Use a logarithmic scale for the y-axis, which is essential for this type of CFU data.
  # We customize the labels to show scientific notation (10^2, 10^3, etc.).
  scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x) 10^x, n = 9),
    labels = scales::trans_format("log10", scales::math_format(10^.x))
  ) +
  
  # Manually set the colors to match the publication figure (gray for vehicle, pink for sucrose).
  scale_fill_manual(values = c("vehicle" = "gray", "sucrose" = "pink")) +
  scale_color_manual(values = c("vehicle" = "gray40", "sucrose" = "red")) +
  
  # Add labels for the axes and title.
  labs(
    y = "Enterococcal\nCFU/gram",
    x = "Treatment Group",
    title = "EM07 July 25"
  ) +
  
  # Apply a clean, classic theme suitable for publication.
  theme_classic() +
  
  # Further theme adjustments for a polished look.
  theme(
    axis.title = element_text(size = 12),
    axis.text.x = element_text(size = 10, vjust = 0, angle = 90), # Adjust position of day numbers
    axis.text.y = element_text(size = 10),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    legend.position = "none" # Hide the legend as the colors are explained by the fill.
  ) +
  # Extend the plot margin to make room for the annotations.
  coord_cartesian( clip = "off")
```

# RB08 comparison

```{r}
experiment_data <- read_csv('../data/7_31_25_biapenem_rebuttal_RB08 - Sheet1.csv') %>%  
   filter(CFUs_per_GramStool > 0) %>% clean_names() %>% 
  select(group, treatment, day , mouse_identifier, cf_us_per_gram_stool) %>%
  mutate(strata = case_when(
    mouse_identifier %in% 1:20 ~ "Water",
    mouse_identifier %in% 21:40 ~ "Plain Hydrogel",
    TRUE ~ NA_character_ # This handles any mouse IDs outside the specified range
  ))

experiment_data %>% count(strata, treatment)
```


```{r}
processed_data <- experiment_data %>%
  # Create separate columns for 'antibiotic_treatment' and 'diet_treatment' from the 'group' column.
  mutate(
    antibiotic_treatment = case_when(
      str_detect(treatment, "^B") ~ "biapenem",
      !str_detect(treatment, "^B") ~ "PBS",
      TRUE ~ "Unknown"
    ),
    diet_treatment = case_when(
       str_detect(treatment, "S$") ~ "sucrose",
       treatment == 'B+W' | treatment == 'W' ~ "regular_water",
      str_detect(treatment, "\\+PH") ~ "plain_hydrogel",
      TRUE ~ "Unknown"
    ),
    # Ensure the treatments are ordered correctly for the plot layout.
    antibiotic_treatment = factor(antibiotic_treatment, levels = c("PBS", "biapenem")),
    diet_treatment = factor(diet_treatment, levels = c("plain_hydrogel","regular_water", "sucrose"))
  ) %>%
  # Create a single grouping variable for the x-axis by combining the treatment and day information.
  mutate(
    plot_group = paste(antibiotic_treatment, diet_treatment, day, sep = "_"),
    # Create a unique ID for each mouse's trajectory within its specific treatment group.
    trajectory_group = paste(antibiotic_treatment, diet_treatment, mouse_identifier, sep = "_"))


```

```{r}
ggplot(processed_data, aes(x = plot_group, y = cf_us_per_gram_stool)) +
  
  # Add vertical lines to visually separate the main treatment blocks.
  #geom_vline(xintercept = c(3.5, 6.5, 9.5), color = "gray80", linetype = "dashed") +

  # Add boxplots. The fill color is mapped to the diet treatment.
  # Outliers are not plotted here as geom_jitter will show all individual points.
  geom_boxplot(outlier.shape = NA, alpha = 0.8) +
  
   # Add thin lines to track the trajectory of each individual mouse.
  geom_line(aes(group = trajectory_group), color = "gray50", linewidth = 0.5, alpha = 0.7) +
  
  # Add individual data points with some horizontal jitter to prevent overlap.
  geom_point(aes(color = diet_treatment), width = 0.2, size = 2) +
  
  # Use a logarithmic scale for the y-axis, which is essential for this type of CFU data.
  # We customize the labels to show scientific notation (10^2, 10^3, etc.).
  scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x) 10^x, n = 9),
    labels = scales::trans_format("log10", scales::math_format(10^.x))
  ) +
  facet_wrap(~ strata , scales = 'free_x') +
  # Manually set the colors to match the publication figure (gray for vehicle, pink for sucrose).
  #scale_fill_manual(values = c("vehicle" = "gray", "sucrose" = "pink")) +
  #scale_color_manual(values = c("vehicle" = "gray40", "sucrose" = "red")) +
  
  # Add labels for the axes and title.
  labs(
    y = "Enterococcal\nCFU/gram",
    x = "Treatment Group",
    title = "RB08"
  ) +
  
  # Apply a clean, classic theme suitable for publication.
  theme_classic() +
  
  # Further theme adjustments for a polished look.
  theme(
    axis.title = element_text(size = 12),
    axis.text.x = element_text(size = 10, vjust = 0, angle = 90), # Adjust position of day numbers
    axis.text.y = element_text(size = 10),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    legend.position = "none" # Hide the legend as the colors are explained by the fill.
  ) +
  # Extend the plot margin to make room for the annotations.
  coord_cartesian( clip = "off")
```

# Sugar delayed 

## Design

```{r}
# Define the experimental groups and their properties
groups <- tibble(
  group_name = factor(
    c("Abx + Sucrose (Standard)", "Abx + Sucrose (Delay +1)", "Abx + Sucrose (Delay +2)", "PBS + Sucrose", "PBS + Water", "Abx + Water"),
    levels = c( "PBS + Sucrose", "PBS + Water", "Abx + Sucrose (Delay +2)", "Abx + Sucrose (Delay +1)", "Abx + Sucrose (Standard)", "Abx + Water")
  ),
  injection_type = c("Abx", "Abx", "Abx", "PBS", "PBS", "Abx"),
  treatment_type = c("Sucrose_water", "Sucrose_water", "Sucrose_water", "Sucrose_water", "Regular_water", "Regular_water"),
  treatment_start = c(1, 2, 3, 1, 1, 1),
  treatment_end = c(6, 6, 6, 6, 6, 6)
)

# --- Prepare data for plotting ---

# Data for the treatment rectangles (sucrose/water)
# Adding a small buffer to the end day for better visualization
treatment_rects <- groups %>%
  mutate(
    ymin = as.numeric(group_name) ,
    ymax = as.numeric(group_name) + 0.3,
    xmin = treatment_start+0.05,
    xmax = treatment_end+0.1  
  )

# --- Create data for the initial water treatment in delayed groups ---
# This new data frame defines the gray bands that appear before the sucrose.
water_rects <- groups %>%
  # Filter for only the groups that have a delayed start
  filter(treatment_start > 1) %>%
  mutate(
    ymin = as.numeric(group_name),
    ymax = as.numeric(group_name) + 0.3,
    # The water period starts at Day 1 and ends when sucrose starts
    xmin = 1 + 0.05,
    xmax = treatment_start + 0.05,
    # Explicitly set the treatment type for this period to "Regular_water"
    treatment_type = "Regular_water"
  )

# Data for the stool collection points (triangles)
stool_collection <- groups %>%
  select(group_name) %>%
  crossing(day = c(1, 3, 6)) %>%
  mutate(y = as.numeric(group_name))

# Data for the injection points (arrows)
injections <- groups %>%
  select(group_name, injection_type) %>%
  mutate(
    y = as.numeric(group_name) + 0.25,
    day = 1
    )

# --- Create the plot ---
design <- ggplot() +
  # ---  Add the gray rectangles for the initial water period ---
  geom_rect(
    data = water_rects,
    aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = treatment_type),
    alpha = 0.3
  ) +
  # Add shaded rectangles for sucrose/water treatment periods
  geom_rect(
    data = treatment_rects,
    aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = treatment_type),
    alpha = 0.3
  ) +
  # Add the main timeline for each group
  geom_segment(
    data = groups,
    aes(x = 1, xend = 6, y = as.numeric(group_name), yend = as.numeric(group_name)),
    color = "gray50",
    linewidth = 1
  ) +
  # Add arrows for Abx/PBS injections on Day 1
  geom_segment(
    data = injections,
    aes(x = day+0.05, xend = day+0.05, y = y + 0.2, yend = y),
    arrow = arrow(length = unit(0.2, "cm")),
    color = "black",
    linewidth = 0.8
  ) +
  # Add labels for the injections
  geom_text(
    data = injections,
    aes(x = day+0.05, y = y + 0.35, label = injection_type),
    fontface = "bold",
    size = 2.5
  ) +
  # Add triangles for stool collection days
  geom_point(
    data = stool_collection,
    aes(x = day, y = y),
    shape = 17, # Triangle shape
    size = 2.5,
    color = "black" # A reddish color
  ) +
  # Customize colors for treatments
  scale_fill_manual(
    name = "Diet Treatment",
    values = c("Sucrose_water" = "#F8766D", "Regular_water" = "#999999")
  ) +
  # Set the labels for the y-axis
  scale_y_continuous(
    breaks = 1:length(levels(groups$group_name)),
    labels = levels(groups$group_name),
    limits = c(0.5, length(levels(groups$group_name)) + 1)
  ) +
  # Set the labels and limits for the x-axis
  scale_x_continuous(
    name = "Day",
    breaks = 1:6,
    limits = c(.8, 6.5)
  ) +
  # Add titles and theme
  labs(
   # title = "Experimental Design for Sucrose Delay Study",
    #subtitle = "Timeline of treatments and sample collections for each group",
    y = "Experimental Group"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
    plot.subtitle = element_text(hjust = 0.5, size = 11),
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 11),
    legend.position = "top"
  )
ggsave('../data/R31_delay_design.pdf')
```

## CFU

```{r}
# It's good practice to define the file paths first.
# Replace these with the actual paths to your files.
file_exp1 <- "../data/8_6_25_Biapenem_Sugar_Delay_1 - sheet1.csv"
file_exp2 <- "../data/8_8_25_Biapenem_Sugar_Delay_2 - sheet1.csv"

# Read the first CSV file into a data frame.
# The mutate() function then adds a new column called 'experiment',
# labeling all rows from this file as "Experiment 1".
exp1_data <- read_csv(file_exp1) %>%
  mutate(experiment_no = "Experiment_1")

# Do the same for the second CSV file, labeling these rows as "Experiment 2".
exp2_data <- read_csv(file_exp2) %>%
  mutate(experiment_no = "Experiment_2",
         `Mice Weights` = as.numeric(`Mice Weights`)) # two mice died 

# --- Combine the Data ---

# The bind_rows() function stacks the two data frames on top of each other.
# It automatically matches columns by their names, which is perfect for this task.
combined_data <- bind_rows(exp1_data, exp2_data) %>% 
  mutate(CFUs_per_GramStool = (((((Colonies_counted*(100/Plated_volume_ul))/100)/(10^Dilution_factor) )*1000)/Stool_weight_mg)+1)  %>%
  clean_names() %>%
  mutate(log10_cf_us_per_gram_stool = log10(cf_us_per_gram_stool)) %>% 
  mutate(mouse_identifier = str_glue('{experiment_no}_{mouse_identifier}')) %>% 
  mutate(
    # Create a unique ID for each mouse's trajectory within its specific treatment group.
    trajectory_group = paste(treatment, mouse_identifier, sep = "_")
  ) %>% 
  relocate(log10_cf_us_per_gram_stool, .after = 'mice_weights')

# Define the desired order for the treatment groups on the plot
treatment_order <- c(
  "PBS + Sucrose", 
  "PBS + Water", 
  "Abx + Sucrose (Delay +2)", 
  "Abx + Sucrose (Delay +1)", 
  "Abx + Sucrose (Standard)", 
  "Abx + Water"
)

# The recode step is done once here to prepare the full dataset.
# This makes the names consistent for all subsequent tests.
prepared_data <- combined_data %>%
  mutate(treatment = recode(treatment,
    "Biapenem_Only" = "Abx + Water",
    "Biapenem_Sucrose_reg" = "Abx + Sucrose (Standard)",
    "Biapenem_Sucrose_+1" = "Abx + Sucrose (Delay +1)",
    "Biapenem_Sucrose_+2" = "Abx + Sucrose (Delay +2)",
    "PBS_Only" = "PBS + Water",
    "PBS_Sucrose" = "PBS + Sucrose"
  )) %>% 
  mutate(treatment =  factor(treatment, levels = rev(treatment_order)))

# Define the new color palette for the groups
color_palette <- c(
  "PBS + Water" = "lightgray",
  "PBS + Sucrose" = "lightpink",
  "Abx + Water" = "gray32",
  "Abx + Sucrose (Standard)" = "deeppink2",
  "Abx + Sucrose (Delay +1)" = "deeppink2",
  "Abx + Sucrose (Delay +2)" = "deeppink2"
)
```

### longitudinal_plot

```{r}
longitudinal_plot <- ggplot(prepared_data, aes(x = factor(day), y = cf_us_per_gram_stool, color = treatment)) +
  # Create separate panels for each treatment group
  facet_wrap(~ treatment, ncol = 6) +
  # Add boxplots for each time point, grouped correctly
  geom_boxplot(outlier.shape = NA, aes(group = interaction(day, treatment))) +
  # Connect the data points for each individual mouse with a thin gray line
  geom_line(aes(group = mouse_identifier), color = "gray70", alpha = 0.4) +
  # Add the individual data points
  geom_point(size = 1.3, aes(shape = experiment_no)) +
  scale_shape_manual(values = c("Experiment_1" = 16, "Experiment_2" = 15)) +
  # Calculate and connect the median for each time point with a thick dashed line
  stat_summary(
    fun = median,
    geom = "line",
    aes(group = 1), # Connects medians across days within each facet
    #linetype = "dashed",
    linewidth = 1
  ) +
     # Apply the custom color palette
  scale_color_manual(values = color_palette) +
  # Use a logarithmic scale for the y-axis, which is standard for CFU data
  scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x) 10^x),
    labels = scales::trans_format("log10", scales::math_format(10^.x))
  ) +
  # Add labels and title
  labs(
   # title = "Enterococcus Burden Over Time by Treatment Group",
    x = "Day of Experiment",
    y = "Enterococcus (CFU / gram of feces)"
  ) +
  # Use a clean theme and remove the legend
  theme_bw() +
  theme(
    legend.position = "none",
    strip.text = element_text( size = 7) # Make facet titles bold
  )

ggsave('../data/R31_sugar_delay.png', width = 12, height = 6, plot = longitudinal_plot)
```

### day 6 only

```{r}
# is there a difference comparing day 6 from abx-only vs each of the sugar conditions
# Clean the data: remove rows with NA values and set the desired order for plotting.
day6_data <- prepared_data %>% filter(day  == 6 & str_detect(treatment, '^Abx')) %>%
  # Remove any rows where the log10 CFU is not available
  filter(!is.na(log10_cf_us_per_gram_stool))



# --- 2. Define Comparisons and Colors ---

# Specify which groups to compare for the statistical test
my_comparisons <- list(
  c("Abx + Water", "Abx + Sucrose (Standard)"),
  c("Abx + Water", "Abx + Sucrose (Delay +1)"),
  c("Abx + Water", "Abx + Sucrose (Delay +2)")
)

# Define the color palette for the groups
color_palette <- c(
  "Abx + Water" = "darkgrey",
  "Abx + Sucrose (Standard)" = "deeppink",
  "Abx + Sucrose (Delay +1)" = "deeppink",
  "Abx + Sucrose (Delay +2)" = "deeppink"
)

# --- 3. Create the Plot ---
day6_plot <- ggplot(day6_data, aes(x = treatment, y = log10_cf_us_per_gram_stool, fill = treatment)) +
  # Add the boxplots. outlier.shape = NA prevents plotting outliers twice.
  geom_boxplot(outlier.shape = NA) +
  # Add the individual data points with jitter for better visibility
  geom_jitter(shape = 21, width = 0.2, color = "black") +
  # Apply the custom color palette
  scale_fill_manual(values = color_palette) +
  # Perform Wilcoxon tests and add the p-values to the plot
  stat_compare_means(
    comparisons = my_comparisons,
    method = "wilcox.test",
    label = "p.format" # Formats the p-value nicely
  ) +
  # Flip coordinates to make treatment labels easier to read
  coord_flip() +
  # Add informative labels
  labs(
    title = "delay sugar: Enterococcus Burden at Day 6",
    x = "",
    y = "log10(CFU / gram of stool)"
  ) +
  # Use a clean theme and remove the legend as colors are self-explanatory
  theme_classic() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

# Print the final plot
print(day6_plot)

```


## AUC stats

### vardi

```{r}
library(clinfun)

vardidf <- prepared_data %>% 
  select(treatment:mouse_identifier, log10_cf_us_per_gram_stool) %>% 
  spread('day','log10_cf_us_per_gram_stool') 

vardicts <- vardidf %>% 
  select(-mouse_identifier, -treatment) %>% as.matrix()

vardigrp <- vardidf$treatment
  
# Make pairwise comparisons between all the groups
combos.to.test <-  data.frame(combn(unique(vardigrp),2))
combos.to.test[] <- lapply(combos.to.test, as.character)
stats.results <- plyr::ldply(combos.to.test, function(x) {
  # x <- combos.to.test[[1]]
  paste(x)
  u <- aucVardiTest(vardicts, vardigrp, tim = c(1, 3, 6), cgrps=x) 
  u$p.value
  return(data.frame(Grp.Vs = x[1],
                    Gr = x[2],
                    p.value = round(u$p.value, 3)))
}) 


#set thresholds for what asterisks mean
stats.results$.id <- NULL
p.value.star <- 0.05      
p.value.double <- 0.01

stats.results$sig[stats.results$p.value > p.value.star] <- " "
stats.results$sig[stats.results$p.value <= p.value.star] <- "*"
stats.results$sig[stats.results$p.value <= p.value.double] <- "**"
print(stats.results, row.names = F)

```

### AUC

```{r}
library(DescTools)

auc_data <- combined_data %>%
  group_by(experiment_no, treatment, mouse_identifier) %>%
  # Arrange data by day for correct AUC calculation
  arrange(day, .by_group = TRUE) %>%
  # Calculate the AUC using the trapezoidal rule from the DescTools package.
  # This is robust to missing time points for some mice.
  # The 'na.rm = TRUE' handles cases where a mouse might have only one time point.
  summarise(
    auc = AUC(x = day, y = log10_cf_us_per_gram_stool, na.rm = TRUE),
    .groups = 'drop' # Ungroup the data after summarising
  )

# Perform a Kruskal-Wallis test, which is a non-parametric method
# to see if there are significant differences in AUC among the treatment groups.
# This is appropriate because the AUC values may not be normally distributed.
kruskal_test_result <- kruskal.test(auc ~ treatment , data = auc_data %>% filter(str_detect(treatment, 'Biapenem_Sucrose')) )

# Print the results of the statistical test
print("Kruskal-Wallis test for differences in AUC between treatment groups:")
print(kruskal_test_result)

# --- Visualize AUC Data ---

# Clean up treatment names for better plot labels
auc_data_viz <- auc_data %>%
  mutate(treatment = recode(treatment,
    "Biapenem_Only" = "Abx + Water",
    "Biapenem_Sucrose_reg" = "Abx + Sucrose (Standard)",
    "Biapenem_Sucrose_+1" = "Abx + Sucrose (Delay +1)",
    "Biapenem_Sucrose_+2" = "Abx + Sucrose (Delay +2)",
    "PBS_Only" = "PBS + Water",
    "PBS_Sucrose" = "PBS + Sucrose"
  ))

# Set the treatment column as a factor with the specified order
auc_data_viz$treatment <- factor(auc_data_viz$treatment, levels = treatment_order)


# Define the specific comparisons for the p-values
comparison_list <- list(
  c("Abx + Water", "Abx + Sucrose (Standard)"),
  c("Abx + Water", "Abx + Sucrose (Delay +1)"),
  c("Abx + Water", "Abx + Sucrose (Delay +2)")
)

# Create the boxplot
auc_plot <- ggplot(auc_data_viz, aes(x = treatment, y = auc, color = treatment)) +
  # Boxplot now uses color for the outline and has no fill
  geom_boxplot(outlier.shape = NA, fill = NA, linewidth = 1) +
  # Overlay individual data points
  geom_jitter(width = 0.2, size = 1.5, aes(shape = experiment_no)) +
  scale_shape_manual(values = c("Experiment_1" = 16, "Experiment_2" = 15)) +
  # Apply the custom color palette
  scale_color_manual(values = color_palette) +
  # Add statistical comparisons
  stat_compare_means(
    comparisons = comparison_list,
    method = "wilcox.test", # Use Wilcoxon rank-sum test
    label = "p.format",      # Display the formatted p-value
    tip.length = 0.01
  ) +
  # Flip coordinates to make labels easier to read
  coord_flip(ylim = c(0, max(auc_data_viz$auc, na.rm = TRUE) * 1.23)) + # Adjust y-limit for p-values
  # Add labels and title
  labs(
   # title = "Total Enterococcus Burden (AUC) by Treatment Group",
    #subtitle = "Comparison of AUC across different treatment conditions",
    x = "Treatment Group",
    y = "Area Under the Curve (log10 CFU/gram * days)"
  ) +
  # Use a clean theme
  theme_classic() +
  theme(
    legend.position = "none", # Hide legend as colors are on the axis
    plot.title = element_text(hjust = 0.5, face = "bold"),
    #axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    plot.subtitle = element_text(hjust = 0.5)
  )

# Print the plot
print(auc_plot)
```

### COR: AUC VS days of sugar exposure

```{r}
auc_data_with_exposure_sucrose <- auc_data %>%
  filter(str_detect(treatment, "Biapenem_Sucrose")) %>% 
  mutate(
    sugar_exposure_days = case_when(
      # str_detect() checks if the text contains a specific pattern.
      # The backslashes are needed to treat "+" as a literal character.
      str_detect(treatment, "Biapenem_Sucrose_reg") ~ 5,
      str_detect(treatment, "Biapenem_Sucrose_\\+1") ~ 4,
      str_detect(treatment, "Biapenem_Sucrose_\\+2") ~ 3
    )
  ) %>% 
  # Make sure experiment_no is a factor for the model
  mutate(experiment_no = as.factor(experiment_no))

# Fit the two-way ANOVA model. it is for detecting difference between any groups with out making assumption of the relationship of the groups, and it is 
# wrong in this situation, I do know 4 days of sugar exposure is more sugar than 3 days of exposure. 
# The formula `AUC ~ sugar_exposure_days + experiment_no` tests for the main effects
# of both sugar_exposure_days and Experiment number.
# anova_model <- aov(auc ~ sugar_exposure_days + experiment_no, data = auc_data_with_exposure_sucrose)
# # Get the summary of the model, which includes the p-values for each factor.
# anova_summary <- summary(anova_model)
# # Print the summary to the console.
# print(anova_summary)


# the question:"Is there a linear relationship between the number of days of sugar exposure and the AUC?" 
lm_model <- lm(auc ~ sugar_exposure_days + experiment_no, data = auc_data_with_exposure_sucrose)

# --- 2. Extract Model Coefficients and Statistics ---
# Use the broom::tidy() function to get a clean data frame of model results.
model_summary <- tidy(lm_model)

# Isolate the slope and p-value for our variable of interest.
slope <- model_summary %>%
  filter(term == "sugar_exposure_days") %>%
  pull(estimate)

p_value <- model_summary %>%
  filter(term == "sugar_exposure_days") %>%
  pull(p.value)

# Get the intercept for the reference level (Experiment_1).
# We use this as the primary intercept for our line.
intercept <- model_summary %>%
  filter(term == "(Intercept)") %>%
  pull(estimate)

# --- 3. Create the Annotation Text ---
# Format the slope and p-value for clean plotting.
annotation_text <- paste(
  "Slope =", round(slope, 2),
  "\np-value =", format.pval(p_value, digits = 2)
)

my_yellow <- c('gold','goldenrod2','goldenrod4')

# plot the scatter plot of auc and sugar exposure days
exposure_plot <- auc_data_with_exposure_sucrose %>%
  ggplot(aes(x = sugar_exposure_days, y = auc)) +
  # Add the individual data points
  geom_point(size = 2, alpha = 0.7, aes(color = factor(sugar_exposure_days), shape = experiment_no)) +
  scale_color_manual(values = my_yellow) +
  scale_shape_manual(values = c("Experiment_1" = 16, "Experiment_2" = 15)) +

    # Add the regression line using the coefficients from our specific model.
  geom_abline(intercept = intercept, slope = slope, color = "black", linewidth = 1.2) +

  # Add the annotation text to the plot.
  annotate(
    "text", x = 3.5, y = 15, # Adjust x and y to position the text
    label = annotation_text,
    hjust = 0, size = 4
  ) +

  # Add labels, title, and the important footnote.
  labs(
    #title = "AUC vs. Duration of Sugar Exposure",
    subtitle = "In antibiotic-treated mice",
    x = "Days of Sugar Exposure",
    y = "Area Under the Curve (AUC)",
    shape = "Experiment",
    caption = "*Slope and p-value are derived from a linear model accounting for experiment number."
  ) +
  theme_classic() +
  # Use a clean theme
   scale_x_continuous(
    breaks = c(3, 4, 5),
    labels = c("3\n(Delay + 2)", "4\n(Delay + 1)", "5\n(Standard)")
  ) +
  theme(
    legend.position = "right",
     plot.caption = element_text(hjust = 0, face = "italic") ,# Style the caption
    aspect.ratio = 1,
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5)
  ) + guides(color = 'none')

# Print the plot
print(exposure_plot) 
```


```{r}
# Extract the p-value for the 'Treatment' effect from the summary table.
# The [1, 5] index gets the value from the first row, fifth column (`Pr(>F)`).
p_value <- anova_summary[[1]]$`Pr(>F)`[1]

# Format the p-value text for plotting, adding the asterisk.
p_label <- paste0("p = ", format(p_value, digits = 2, nsmall = 2), "*")
```


#### day 6 and day 1 difference

```{r}
# for the mice that we have data on day 6, calculate the difference of the log10 CFU  between day 6 and day 1
# This section isolates data for Day 1 and Day 6, reshapes the data,
# and calculates the difference for each mouse.
log_diff_data <- prepared_data %>%
  # Keep only the relevant days
  filter(day %in% c(1, 6)) %>%
  # Reshape the data so Day 1 and Day 6 values are in separate columns for each mouse
  pivot_wider(
    id_cols = c(mouse_identifier, treatment),
    names_from = day,
    values_from = log10_cf_us_per_gram_stool,
    names_prefix = "Day"
  ) %>%
  # Remove mice that don't have data for both Day 1 AND Day 6
  drop_na(Day1, Day6) %>%
  # Calculate the log10 difference
  mutate(log10_diff = Day6 - Day1) 

# Set the treatment column as a factor with the specified order
log_diff_data$treatment <- factor(log_diff_data$treatment, levels = treatment_order)

# --- Visualize the Log10 Difference Data ---

# Define the specific comparisons for the p-values on the plot
comparison_list <- list(
  c("Abx + Water", "Abx + Sucrose (Standard)"),
  c("Abx + Water", "Abx + Sucrose (Delay +1)"),
  c("Abx + Water", "Abx + Sucrose (Delay +2)")
)

# Create the boxplot
log_diff_plot <- ggplot(log_diff_data, aes(x = treatment, y = log10_diff)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(color = treatment), width = 0.2, size = 2.5, show.legend = FALSE) +
  # Add statistical comparisons
  stat_compare_means(
    comparisons = comparison_list,
    method = "wilcox.test",
    label = "p.format"
  ) +
  # Add a horizontal line at y=0 for reference (no change)
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
   # Apply the custom color palette
  scale_color_manual(values = color_palette) +
  # Flip coordinates for readability
  coord_flip() +
  # Add labels and title
  labs(
    #title = "Change in Enterococcus Burden (Day 6 vs. Day 1)",
    #subtitle = "Difference in Log10 of CFU/gram of feces",
    x = "Treatment Group",
    y = "Log10(Day 6) - Log10(Day 1))"
  ) +
  # Use a clean theme
  theme_classic() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    plot.subtitle = element_text(hjust = 0.5)
  )

```
#### day 3 and day 1 difference  

```{r}
# now do the above for the day 3 - day 1
# for the mice that we have data on day 3, calculate the difference of the log10 CFU  between day 3 and day 1
# This section isolates data for Day 1 and Day 3, reshapes the data,
# and calculates the difference for each mouse.
log_diff_data_31 <- prepared_data %>%
  # Keep only the relevant days
  filter(day %in% c(1, 3)) %>%
  pivot_wider(
    id_cols = c(mouse_identifier, treatment),
    names_from = day,
    values_from = log10_cf_us_per_gram_stool,
    names_prefix = "Day"
  ) %>%
  # Remove mice that don't have data for both Day 1 AND Day 6
  drop_na(Day1, Day3) %>%
  # Calculate the log10 difference
  mutate(log10_diff = Day3 - Day1) 

# Set the treatment column as a factor with the specified order
log_diff_data_31$treatment <- factor(log_diff_data_31$treatment, levels = treatment_order)

# --- Visualize the Log10 Difference Data ---

# Define the specific comparisons for the p-values on the plot
comparison_list <- list(
  c("Abx + Water", "Abx + Sucrose (Standard)"),
  c("Abx + Water", "Abx + Sucrose (Delay +1)"),
  c("Abx + Water", "Abx + Sucrose (Delay +2)")
)

# Create the boxplot
log_diff_plot_31 <- ggplot(log_diff_data_31, aes(x = treatment, y = log10_diff)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(color = treatment), width = 0.2, size = 2.5, show.legend = FALSE) +
  # Add statistical comparisons
  stat_compare_means(
    comparisons = comparison_list,
    method = "wilcox.test",
    label = "p.format"
  ) +
  # Add a horizontal line at y=0 for reference (no change)
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
   # Apply the custom color palette
  scale_color_manual(values = color_palette) +
  # Flip coordinates for readability
  coord_flip() +
  # Add labels and title
  labs(
    #title = "Change in Enterococcus Burden (Day 3 vs. Day 1)",
    #subtitle = "Difference in Log10 of CFU/gram of feces",
    x = "Treatment Group",
    y = "Log10(Day 3) - Log10(Day 1))"
  ) +
  # Use a clean theme
  theme_classic() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5)
  )


```

 
## assemble

```{r}
top_row <- plot_grid(design, auc_plot, labels = c('a', 'b'), ncol = 2, rel_widths = c(.8,1))

# Now, combine the top_row object with the longitudinal_plot
# The longitudinal plot will be the third element and take the full width
top_two <- plot_grid(
  top_row,
  exposure_plot,
  labels = c(NA ,'c'), # Add label for the bottom plot
  ncol = 1 # Arrange them in a single column, 
)

bottom_row <- plot_grid(longitudinal_plot, labels = c('d'), ncol = 1)

final_plot <-  plot_grid(top_two,
                          bottom_row,
                 label_size = 12, nrow  = 2,
                 rel_heights = c(2,1),
                align = 'vh', axis = 'lrtb')

title <- ggdraw() + 
  draw_label("Supplemental Fig X",fontface = 'bold',x = 0,hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 0))

combined <- plot_grid(
  title, final_plot,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.07, 1)
) +theme(plot.margin = unit(c(1,1,1,1), "cm"))

ggsave('../data/R31_delayed_sugar.pdf',
      width = 8.5, height = 11, units = "in", device = 'pdf', 
      dpi = 300)  
```

# weight data    

```{r}
w1 <- readxl::read_excel('../data/7_9_25 weights_biapenem_rebuttal_experiment.xlsx') %>% 
  clean_names() %>% 
  mutate(group = if_else(str_detect(treatment, 'PBS'), 'RB08', group)) %>% 
  rename(room = group) %>% 
  filter(room == 'RB08')  %>%  # this room has the all 4 groups
  mutate(experiment_no = "survey_RB08") %>% 
  full_join(RB08_7_9_25)

w2 <- read_csv('../data/7_25_25_biapenem_rebuttal_EM07.xlsx - Sheet1.csv') %>%  
   filter(!is.na(Stool_weight_mg)) %>% clean_names() %>% 
  mutate(experiment_no = "EM07_work")

w3 <-  read_csv('../data/7_31_25_biapenem_rebuttal_RB08 - Sheet1.csv') %>%  
   filter(CFUs_per_GramStool > 0) %>% clean_names() %>% 
  select(group, treatment, day , mouse_identifier, cf_us_per_gram_stool, mice_weights) %>%
  mutate(strata = case_when(
    mouse_identifier %in% 1:20 ~ "Water",
    mouse_identifier %in% 21:40 ~ "Plain Hydrogel",
    TRUE ~ NA_character_ # This handles any mouse IDs outside the specified range
  )) %>% 
  filter(strata == 'Water') %>% 
  mutate(experiment_no = "comparison_exp_water")

# two sugar delay mouse experiments
file_exp1 <- "../data/8_6_25_Biapenem_Sugar_Delay_1 - sheet1.csv"
file_exp2 <- "../data/8_8_25_Biapenem_Sugar_Delay_2 - sheet1.csv"

# Read the first CSV file into a data frame.
# The mutate() function then adds a new column called 'experiment',
# labeling all rows from this file as "Experiment 1".
exp1_data <- read_csv(file_exp1) %>%
  mutate(experiment_no = "sugarDelay_1")

# Do the same for the second CSV file, labeling these rows as "Experiment 2".
exp2_data <- read_csv(file_exp2) %>%
  mutate(experiment_no = "sugarDelay_2",
         `Mice Weights` = as.numeric(`Mice Weights`)) # two mice died 

# --- Combine the Data ---

# The bind_rows() function stacks the two data frames on top of each other.
# It automatically matches columns by their names, which is perfect for this task.
w4 <- bind_rows(exp1_data, exp2_data) %>% 
  mutate(CFUs_per_GramStool = (((((Colonies_counted*(100/Plated_volume_ul))/100)/(10^Dilution_factor) )*1000)/Stool_weight_mg)+1)  %>%
  clean_names() %>%
  mutate(log10_cf_us_per_gram_stool = log10(cf_us_per_gram_stool)) 

weights <- bind_rows(
  w1 %>%  select(experiment_no, group = room, day, mouse_identifier, mice_weights = weight, treatment, log10_cf_us_per_gram_stool),
  w2 %>%  select(experiment_no, group, day, mouse_identifier, mice_weights , treatment, log10_cf_us_per_gram_stool) %>% mutate(mice_weights = as.numeric(mice_weights)),
  w3 %>% mutate(log10_cf_us_per_gram_stool = log10(cf_us_per_gram_stool)) %>%  select(experiment_no, group, day, mouse_identifier, mice_weights , treatment, log10_cf_us_per_gram_stool),
  w4 %>% select(experiment_no, group, day, mouse_identifier, mice_weights , treatment, log10_cf_us_per_gram_stool)
) %>% 
  filter(!treatment %in% c('Biapenem_Sucrose_+1','Biapenem_Sucrose_+2'))


processed_weights <- weights %>%
  # Create separate columns for 'antibiotic_treatment' and 'diet_treatment' from the 'group' column.
  mutate(
    antibiotic_treatment = case_when(
      str_detect(treatment, "Biapenem") ~ "biapenem",
      str_detect(treatment, "PBS") ~ "PBS",
      str_detect(treatment, "^B\\+") ~ "biapenem",
      treatment == 'S'~ "PBS",
      treatment == 'W'~ "PBS",
      TRUE ~ "Unknown"
    ),
    diet_treatment = case_when(
      str_detect(treatment, "Sucrose") ~ "sucrose_water",
      str_detect(treatment, "_Only$") ~ "regular_water",
      str_detect(treatment, "S$")~ "sucrose_water",
      str_detect(treatment, "W$")~ "regular_water",
      TRUE ~ "Unknown"
    ),
    # Ensure the treatments are ordered correctly for the plot layout.
    antibiotic_treatment = factor(antibiotic_treatment, levels = c("PBS", "biapenem")),
    diet_treatment = factor(diet_treatment, levels = c("regular_water", "sucrose_water"))
  ) %>%
  # Create a single grouping variable for the x-axis by combining the treatment and day information.
  mutate(
    plot_group = paste(antibiotic_treatment, diet_treatment, day, sep = "_"),
    # Create a unique ID for each mouse's trajectory within its specific treatment group.
    trajectory_group = paste(experiment_no, antibiotic_treatment, diet_treatment, mouse_identifier, sep = "_")
  ) %>% 
  # Convert the new grouping variable to a factor and set the levels to enforce the desired plot order.
  mutate(
    plot_group = factor(plot_group, levels = c(
      "PBS_regular_water_1", "PBS_regular_water_3", "PBS_regular_water_6",
      "PBS_sucrose_water_1", "PBS_sucrose_water_3", "PBS_sucrose_water_6",
      "biapenem_regular_water_1", "biapenem_regular_water_3", "biapenem_regular_water_6",
      "biapenem_sucrose_water_1", "biapenem_sucrose_water_3", "biapenem_sucrose_water_6"
    ))
  ) %>%
  mutate(
    experiment_no = factor(experiment_no)
  )

# tally of the data points
processed_weights_tally <- processed_weights %>% 
  filter(day == 1) %>% 
  count(experiment_no, diet_treatment, antibiotic_treatment) 
```

## weight longitudinal

```{r}
# # Create the plot.
# ggplot(processed_weights, aes(x = plot_group, y = mice_weights)) +
#   # Add the boxplots. The 'outlier.shape = NA' hides the default outlier points
#   # since we'll be plotting all points ourselves.
#   geom_boxplot(outlier.shape = NA) +
#   # Add the individual data points as jittered shapes.
#   # 'shape' is mapped to the experiment number.
#   # 'alpha' adds some transparency to see overlapping points.
#   geom_jitter(aes(color = diet_treatment), width = 0.2, alpha = 0.8, size = 2) + 
#   
#   # Manually set the colors to match the publication figure (gray for vehicle, pink for sucrose).
#   scale_color_manual(values = c("regular_water" = "gray40", "sucrose_water" = "red")) +
#   # Create separate panels for each treatment group defined in 'plot_group'.
#   #facet_wrap(~plot_group) +
#   # Add informative labels and a title.
#   labs(
#     title = "Mice Weight by Treatment and Day",
#     x = "Day",
#     y = "Mice Weight (g)",
#     shape = "Experiment No."
#   ) +
#   # Use a clean, black-and-white theme for clarity.
#   theme_bw() +
#   # Improve the readability of the theme.
#   theme(
#     strip.text = element_text(size = 10, face = "bold"),
#     axis.title = element_text(size = 12),
#     axis.text.x = element_text(size = 10, vjust = 0, angle = 90), # Adjust position of day numbers
#     plot.title = element_text(hjust = 0.5, size = 14, face = "bold")
#   )
# ggsave('../data/R31_few_weight_timeline.jpg', width = 7, height = 7)
```

```{r}

# Step 1: Prepare the data.
analysis_data <- processed_weights %>%
  # Focus only on the antibiotic-treated group.
  filter(antibiotic_treatment == 'biapenem') %>%
  # It's good practice to arrange by mouse and day.
  mutate(mouse_identifier = str_glue('{experiment_no}__{mouse_identifier}')) %>%  
  arrange(mouse_identifier, day) %>%
  # For each mouse, calculate weight gain relative to their Day 1 weight.
  group_by(mouse_identifier) %>%
  mutate(
    weight_change = mice_weights - first(mice_weights)
  ) %>%
  ungroup()

# Step 2: Build and run the Linear Mixed-Effects Model.
# We are modeling weight_change as a function of our main predictor (log_cfu),
# while controlling for the effects of day and diet.
# The (1 | mouse_identifier) term tells the model that measurements are
# nested within each mouse, which is the key to handling repeated measures.
model <- lmer(
  weight_change ~ diet_treatment + day + (1 | mouse_identifier) + (1 | experiment_no),
  data = analysis_data
)

# Step 3: Interpret the results.
summary(model)
```

```{r}
analysis_data_4 <- processed_weights %>%
  # It's good practice to arrange by mouse and day.
  mutate(mouse_identifier = str_glue('{experiment_no}__{mouse_identifier}')) %>%  
  arrange(mouse_identifier, day) %>%
  # For each mouse, calculate weight gain relative to their Day 1 weight.
  group_by(mouse_identifier) %>%
  mutate(
    weight_change = mice_weights - first(mice_weights)
  ) %>%
  ungroup()

interaction_model <- lmer(
  weight_change ~ antibiotic_treatment * diet_treatment + day +
                (1 | mouse_identifier) + (1 | experiment_no),
  data = analysis_data_4
)

# Get the summary of the model to see the results.
summary(interaction_model)
#  There is no significant interaction. The effect of the sucrose diet on weight gain is not statistically different between the antibiotic-treated group and the PBS-treated group.
# maybe it is because they gained back the weight by day 6, what if I only test up until day 3

```
```{r}
ggplot(processed_weights %>% filter(day < 6), aes(x = plot_group, y = mice_weights)) +
  # Add the boxplots. The 'outlier.shape = NA' hides the default outlier points
  # since we'll be plotting all points ourselves.
  geom_boxplot(outlier.shape = NA) +
  # Add the individual data points as jittered shapes.
  # 'shape' is mapped to the experiment number.
  # 'alpha' adds some transparency to see overlapping points.
  geom_jitter(aes(color = diet_treatment), width = 0.2, alpha = 0.8, size = 2) + 
  
  # Manually set the colors to match the publication figure (gray for vehicle, pink for sucrose).
  scale_color_manual(values = c("regular_water" = "gray40", "sucrose_water" = "red")) +
  # Create separate panels for each treatment group defined in 'plot_group'.
  #facet_wrap(~plot_group) +
  # Add informative labels and a title.
  labs(
    title = "Mice Weight by Treatment and Day",
    x = "Day",
    y = "Mice Weight (g)",
    shape = "Experiment No."
  ) +
  # Use a clean, black-and-white theme for clarity.
  theme_bw() +
  # Improve the readability of the theme.
  theme(
    strip.text = element_text(size = 10, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(size = 10, vjust = 0, angle = 90), # Adjust position of day numbers
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold")
  )
ggsave('../data/R31_few_weight_timeline_to_day3.jpg', width = 7, height = 7)
```
```{r}
analysis_data_4_to_day3 <- processed_weights %>%
   filter(day < 6) %>% 
  # It's good practice to arrange by mouse and day.
  mutate(mouse_identifier = str_glue('{experiment_no}__{mouse_identifier}')) %>%  
  arrange(mouse_identifier, day) %>%
  # For each mouse, calculate weight gain relative to their Day 1 weight.
  group_by(mouse_identifier) %>%
  mutate(
    weight_gain = mice_weights - first(mice_weights)
  ) %>%
  ungroup()

interaction_model_to_day3 <- lmer(
  weight_gain ~ antibiotic_treatment * diet_treatment + day +
                (1 | mouse_identifier) + (1 | experiment_no),
  data = analysis_data_4_to_day3
)

# Get the summary of the model to see the results.
summary(interaction_model_to_day3)
```

## test the logCFU cor with the weight change

```{r}
merged_data <- analysis_data %>% filter(!is.na(log10_cf_us_per_gram_stool)) %>% relocate(weight_change, .after = 'mice_weights') 
  
# plot the weight gain on each day of stool collection of those mice in those experiments
ggplot(merged_data, aes(x = plot_group, y = weight_change)) +
  geom_hline(yintercept = c(0), color = "black", linetype = "dashed", size = 2) +
  # Add the boxplots. The 'outlier.shape = NA' hides the default outlier points
  # since we'll be plotting all points ourselves.
  geom_boxplot(outlier.shape = NA) +
  # Add the individual data points as jittered shapes.
  # 'shape' is mapped to the experiment number.
  # 'alpha' adds some transparency to see overlapping points.
  geom_jitter(aes(color = diet_treatment, shape = experiment_no), width = 0.2, alpha = 0.8, size = 2) + 
  
  # Manually set the colors to match the publication figure (gray for vehicle, pink for sucrose).
  scale_color_manual(values = c("regular_water" = "gray40", "sucrose_water" = "red")) +
  
  # Add informative labels and a title.
  labs(
    title = "Mice Weight change by Treatment and Day",
    x = "Day",
    y = "Mice Weight change(g)"
  ) +
  # Use a clean, black-and-white theme for clarity.
  theme_bw() +
  # Improve the readability of the theme.
  theme(
    strip.text = element_text(size = 10, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(size = 10, vjust = 0, angle = 90), # Adjust position of day numbers
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold")
  )
ggsave('../data/R31_weight_change.jpg', width = 8, height = 7)
```


```{r}
# what if I just test whether log cfu is associated with weight loss
model <- lmer(
  weight_change ~ log10_cf_us_per_gram_stool + day + diet_treatment + (1 | mouse_identifier) + (1 | experiment_no),
  data = merged_data
)

# Step 3: Interpret the results.
summary(model)
 
# This negative number means that for every 1-log increase in CFU, the mice's weight gain decreased by about 0.09 grams. 
```

```{r}
plot_data <- merged_data %>%
  # Filter to include only Day 3 and Day 6
  filter(day %in% c(3, 6)) %>%
  # Create a clearer diet_treatment column for the legend
  mutate(
    # Make 'day' a factor to get nice facet labels like "Day 3"
    day = factor(paste("Day", day))
  )

# Create the scatter plot
ggplot(plot_data, aes(x = log10_cf_us_per_gram_stool, y = weight_change, color = diet_treatment)) +
  # Add the scatter plot points
  geom_point(alpha = 0.8, size = 2.5) +
  # Add the linear regression line for each diet group
  geom_smooth(method = "lm", se = T) +
  # Create separate panels for Day 3 and Day 6
  facet_wrap(~day) +
  # Use a nice color scheme
  scale_color_manual(values = c("regular_water" = "gray40", "sucrose_water" = "red")) +
  # Add informative labels and a title
  labs(
    title = "Weight Change vs. Bacterial Load by Diet",
    x = "Log10 CFU per Gram Stool",
    y = "Weight Change (g)",
    color = "Diet Treatment"
  ) +
  # Use a clean, professional theme
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    strip.text = element_text(face = "bold")
  )
# when I break this down my day I reduce power and now the confidence interval band is wide 
```

# Original weight and catogorize time   

since weight is not having linear change vs time

```{r}
weight_data <- processed_weights %>%
  filter(antibiotic_treatment == 'biapenem') %>%
  #filter(!is.na(log10_cf_us_per_gram_stool)) %>%
  mutate(mouse_identifier = str_glue('{experiment_no}__{mouse_identifier}'))
```


```{r}
# weight_data1 <- weight_data %>%  
#   # For each mouse...
#   group_by(mouse_identifier) %>%
#   # Create a new column with the Day 1 weight for that mouse
#   mutate(baseline_weight = first(mice_weights[day == 1])) %>%
#   ungroup() %>%
#   # Now, filter out the Day 1 data so we only model post-treatment effects
#   filter(day > 1) %>% 
#   mutate(day = str_glue('day{day}'),
#          day = factor(day, levels = c('day3','day6')))
# 
# # the question: "Does the relationship between bacterial load and weight depend on the diet?" yes def
# weight_model1 <- lmer(
#   mice_weights ~ baseline_weight + log10_cf_us_per_gram_stool * diet_treatment + day + (1 | mouse_identifier) + (1 | experiment_no),
#   data = weight_data1
# )
# 
# # Step 3: Interpret the results.
# summary(weight_model1)
# # For the Regular Water group: A 10-fold increase in CFU is associated with a -0.22g change in weight.
# 
# # For the Sucrose Water group: A 10-fold increase in CFU is associated with only a -0.047g change in weight.
# # 
# # The interaction's significance confirms that this difference between -0.22 and -0.047 is statistically real.
# # the above model has the day 3 has the reference level which is pretty weird
```

### raw weights all of the data 

```{r}
# using all of the mice even the mice that died before the day 6
weight_data2 <- weight_data %>%
  mutate(day = str_glue('{day}'),
         day = factor(day, levels = c('1','3','6')),
         diet_treatment = factor(as.character(diet_treatment), levels = c('regular_water','sucrose_water')))
# 
# # the question: "Does the relationship between bacterial load and weight depend on the diet?" yes def
# weight_model2 <- lmer(
#   mice_weights ~ log10_cf_us_per_gram_stool * diet_treatment + day + (1 | mouse_identifier) + (1 | experiment_no),
#   data = weight_data2
# )
#  
# # Step 3: Interpret the results.
# summary(weight_model2)
# 
# # even if I switch the factor levels of sucrose water and regular water and the log CFU is still significant 
```

```{r}
weight_data2_ancova <- weight_data2 %>%
  # Group by each individual mouse to operate on their specific data
  group_by(experiment_no, mouse_identifier) %>%
  # Make sure the data is sorted by day to correctly identify the baseline
  arrange(day, .by_group = TRUE) %>%
  # Create a new 'baseline_weight' column.
  # 'first(mice_weights)' grabs the weight from the first time point (Day 1)
  # and applies it to all rows for that mouse.
  mutate(baseline_weight = first(mice_weights)) %>%
  ungroup() %>%
  # Now, filter out the baseline day itself. The model should only learn
  # from what happened *after* the treatment started.
  filter(day != '1')

# --- Model Fitting ---
# Now, run the linear mixed-effects model using the prepared data.
ancova_model_gram_weights <- lmer(
  # The outcome is the raw mouse weight at post-treatment time points.
  # 'baseline_weight' is included as a key predictor to control for starting weight.
  mice_weights ~ baseline_weight + log10_cf_us_per_gram_stool * diet_treatment +
                 day + (1 | mouse_identifier) + (1 | experiment_no),
  data = weight_data2_ancova
)

# --- View the Results ---
# The summary will show the effects of your treatments after adjusting for
# the starting weight of each mouse.
summary(ancova_model_gram_weights)
```

### scatter prediction

```{r}
# make the ggpredict scatter plot 
predicted_effects_ancova <- ggpredict(ancova_model_gram_weights, terms = c("log10_cf_us_per_gram_stool", "diet_treatment"))

# Now, plot these predictions
scatter_predicted_effects_ancova <- ggplot(predicted_effects_ancova, aes(x = x, y = predicted, color = group)) +
  # Plot the predicted trend line
  geom_line(linewidth = 1) +
  # Add the confidence interval ribbon from the model
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  # Add the original raw data points in the background for context
  geom_point(
    data = weight_data2_ancova,
    aes(x = log10_cf_us_per_gram_stool, y = mice_weights, color = diet_treatment),
    alpha = 0.5,
    inherit.aes = FALSE # Tells the points not to inherit the main aes
  ) +
  scale_color_manual(values = color_palette) +
  scale_fill_manual(values = color_palette) +
  labs(
    #title = "Model-Predicted Effect of Bacterial Load on Mouse Weight by Diet",
    x = "Log10( CFU per Gram Stool)",
    y = "Predicted Mouse Weight (g)",
    color = "Diet Treatment",
    fill = "Diet Treatment"
  ) + 
  coord_fixed() +
  theme_bw() +
  theme(legend.position = 'bottom', plot.title = element_blank(),
        plot.margin = margin(t = 5, r = 5, b = 5, l = 5, unit = "pt"))
scatter_predicted_effects_ancova
```


```{r}
# # what if I remove all of the mice have died before day 6
# weight_data3 <- weight_data2 %>%
#   group_by( mouse_identifier) %>%
#   filter(n() == 3) %>%
#   ungroup()
#  
# weight_model3 <- lmer(
#   mice_weights ~ log10_cf_us_per_gram_stool * diet_treatment + day + (1 | mouse_identifier) + (1 | experiment_no),
#   data = weight_data3
# )
# 
# # Step 3: Interpret the results.
# summary(weight_model3)

```

```{r}
# this is a crude visualization , the lm line is not accurate since each mouse has two data points here 
# # Create the plot to visualize the interaction
# ggplot(weight_data, aes(x = log10_cf_us_per_gram_stool, y = mice_weights, color = diet_treatment)) +
#   # Add the individual data points with some transparency
#   geom_point(alpha = 0.7, size = 2) +
#   scale_color_manual(values = c("regular_water" = "gray40", "sucrose_water" = "red")) +
#   # This is the key: it draws a separate linear regression line for each color/group
#   geom_smooth(method = "lm", se = TRUE) +
#   # Add clear labels that explain the plot
#   labs(
#     title = "Interaction of Diet and Bacterial Load on Mouse Weight",
#     subtitle = 'points represent mouse weight on day 3 and day 6',
#     x = "Log10 CFU per Gram Stool",
#     y = "Mouse Weight (g)",
#     color = "Diet Treatment"
#   ) +
#   # Use a clean theme
#   theme_bw() +
#   theme(
#     plot.title = element_text(hjust = 0.5, face = "bold"),
#     legend.position = "bottom"
#   )
```

### timeline raw weights

```{r}

# Define the new color palette for the groups
color_palette <- c(

  "regular_water" = "gray32",
  "sucrose_water" = "deeppink2"
)

# a plot where the mouse weight are on the y, the day are on the x , and each mouse trajectory of weight on thin lines across the days, plot a point for each day's median, and a interval brackets and line that covers fr the 25% and 75% percentile , do this as the two facets , regular water and sucrose water. 
timeline <- ggplot(weight_data2, aes(x = day, y = mice_weights)) +
  
  # 1. Plot individual mouse trajectories as thin, semi-transparent lines.
  # The 'group' aesthetic is essential to tell ggplot to draw a separate line for each mouse.
  geom_line(aes(group = mouse_identifier), color = "grey70", alpha = 0.4, linewidth = 0.5) +
  
 stat_summary(
    aes(color = diet_treatment), 
    fun.data = "median_hilow", 
    fun.args = list(conf.int = 0.5), # This is a shortcut for 25th-75th percentile
    geom = "errorbar",
    width = 0.2,
    linewidth = 1
  ) +

  # Calculate and plot a line connecting the medians.
  stat_summary(
    aes(color = diet_treatment, group = diet_treatment),
    fun = median,
    geom = "line",
    linewidth = 0.9
  ) +
  
  # Calculate and plot the median as a point.
  stat_summary(
    aes(color = diet_treatment),
    fun = median,
    geom = "point",
    size = 2
  ) +
  scale_color_manual(values = color_palette) +
  # 4. Split the plot into two panels based on the diet treatment.
  facet_wrap(~diet_treatment) +
  
  # Add informative labels and a clean theme.
  labs(
    caption = "Antibiotics treated mice",
    x = "Day",
    y = "Mouse Weight (g)"
  ) +
  theme_bw()+ theme(legend.position = 'top', 
        plot.margin = margin(t = 5, r = 5, b = 5, l = 5, unit = "pt"))

timeline
```


```{r}
# # Use ggpredict() to get the predicted values from your model.
# # This calculates the predicted mouse weight across a range of CFU values
# # for each diet treatment, averaging over the effect of 'day'.
# predicted_effects <- ggpredict(weight_model2, terms = c("log10_cf_us_per_gram_stool", "diet_treatment"))
# 
# # Now, plot these predictions
# scatter <- ggplot(predicted_effects, aes(x = x, y = predicted, color = group)) +
#   # Plot the predicted trend line
#   geom_line(linewidth = 1) +
#   # Add the confidence interval ribbon from the model
#   geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
#   # Add the original raw data points in the background for context
#   geom_point(
#     data = weight_data2,
#     aes(x = log10_cf_us_per_gram_stool, y = mice_weights, color = diet_treatment),
#     alpha = 0.5,
#     inherit.aes = FALSE # Tells the points not to inherit the main aes
#   ) +
#   scale_color_manual(values = color_palette) +
#   scale_fill_manual(values = color_palette) +
#   labs(
#     #title = "Model-Predicted Effect of Bacterial Load on Mouse Weight by Diet",
#     x = "Log10( CFU per Gram Stool)",
#     y = "Predicted Mouse Weight (g)",
#     color = "Diet Treatment",
#     fill = "Diet Treatment"
#   ) + 
#   coord_fixed() +
#   theme_bw() +
#   theme(legend.position = 'bottom', plot.title = element_blank(),
#         plot.margin = margin(t = 5, r = 5, b = 5, l = 5, unit = "pt"))
# scatter
```

### timeline % change

```{r}
# for the weights:
# replot timecourses & analyze as fold-change (or percent) from baseline (happy to discuss the merits with Teng as well)

# 1. Prepare the data by calculating percent change from baseline
plot_data_percent <- processed_weights %>%
  filter(antibiotic_treatment == 'biapenem') %>% 
  mutate(mouse_identifier = str_glue('{experiment_no}__{mouse_identifier}'), day = factor(day)) %>% 
  # Make sure data is ordered correctly to find the first day's weight
  arrange(experiment_no, mouse_identifier, day) %>%
  # Group by each unique mouse
  group_by(experiment_no, mouse_identifier) %>%
  # Calculate percent change relative to the first measurement
  mutate(
    baseline_weight = first(mice_weights),
    percent_change = ((mice_weights - baseline_weight) / baseline_weight) * 100
  ) %>%
  ungroup() 

# 2. Create the plot
timeline_percent <- ggplot(plot_data_percent, aes(x = day, y = percent_change)) +
  
  # Add a horizontal dashed line at y=0 to represent the baseline
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  
  # Plot individual mouse trajectories as thin, semi-transparent lines
  geom_line(aes(group = mouse_identifier), color = "grey70", alpha = 0.6) +
  
 stat_summary(
    aes(color = diet_treatment), 
    fun.data = "median_hilow", 
    fun.args = list(conf.int = 0.5), # This is a shortcut for 25th-75th percentile
    geom = "errorbar",
    width = 0.2,
    linewidth = 1
  ) +
  
 # Calculate and plot a line connecting the medians.
  stat_summary(
    aes(color = diet_treatment, group = diet_treatment),
    fun = median,
    geom = "line",
    linewidth = 0.9
  ) +
  
  # Calculate and plot the median as a point.
  stat_summary(
    aes(color = diet_treatment),
    fun = median,
    geom = "point",
    size = 2
  ) +
  scale_color_manual(values = color_palette) +
  # 4. Split the plot into two panels based on the diet treatment.
  facet_wrap(~diet_treatment) +
  # Add informative labels and a clean theme
  labs(
    #title = "Mouse Weight Percent Change from Baseline by Diet",
    x = "Day",
    y = "Weight Change from Baseline (%)"
  ) +
  theme_bw() + theme(legend.position = 'none')

timeline_percent
```


```{r}
# I'm curious if there is a simple difference at day 3 or day 6 just with plain old wilcox tests.  (which I understand would not address repeated measures and would not address the deaths and would not address the two separate experiments).  I suspect there will not be
# 2. Perform Wilcoxon tests for Raw Mouse Weights
weights_test_results <- plot_data_percent %>%
  filter(day %in% c(3, 6)) %>% # Focus only on days 3 and 6
  group_by(day) %>%            # Perform a separate test for each day
  wilcox_test(mice_weights ~ diet_treatment) %>%
  add_significance()

# 3. Perform Wilcoxon tests for Percent Change
percent_change_test_results <- plot_data_percent %>%
  filter(day %in% c(3, 6)) %>%
  group_by(day) %>%
  wilcox_test(percent_change ~ diet_treatment) %>%
  add_significance()

# 4. View the results
print("Wilcoxon Test Results for Raw Mouse Weights")
print(weights_test_results)

print("--------------------------------------------------")

print("Wilcoxon Test Results for Percent Change from Baseline")
print(percent_change_test_results)
```

### per% change model

```{r}
# do the model between the CFU and the % change
percent_change_model <- lmer(
  percent_change ~ log10_cf_us_per_gram_stool * diet_treatment +
                   day + (1 | mouse_identifier) + (1 | experiment_no),
  data = plot_data_percent %>% filter(day != '1')
)

#summary(percent_change_model)

predicted_effects_percent <- ggpredict(percent_change_model, terms = c("log10_cf_us_per_gram_stool", "diet_treatment"))

# Now, create a custom plot using ggplot2 for full control over the aesthetics.
predicted_effects_percent_plot <- ggplot(predicted_effects_percent, aes(x = x, y = predicted, color = group)) +
  
  # Add the original raw data points in the background for context.
  # These points come from the original dataset used to fit the model.
  geom_point(
    data = plot_data_percent, # Use the original data here
    aes(x = log10_cf_us_per_gram_stool, y = percent_change, color = diet_treatment),
    alpha = 0.4, # Make points semi-transparent
    inherit.aes = FALSE # Prevents this layer from inheriting the main aesthetics
  ) +
  
  # Plot the predicted trend line from the model.
  geom_line(linewidth = 1) +
  
  # Add a ribbon for the confidence interval around the predicted line.
  geom_ribbon(
    aes(ymin = conf.low, ymax = conf.high, fill = group), 
    alpha = 0.2, # Make the ribbon semi-transparent
    color = NA   # Remove the outline from the ribbon
  ) +
  scale_color_manual(values = color_palette) +
  scale_fill_manual(values = color_palette) +
  
  # Add a horizontal line at y=0 to represent the baseline.
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +

  # Add clear labels and a title.
  labs(
    #title = "Model-Predicted Effect of Bacterial Load on Percent Weight Change",
    x = "Log10 CFU per Gram Stool",
    y = "Predicted Weight Change from Baseline (%)",
    color = "Diet Treatment",
    fill = "Diet Treatment"
  ) +
  
  # Use a clean theme for a professional look.
  theme_bw() + theme( legend.position = 'top')

predicted_effects_percent_plot
```

## assemble 

### mice tally

```{r}
# add a table to show how many mice included
# weight_data2 %>% filter(day  == '1') %>% count(experiment_no, diet_treatment) %>% 
#   spread('diet_treatment','n') %>% 
#   #mutate(experiment_no = seq(1, nrow(.)), experiment_no= str_glue('Experiment_{experiment_no}') ) %>% 
#   gt()  %>% 
#   gt::gtsave(filename = "../data/R31_mice_tally.png") 
```


```{r}
# please remove panel a. I think the scatterplot should convey whether it is day 3 or day 6, perhaps with shapes
weight_plot <-  plot_grid(timeline,
                          timeline_percent,
                          predicted_effects_percent_plot,
                 label_size = 12, ncol  = 2,
                labels = "auto", 
                align = 'vh', axis = 'lrtb')

title <- ggdraw() + 
  draw_label("Supplemental Fig X",fontface = 'bold',x = 0,hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 0))

combined <- plot_grid(
  title, weight_plot,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
) +theme(plot.margin = unit(c(1,1,1,1), "cm"))

ggsave('../data/R31_mice_weight_reduction.pdf',
      width = 8.5, height = 11, units = "in", device = 'pdf', 
      dpi = 300)  
```

