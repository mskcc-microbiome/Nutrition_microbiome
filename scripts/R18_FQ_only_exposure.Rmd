---
title: "FQ battel"
output: html_document
date: "2025-01-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(brms)   
library(ggpubr)
library(tidybayes)
library(cowplot)
library(brmstools)
library(bayesplot)
rstan::rstan_options(auto_write = TRUE)
theme_set(theme_tidybayes() + panel_border())
```


```{r}
library(vdbR)
connect_database()
list_table_from_database('mmf')
get_table_from_database('samples_mmf')
```

```{r}
med <- read_csv('../data/191_medication_cleaned_all_with_type.csv') %>% distinct(sampleid, med_exposure_type)

fq_exposed <- med %>% filter(med_exposure_type =='fluoroquinolones') %>% pull(sampleid)

fg_and_other <- med %>% filter(med_exposure_type =='fluoroquinolones' | med_exposure_type == 'other_antibacterial') %>% pull(sampleid)
```

# with interaction and abx in three levels: no abx, FQ only and broad-spectrum

## diversity

```{r}
# to put the other antibacterial into the FQ group
      
meta <- read_csv('../data/153_combined_META.csv') %>% 
  mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(pid = factor(pid)) %>% 
  mutate(fg_egg = fg_egg/100,
         fg_fruit = fg_fruit/100,
         fg_grain = fg_grain/100,
         fg_legume = fg_legume/100,
         fg_meat = fg_meat/100,
         fg_milk = fg_milk/100,
         fg_oils = fg_oils/100,
         fg_sweets = fg_sweets/100,
         fg_veggie = fg_veggie/100) %>% 
  full_join(exposures) %>% 
  filter(exposure_category %in% c('no_abx','fluoroquinolones')) %>% 
  mutate(abx = if_else(exposure_category == 'no_abx', '0_no_abx', '1_FQ'),abx = factor(abx)) %>% 
  #mutate(abx = if_else(empirical == 'TRUE', '2_broad', if_else(sampleid %in% fg_and_other, '1_fq_and_other','0_no_abx')),abx = factor(abx)) %>% 
  mutate(TPN = if_else(TPN == 'TRUE', 1, 0),
         EN = if_else(EN == 'TRUE', 1, 0)) 

num_annot <- meta %>% 
  split(.$abx) %>% 
  imap_dfr(function(df, name_) {
    df %>% distinct(pid) %>% nrow
  }) %>% gather('abx','pt_num') %>% 
  full_join(meta %>% count(abx) %>% mutate(abx = as.character(abx))) %>% 
  rename(sample_num = n) %>% 
  #mutate(antibiotics = if_else(empirical == 'FALSE', 'not exposed', 'exposed')) %>% 
  mutate(lbl = str_glue('{sample_num} samples\nfrom {pt_num} patients'))
```
 
```{r}
mod_original <- log(simpson_reciprocal) ~ 0 +        
                intensity+
                abx+
               fg_fruit:abx+
                fg_meat:abx+
                fg_milk:abx+
                fg_oils:abx+
                fg_egg:abx+
                fg_grain:abx+
                fg_sweets:abx+
                fg_legume:abx+
                fg_veggie:abx+
                TPN+
                EN+
               (1 | pid) +
                (1 | timebin)
get_prior(mod_original,data = meta )
```

```{r}
div_priors_original <- c(# for the food group variables 
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_egg"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_fruit"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_grain"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_legume"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_meat"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_milk"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_oils"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_sweets"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_veggie"),
            # interaction terms
            prior(normal(0, 1), class = 'b', coef = "abx1_fq_and_other:fg_egg"),
            prior(normal(0, 1), class = 'b', coef = "abx1_fq_and_other:fg_fruit"),
            prior(normal(0, 1), class = 'b', coef = "abx1_fq_and_other:fg_grain"),
            prior(normal(0, 1), class = 'b', coef = "abx1_fq_and_other:fg_legume"),
            prior(normal(0, 1), class = 'b', coef = "abx1_fq_and_other:fg_meat"),
            prior(normal(0, 1), class = 'b', coef = "abx1_fq_and_other:fg_milk"),
            prior(normal(0, 1), class = 'b', coef = "abx1_fq_and_other:fg_oils"),
            prior(normal(0, 1), class = 'b', coef = "abx1_fq_and_other:fg_sweets"),
            prior(normal(0, 1), class = 'b', coef = "abx1_fq_and_other:fg_veggie"),
                      # interaction terms
            prior(normal(0, 1), class = 'b', coef = "abx2_broad:fg_egg"),
            prior(normal(0, 1), class = 'b', coef = "abx2_broad:fg_fruit"),
            prior(normal(0, 1), class = 'b', coef = "abx2_broad:fg_grain"),
            prior(normal(0, 1), class = 'b', coef = "abx2_broad:fg_legume"),
            prior(normal(0, 1), class = 'b', coef = "abx2_broad:fg_meat"),
            prior(normal(0, 1), class = 'b', coef = "abx2_broad:fg_milk"),
            prior(normal(0, 1), class = 'b', coef = "abx2_broad:fg_oils"),
            prior(normal(0, 1), class = 'b', coef = "abx2_broad:fg_sweets"),
            prior(normal(0, 1), class = 'b', coef = "abx2_broad:fg_veggie"),
            # for the TPN
            prior(normal(0, 0.1), class = 'b', coef = "TPN"),
            # for the EN
            prior(normal(0, 0.1), class = 'b', coef = "EN"),
            # for the empirical
            prior(normal(0, 0.5), class = 'b', coef = "abx1_fq_and_other"),
            prior(normal(0, 0.5), class = 'b', coef = "abx2_broad"),
            # for the intensity
            prior(normal( 2, .1), class = 'b', coef = "intensityablative"),
            prior(normal( 2, .1), class = 'b', coef = "intensityreduced"),
            prior(normal( 2, .1), class = 'b', coef = "intensitynonablative")
            )

model_div_original <- brm( mod_original,  
              data = meta, 
              warmup = 1000, iter = 3000, 
              prior = div_priors_original,
              cores = ncores, 
              chains = 2, 
               control = list(adapt_delta = 0.99),
              seed = 123, sample_prior = T)

# save it for future use
post_res <- suppressWarnings(posterior_samples(model_div_original)) 
post_res %>%  write_csv('../data/18_model_div_original_three_abx_levels.csv')


```

```{r}
post_res %>% 
  select(starts_with('b')) %>% 
  select(!contains('intensity')) %>% 
  gather('shortname','coeff') %>% 
  group_by(shortname) %>% # Group by shortname to calculate medians per group
  mutate(median_coeff = median(coeff)) %>% # Calculate median for each shortname
  ungroup() %>% # Important to ungroup after calculating the median
  mutate(shortname = fct_reorder(shortname, median_coeff)) %>% 
  group_by(shortname) %>% # Group again to get intervals
  mutate(
    lower = quantile(coeff, 0.025), # Calculate lower bound of the interval
    upper = quantile(coeff, 0.975), # Calculate upper bound of the interval
    significant = ifelse(lower > 0 | upper < 0, "Significant", "Not Significant")
  ) %>%
  ungroup() %>%
  ggplot() +
    stat_pointinterval(
      aes(x = coeff, y = shortname, color = significant), # Color by significance
      .width = .95,
      fatten_point = 1.2
    ) +
    geom_vline(xintercept = 0, col = 'blue', size = 0.5) +
    scale_color_manual(values = c("Significant" = "red", "Not Significant" = "black")) + # Set colors
    labs(x = "Coefficient", y = "Shortname", color = "95% CI") + # Improved labels
    theme_bw()
ggsave('../data/18_three_abx.pdf', width = 7)
```
```{r}
library(wesanderson) 

dat_conditional <- conditional_effects(model_div_original, surface = T)

condi_dat <- dat_conditional %>% 
  keep(.p = str_detect(names(.), ':')) %>% 
  bind_rows(.id = 'grp')
```


```{r}
key <- read_csv('../data/food_group_color_key_final.csv', col_types = 'ccccc')
conditional <- condi_dat %>% 
  mutate(grp = str_replace(grp, '\\:empirical','')) %>% 
  left_join(key %>% select(grp = fg1_name, shortname)) %>% 
  mutate(shortname = factor(shortname, levels = rev( c('Vegetables',
                 'Oils',
                 'Fruits',
                 'Meats',
                 'Legumes',
                 'Eggs',
                 'Milk',
                 'Grains',
                 'Sweets'))))
palette <- wes_palette("Royal1", 4)[c(1,2,4)]
# the color for the strip background
strip_color <- wes_palette("Royal1", 3)[3]

conditional9 <- conditional %>%   
  ggplot() +
  geom_smooth(aes(x = effect1__, y = estimate__, ymin = lower__, ymax = upper__, fill = effect2__, color = effect2__),
              stat = "identity",
              alpha = .3, linewidth = 1.5)+ 
  scale_fill_manual('antibiotics', values = palette) +
  scale_colour_manual('antibiotics', values = palette) +
  facet_wrap(~ shortname, nrow = 2, scales = 'free_x') +
  ylim(0, 3.3) +
  labs(y = 'Predicted log(diversity)', x = 'Food group consumed (grams)') +
  theme_classic() +
  theme(legend.position = 'bottom', legend.title = element_text(size = 8, face="bold"),
        legend.text = element_text( size=8, face="bold"),
        panel.background = element_rect(fill = "#FAEFD140"),
        legend.background=element_rect(fill = alpha("white", 0)),
       legend.key=element_rect(fill = alpha("white", 0)),
        aspect.ratio = 1/1.5, 
        strip.background = element_rect(color="white", fill='#ffecdc', size=1.5,linetype="solid"),
     axis.text=element_text(size=8), axis.title=element_text(size=10))    +
  guides(fill = guide_legend(direction = "vertical"), color = guide_legend(direction = "vertical"))
conditional9
```

## Enterococcus with three levels of abx

```{r}
# clr_res <- read_csv('../data/171_genus_CLR_res.csv')
# clr_Enterococcus <- clr_res %>% 
#   filter(genus %in% c('Enterococcus')) %>%
#   spread('genus','clr')
# 
# meta <- read_csv('../data/153_combined_META.csv') %>% 
#   mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>% 
#   mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
#   mutate(pid = factor(pid)) %>% 
#   inner_join(clr_Enterococcus)%>% 
#   mutate(empirical = if_else(empirical == 'TRUE', '2_broad', if_else(sampleid %in% fg_and_other, '1_fq_and_other','0_no_abx')),
#          empirical = factor(empirical)) 
# 
# entero_model_original <- Enterococcus ~ 0 +
#              intensity+
#                 empirical+
#                fg_fruit:empirical+
#                 fg_meat:empirical+
#                 fg_milk:empirical+
#                 fg_oils:empirical+
#                 fg_egg:empirical+
#                 fg_grain:empirical+
#                 fg_sweets:empirical+
#                 fg_legume:empirical+
#                 fg_veggie:empirical+
#                 TPN+
#                 EN+
#                (1 | pid) +
#                 (1 | timebin)
# get_prior(formula = entero_model_original, data = meta)
```

```{r}
# priors_enterococcus_original <- c(# for the food group variables
#          prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_egg"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_fruit"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_grain"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_legume"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_meat"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_milk"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_oils"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_sweets"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_veggie"),
#             # interaction terms
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_egg"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_fruit"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_grain"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_legume"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_meat"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_milk"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_oils"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_sweets"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_veggie"),
#                       # interaction terms
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_egg"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_fruit"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_grain"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_legume"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_meat"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_milk"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_oils"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_sweets"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_veggie"),
#             # for the TPN
#             prior(normal(0, 0.1), class = 'b', coef = "TPNTRUE"),
#             # for the EN
#             prior(normal(0, 0.1), class = 'b', coef = "ENTRUE"),
#             # for the empirical
#             prior(normal(0, 0.5), class = 'b', coef = "empirical1_fq_and_other"),
#             prior(normal(0, 0.5), class = 'b', coef = "empirical2_broad")
#             
#             )
# 
# mod_entero =  brm(entero_model_original,  
#                 data = meta, 
#               warmup = 1000, iter = 3000, 
#               prior = priors_enterococcus_original,
#               cores = ncores, 
#               chains = 2, 
#               control = list(adapt_delta = 0.99),
#               seed = 456)
# 
# post_res <- suppressWarnings(posterior_samples(mod_entero)) 
# 
# post_res %>% 
#   select(starts_with('b')) %>% 
#   select(!contains('intensity')) %>% 
#   gather('shortname','coeff') %>% 
#   #filter(!shortname %in% c('b_empirical2_broad','b_empirical1_fq_and_other', 'b_ENTRUE', 'b_TPNTRUE')) %>% 
#   group_by(shortname) %>% # Group by shortname to calculate medians per group
#   mutate(median_coeff = median(coeff)) %>% # Calculate median for each shortname
#   ungroup() %>% # Important to ungroup after calculating the median
#   mutate(shortname = fct_reorder(shortname, median_coeff)) %>% 
#   group_by(shortname) %>% # Group again to get intervals
#   mutate(
#     lower = quantile(coeff, 0.025), # Calculate lower bound of the interval
#     upper = quantile(coeff, 0.975), # Calculate upper bound of the interval
#     significant = ifelse(lower > 0 | upper < 0, "Significant", "Not Significant")
#   ) %>%
#   ungroup() %>%
#   ggplot() +
#     stat_pointinterval(
#       aes(x = coeff, y = shortname, color = significant), # Color by significance
#       .width = .95,
#       fatten_point = 1.2
#     ) +
#     geom_vline(xintercept = 0, col = 'blue', size = 0.5) +
#     scale_color_manual(values = c("Significant" = "red", "Not Significant" = "black")) + # Set colors
#     labs(x = "Coefficient", y = "Shortname", color = "95% CI") + # Improved labels
#     theme_bw()
```

# reclassifiy the sample exposure type using the newly cleaned med data

```{r}
exposures <- read_csv('../../MSS_pipeline-/scripts/food_tree/data/191_all_medication_overlapping_with_prior_2_day_of_stool_samples_upated.csv') %>%    group_by(sampleid, sdrt, pid) %>%
  summarize(
    exposure_category = case_when(
      any(drug_category_for_this_study == "broad_spectrum") ~ "broad_spectrum",
      any(drug_category_for_this_study == "fluoroquinolones") ~ "fluoroquinolones",
      any(drug_category_for_this_study == "other_antibacterials") ~ "other_antibacterial",
      TRUE ~ "no_abx"  # Default case if neither "apple" nor "orange" is found
    )
  ) 
 
exposures %>% count(exposure_category!= med_exposure_type)

no_abx_and_fq <- exposures %>% 
  filter(exposure_category %in% c('fluoroquinolones','no_abx'))


```

```{r}
expodat <- read_csv('../../MSS_pipeline-/scripts/food_tree/data/191_all_medication_overlapping_with_prior_2_day_of_stool_samples_upated_2.csv') 

```

# no_abx VS FQ

```{r}
meta <- read_csv('../data/153_combined_META.csv') %>% 
  mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(pid = factor(pid)) %>% 
  mutate(fg_egg = fg_egg/100,
         fg_fruit = fg_fruit/100,
         fg_grain = fg_grain/100,
         fg_legume = fg_legume/100,
         fg_meat = fg_meat/100,
         fg_milk = fg_milk/100,
         fg_oils = fg_oils/100,
         fg_sweets = fg_sweets/100,
         fg_veggie = fg_veggie/100) %>% 
  full_join(exposures) %>% 
  filter(exposure_category %in% c('no_abx','fluoroquinolones')) %>% 
  mutate(abx = if_else(exposure_category == 'no_abx', '0_no_abx', '1_FQ'),abx = factor(abx)) %>% 
  #mutate(abx = if_else(empirical == 'TRUE', '2_broad', if_else(sampleid %in% fg_and_other, '1_fq_and_other','0_no_abx')),abx = factor(abx)) %>% 
  mutate(TPN = if_else(TPN == 'TRUE', 1, 0),
         EN = if_else(EN == 'TRUE', 1, 0)) 

num_annot <- meta %>% 
  split(.$abx) %>% 
  imap_dfr(function(df, name_) {
    df %>% distinct(pid) %>% nrow
  }) %>% gather('abx','pt_num') %>% 
  full_join(meta %>% count(abx) %>% mutate(abx = as.character(abx))) %>% 
  rename(sample_num = n) %>% 
  #mutate(antibiotics = if_else(empirical == 'FALSE', 'not exposed', 'exposed')) %>% 
  mutate(lbl = str_glue('{sample_num} samples\nfrom {pt_num} patients'))

mod_original <- log(simpson_reciprocal) ~ 0 +        
                intensity+
                abx+
               fg_fruit:abx+
                fg_meat:abx+
                fg_milk:abx+
                fg_oils:abx+
                fg_egg:abx+
                fg_grain:abx+
                fg_sweets:abx+
                fg_legume:abx+
                fg_veggie:abx+
                TPN+
                EN+
               (1 | pid) +
                (1 | timebin)
get_prior(mod_original,data = meta )
```


```{r}
div_priors_original <- c(# for the food group variables 
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_egg"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_fruit"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_grain"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_legume"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_meat"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_milk"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_oils"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_sweets"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_veggie"),
            # interaction terms
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_egg"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_fruit"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_grain"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_legume"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_meat"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_milk"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_oils"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_sweets"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_veggie"),
    
            # for the TPN
            prior(normal(0, 0.1), class = 'b', coef = "TPN"),
            # for the EN
            prior(normal(0, 0.1), class = 'b', coef = "EN"),
            # for the empirical
            prior(normal(0, 0.5), class = 'b', coef = "abx1_FQ"),
            # for the intensity
            prior(normal( 2, .1), class = 'b', coef = "intensityablative"),
            prior(normal( 2, .1), class = 'b', coef = "intensityreduced"),
            prior(normal( 2, .1), class = 'b', coef = "intensitynonablative")
            )

model_div_original <- brm( mod_original,  
              data = meta, 
              warmup = 1000, iter = 3000, 
              prior = div_priors_original,
              cores = ncores, 
              chains = 2, 
               control = list(adapt_delta = 0.99),
              seed = 123, sample_prior = T)

# save it for future use
post_res <- suppressWarnings(posterior_samples(model_div_original)) 
post_res %>%  write_csv('../data/18_model_div_original_no_abx_and_FQ.csv')


```

```{r}
post_res <- read_csv('../data/18_model_div_original_no_abx_and_FQ.csv') %>% 
   select(starts_with('b')) %>% 
  select(!contains('intensity')) %>% 
  gather('shortname','coeff') %>% 
  mutate(shortname = str_replace(shortname, 'b_abx._',''))

post_res %>% 
  group_by(shortname) %>% # Group by shortname to calculate medians per group
  mutate(median_coeff = median(coeff)) %>% # Calculate median for each shortname
  ungroup() %>% # Important to ungroup after calculating the median
  mutate(shortname = fct_reorder(shortname, median_coeff)) %>% 
  group_by(shortname) %>% # Group again to get intervals
  mutate(
    lower = quantile(coeff, 0.025), # Calculate lower bound of the interval
    upper = quantile(coeff, 0.975), # Calculate upper bound of the interval
    significant = ifelse(lower >= 0 | upper <= 0, "Significant", "Not Significant")
  ) %>%
  ungroup() %>%
  ggplot() +
    stat_pointinterval(
      aes(x = coeff, y = shortname, color = significant), # Color by significance
      .width = .95,
      fatten_point = 1.2
    ) +
    geom_vline(xintercept = 0, col = 'blue', size = 0.5) +
    scale_color_manual(values = c("Significant" = "red", "Not Significant" = "black")) + # Set colors
    labs(x = "Coefficient", y = "Shortname", color = "95% CI") + # Improved labels
    theme_bw()
ggsave('../data/18_model_div_original_no_abx_and_FQ.pdf', width = 7)  
```
```{r}
# for the above model I also wanna show that what time were they collected     
meta %>%  
  mutate(log_div = log(simpson_reciprocal)) %>% 
  mutate(antibiotics = if_else(exposure_category == 'no_abx', 'not exposed', 'exposed'),
         antibiotics = factor(antibiotics, levels = c('not exposed','exposed'))) %>% 
  ggscatter(x = 'sdrt', y = 'log_div', color = 'antibiotics',
            ylab = 'log(diversity)',xlab = 'sdrt',
            alpha = 0.35, shape = 16, size = 1,
            add = "reg.line",  # Add regressin line
           add.params = list(color = 'antibiotics', fill = 'antibiotics', alpha = 0.3, size = 1.5), # Customize line
           conf.int = TRUE, # Add confidence interval
           cor.coef = TRUE, # Add correlation coefficient.
           cor.coeff.args = list(method = "spearman",  label.sep = "\n", cor.coef.name = c("rho"),p.accuracy = 0.01, r.accuracy = 0.01,label.x.npc = "left", label.y.npc = "bottom", size = 3.5)) +
  #geom_text(data = num_annot, aes(label = lbl), 
   #           x = Inf, y = Inf, hjust = 0.6, vjust = 1.5) +
  scale_fill_manual('antibiotics', values = palette, labels=c('not exposed', 'exposed')) +
  scale_colour_manual('antibiotics',values = palette, labels=c('not exposed', 'exposed')) +
  facet_wrap(~ antibiotics, labeller = 'label_both', dir = 'h') +
  theme(aspect.ratio = 1/1.15,   
        #legend.position = 'none', 
          strip.background = element_blank(),
        strip.text.x = element_blank(), 
     axis.text=element_text(size=9), axis.title=element_text(size=9)) 
```


  