---
title: "FQ battle"
output: html_document
date: "2025-01-27" 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(cowplot)
library(broom.mixed)
library(brms)   
library(ggpubr)
library(tidybayes)
library(brmstools)
library(bayesplot)
library(gt)
library(ggtext)
rstan::rstan_options(auto_write = TRUE)
theme_set(theme_tidybayes() + panel_border())
```

# diversity

```{r}
# abx in three levels: no abx, FQ only and broad-spectrum
exposures <- read_csv('../../MSS_pipeline-/scripts/food_tree/data/191_all_medication_overlapping_with_prior_2_day_of_stool_samples_upated_2.csv') %>%    
  group_by(sampleid, sdrt, pid) %>%
  summarize(
    exposure_category = case_when(
      any(drug_category_for_this_study == "broad_spectrum") ~ "broad_spectrum",
      any(drug_category_for_this_study == "fluoroquinolones") ~ "fluoroquinolones",
      any(drug_category_for_this_study == "other_antibacterials") ~ "other_antibacterial",
      TRUE ~ "no_abx"  # Default case if neither "apple" nor "orange" is found
    )
  ) %>% ungroup()

exposures %>% count(exposure_category)
```

## tally the exposure numbers

```{r}
# Calculate the total number of unique patients and samples for percentages.
total_samples <- nrow(exposures)
total_patients <- n_distinct(exposures$pid)

# First, create the summary data, including clean labels for the final table.
summary_data <- exposures %>%
  group_by(exposure_category) %>%
  summarise(
    n_samples = n(),
    n_patients = n_distinct(pid),
    .groups = 'drop'
  ) %>%
  mutate(
    percent_samples = (n_samples / total_samples) * 100,
    percent_patients = (n_patients / total_patients) * 100,
    # Create the clean, descriptive labels for the final table rows.
    exposure_category_label = recode(exposure_category,
                                    "no_abx" = "No Antibiotics",
                                    "fluoroquinolones" = "Fluoroquinolones (Prophylactic)",
                                    "broad_spectrum" = "Broad-spectrum",
                                    "other_antibacterial" = "Other antibacterial")
  )

# Next, create the final table structure with the 'Total' row.
summary_table_for_gt <- summary_data %>%
  # Arrange the data in the desired order before adding the total row.
  arrange(factor(exposure_category, levels = c("no_abx", "fluoroquinolones", "broad_spectrum", "other_antibacterial"))) %>%
  # Add the final 'Total' row.
  bind_rows(
    summarise(
      .,
      # Summing n_samples is correct.
      n_samples = sum(n_samples),
      # For patients, we use the pre-calculated total of *unique* patients.
      n_patients = total_patients,
      # Percentages for the total row should be 100.
      percent_samples = 100,
      percent_patients = 100,
      # Add the label for the total row.
      exposure_category_label = "Total"
    )
  ) %>%
  # Select and reorder the final columns for the table.
  select(exposure_category_label, n_samples, percent_samples, n_patients, percent_patients)


# --- Create the Publication-Ready Table with gt ---
gt_table <- summary_table_for_gt %>%
  # Initialize the gt object, using the label column for row names.
  gt(rowname_col = "exposure_category_label") %>%
  
  # Add a main title for the table.
  tab_header(
    title = 'Cohort Antibiotic Exposure Summary'
  ) %>%
  
  # Create spanner headings to group related columns together.
  tab_spanner(
    label = md("**Samples**"),
    columns = c(n_samples, percent_samples)
  ) %>%
  tab_spanner(
    label = md("**Patients**"),
    columns = c(n_patients, percent_patients)
  ) %>%
  
  # Customize the final column labels.
  cols_label(
    n_samples = "N",
    percent_samples = "%",
    n_patients = "N",
    percent_patients = "%"
  ) %>%
  
  # Format the large count numbers to use comma separators.
  fmt_number(
    columns = c(n_samples, n_patients),
    decimals = 0
  ) %>%
  
  # Format the percentage columns to one decimal place.
  fmt_number(
    columns = c(percent_samples, percent_patients),
    decimals = 1
  ) %>%
  
  # Center align the content of all numeric columns.
  cols_align(
    align = "center",
    columns = where(is.numeric)
  ) %>%
  
  # Add a separator line and bold text to the 'Total' row for emphasis.
  tab_style(
    style = list(
      cell_borders(sides = "top", color = "black", weight = px(2)),
      cell_text(weight = "bold")
    ),
    locations = cells_body(rows = exposure_category_label == "Total")
  ) %>%
  # Add some final styling options for a polished look.
  opt_table_font(font = "sans-serif") %>%
  opt_table_outline() %>% 
  gt::gtsave(filename = "../data/R18_number_tally_abx_exposure.png") 
```


```{r}
      
meta <- read_csv('../data/153_combined_META.csv') %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>%
  mutate(pid = factor(pid)) %>%
    # This divides all the new intake columns by 100.
  mutate(across(starts_with("fg_"), ~ .x / 100)) %>% 
  full_join(exposures) %>% 
  # removing the other_antibacterial group
  filter(!exposure_category %in% c('other_antibacterial')) %>% 
  mutate(exposure_category = factor(exposure_category, levels = c("no_abx", "fluoroquinolones", "broad_spectrum"))) 
```
## model 

```{r}
all_food_vars <- meta %>% select(starts_with('fg')) %>% colnames()

# Create the interaction terms for all food variables in this iteration
interaction_terms <- paste(all_food_vars, "exposure_category", sep = ":")

# Build the full formula string dynamically
formula_string <- paste(
  "log(simpson_reciprocal) ~ 0 + intensity + exposure_category + TPN + EN +",
  paste(interaction_terms, collapse = " + "),
  "+ (1 | pid) + (1 | timebin)"
)

# Convert the string to a formula object
formula <- brms::bf(as.formula(formula_string))

# Build the priors by adding them together.
# This single prior() call applies to all coefficients listed in `all_food_coefs`.
priors <-
    prior(normal(0, 1), class = 'b') + # General prior for all food effects
    # Specific priors that override the general one for non-food covariates
    prior(normal(0, 0.1), class = 'b', coef = "TPNTRUE") +
    prior(normal(0, 0.1), class = 'b', coef = "ENTRUE") +
    prior(normal(0, 0.5), class = 'b', coef = "exposure_categorybroad_spectrum") +
    prior(normal(0, 0.5), class = 'b', coef = "exposure_categoryfluoroquinolones") +
    prior(normal(2, .1), class = 'b', coef = "intensityablative") +
    prior(normal(2, .1), class = 'b', coef = "intensityreduced") +
    prior(normal(2, .1), class = 'b', coef = "intensitynonablative")

# Fit the model (using fewer iterations for this example to run quickly)
model_fit <- brm(
  formula = formula,
  data = meta,
  prior = priors,
    warmup = 1000, iter = 3000,
    chains = 4, cores = 4,
    seed = 123,
    silent = 2,
  control = list(adapt_delta = 0.99)
)

results_df <- tidy(model_fit, conf.int = TRUE) %>%
  mutate(conf.low = round(conf.low, 2),
         conf.high = round(conf.high, 2))

```

## forest plot

```{r}
# --- Data Wrangling ---
# Clean up the term names to make them usable for plotting.
# This involves separating the food group from the antibiotic category.
plot_data <- results_df %>%
  # Filter out the main antibiotic effects for now, we're focusing on diet.
  filter(str_detect(term, "fg_")) %>%
  # Separate the 'term' column into two new columns: 'antibiotic_group' and 'food_group'.
  separate(term, into = c("antibiotic_group", "food_group"), sep = ":fg_") %>%
  # Clean up the names to be more readable for the plot labels.
  mutate(
    antibiotic_group = str_remove(antibiotic_group, "exposure_category") %>%
                       str_replace("no_abx", "No Antibiotics") %>%
                       str_replace("fluoroquinolones", "Fluoroquinolones") %>%
                       str_replace("broad_spectrum", "Broad-spectrum"),
    
    # Standardize the food group names to match the desired labels exactly.
    food_group_clean = case_when(
        food_group == "sweets" ~ "Sweets",
        food_group == "grain"  ~ "Grains",
        food_group == "milk"   ~ "Milk",
        food_group == "egg"    ~ "Eggs",
        food_group == "legume" ~ "Legumes",
        food_group == "meat"   ~ "Meats",
        food_group == "fruit"  ~ "Fruits",
        food_group == "oils"   ~ "Oils",
        food_group == "veggie" ~ "Vegetables",
        TRUE ~ str_to_title(food_group) # A fallback for any other groups
    )
  ) %>%
  # Set the order of the facets so "No Antibiotics" comes first.
  mutate(food_group_ordered = factor(food_group_clean, levels = rev(c(
        "Sweets", "Grains", "Milk", "Eggs", "Legumes", 
        "Meats", "Fruits", "Oils", "Vegetables"
    ))),
    antibiotic_group = factor(antibiotic_group, 
                                   levels = c("No Antibiotics", "Fluoroquinolones", "Broad-spectrum"))) %>%
  # Create a new column to identify significant results
  # The condition is TRUE if conf.low and conf.high have the same sign (i.e., don't cross zero)
  mutate(is_significant = (conf.low * conf.high) > 0) 

# --- Plotting ---
# Create the faceted dot-and-whisker plot.
plot_stratify_abx <- ggplot(plot_data, aes(x = estimate, y = food_group_ordered)) +
  # Add the horizontal line for the confidence interval.
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2, color = "gray50") +
   # Use geom_pointrange to show the estimate (point) and confidence interval (line)
   geom_pointrange(
   aes(xmin = conf.low, xmax = conf.high, color = is_significant),
     size = 0.25,linewidth = 1,
  ) +
  # Add a vertical line at zero, which is the "no effect" line.
   geom_vline(xintercept = 0, linetype = "solid", color = "blue",size = 0.8) +
  # This is the key part: create the three separate panels.
  facet_wrap(~antibiotic_group, ncol = 3) +
  # Add labels and a title.
  labs(
    title = "Sweets Intake is Associated with Lower Microbiome Diversity\nPrimarily During Broad-spectrum Antibiotic Exposure",
    x = "ln(diversity) Change per 100g Food Intake",
    y = "Food Group"
  ) +
  scale_color_manual(
    values = c(
      "TRUE" = "red",
      "FALSE" = "black"
    ), name = "Effect Status" # Legend title
  ) +
  # Use a clean, publication-ready theme.
  theme_bw() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    legend.position = 'none',
    strip.text = element_text(size = 12, face = "bold"),
    axis.text.y = element_text(size = 11)
  )

plot_stratify_abx
```
## assemble 

```{r}
table_tally <- ggdraw() + draw_image("../data/R18_number_tally_abx_exposure.png", scale = 1)


final_plot <- plot_grid( table_tally ,  plot_stratify_abx , 
                nrow  = 2,
                 rel_heights = c(1.6,2),
                labels = 'auto',
                align = 'vh', axis = 'lrtb')


title <- ggdraw() + 
  draw_label("Rebuttal Fig X",fontface = 'bold', x = 0,hjust = 0) +
  theme(plot.margin = margin(0, 0, 0, 0))

combined <- plot_grid(
  title, final_plot,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.05, 1)
) +theme(plot.margin = unit(c(1,1,1,1), "cm"))

ggsave('../data/R18_abx_three_levels_stratification.pdf',
      width = 8.5, height = 11, units = "in", device = 'pdf', 
      dpi = 300)       
```

# Enterococcus with three levels of abx

```{r}
# clr_res <- read_csv('../data/171_genus_CLR_res.csv')
# clr_Enterococcus <- clr_res %>% 
#   filter(genus %in% c('Enterococcus')) %>%
#   spread('genus','clr')
# 
# meta <- read_csv('../data/153_combined_META.csv') %>% 
#   mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>% 
#   mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
#   mutate(pid = factor(pid)) %>% 
#   inner_join(clr_Enterococcus)%>% 
#   mutate(empirical = if_else(empirical == 'TRUE', '2_broad', if_else(sampleid %in% fg_and_other, '1_fq_and_other','0_no_abx')),
#          empirical = factor(empirical)) 
# 
# entero_model_original <- Enterococcus ~ 0 +
#              intensity+
#                 empirical+
#                fg_fruit:empirical+
#                 fg_meat:empirical+
#                 fg_milk:empirical+
#                 fg_oils:empirical+
#                 fg_egg:empirical+
#                 fg_grain:empirical+
#                 fg_sweets:empirical+
#                 fg_legume:empirical+
#                 fg_veggie:empirical+
#                 TPN+
#                 EN+
#                (1 | pid) +
#                 (1 | timebin)
# get_prior(formula = entero_model_original, data = meta)
```

```{r}
# priors_enterococcus_original <- c(# for the food group variables
#          prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_egg"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_fruit"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_grain"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_legume"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_meat"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_milk"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_oils"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_sweets"),
#             prior(normal(0, 1), class = 'b', coef = "empirical0_no_abx:fg_veggie"),
#             # interaction terms
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_egg"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_fruit"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_grain"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_legume"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_meat"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_milk"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_oils"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_sweets"),
#             prior(normal(0, 1), class = 'b', coef = "empirical1_fq_and_other:fg_veggie"),
#                       # interaction terms
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_egg"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_fruit"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_grain"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_legume"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_meat"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_milk"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_oils"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_sweets"),
#             prior(normal(0, 1), class = 'b', coef = "empirical2_broad:fg_veggie"),
#             # for the TPN
#             prior(normal(0, 0.1), class = 'b', coef = "TPNTRUE"),
#             # for the EN
#             prior(normal(0, 0.1), class = 'b', coef = "ENTRUE"),
#             # for the empirical
#             prior(normal(0, 0.5), class = 'b', coef = "empirical1_fq_and_other"),
#             prior(normal(0, 0.5), class = 'b', coef = "empirical2_broad")
#             
#             )
# 
# mod_entero =  brm(entero_model_original,  
#                 data = meta, 
#               warmup = 1000, iter = 3000, 
#               prior = priors_enterococcus_original,
#               cores = ncores, 
#               chains = 2, 
#               control = list(adapt_delta = 0.99),
#               seed = 456)
# 
# post_res <- suppressWarnings(posterior_samples(mod_entero)) 
# 
# post_res %>% 
#   select(starts_with('b')) %>% 
#   select(!contains('intensity')) %>% 
#   gather('shortname','coeff') %>% 
#   #filter(!shortname %in% c('b_empirical2_broad','b_empirical1_fq_and_other', 'b_ENTRUE', 'b_TPNTRUE')) %>% 
#   group_by(shortname) %>% # Group by shortname to calculate medians per group
#   mutate(median_coeff = median(coeff)) %>% # Calculate median for each shortname
#   ungroup() %>% # Important to ungroup after calculating the median
#   mutate(shortname = fct_reorder(shortname, median_coeff)) %>% 
#   group_by(shortname) %>% # Group again to get intervals
#   mutate(
#     lower = quantile(coeff, 0.025), # Calculate lower bound of the interval
#     upper = quantile(coeff, 0.975), # Calculate upper bound of the interval
#     significant = ifelse(lower > 0 | upper < 0, "Significant", "Not Significant")
#   ) %>%
#   ungroup() %>%
#   ggplot() +
#     stat_pointinterval(
#       aes(x = coeff, y = shortname, color = significant), # Color by significance
#       .width = .95,
#       fatten_point = 1.2
#     ) +
#     geom_vline(xintercept = 0, col = 'blue', size = 0.5) +
#     scale_color_manual(values = c("Significant" = "red", "Not Significant" = "black")) + # Set colors
#     labs(x = "Coefficient", y = "Shortname", color = "95% CI") + # Improved labels
#     theme_bw()
```


# no_abx VS FQ

```{r}
no_abx_and_fq <- exposures %>% 
  filter(exposure_category %in% c('fluoroquinolones','no_abx'))
```

```{r}
meta <- read_csv('../data/153_combined_META.csv') %>% 
  mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(pid = factor(pid)) %>% 
  mutate(fg_egg = fg_egg/100,
         fg_fruit = fg_fruit/100,
         fg_grain = fg_grain/100,
         fg_legume = fg_legume/100,
         fg_meat = fg_meat/100,
         fg_milk = fg_milk/100,
         fg_oils = fg_oils/100,
         fg_sweets = fg_sweets/100,
         fg_veggie = fg_veggie/100) %>% 
  full_join(exposures) %>% 
  filter(exposure_category %in% c('no_abx','fluoroquinolones')) %>% 
  mutate(abx = if_else(exposure_category == 'no_abx', '0_no_abx', '1_FQ'),abx = factor(abx)) %>% 
  #mutate(abx = if_else(empirical == 'TRUE', '2_broad', if_else(sampleid %in% fg_and_other, '1_fq_and_other','0_no_abx')),abx = factor(abx)) %>% 
  mutate(TPN = if_else(TPN == 'TRUE', 1, 0),
         EN = if_else(EN == 'TRUE', 1, 0)) 

num_annot <- meta %>% 
  split(.$abx) %>% 
  imap_dfr(function(df, name_) {
    df %>% distinct(pid) %>% nrow
  }) %>% gather('abx','pt_num') %>% 
  full_join(meta %>% count(abx) %>% mutate(abx = as.character(abx))) %>% 
  rename(sample_num = n) %>% 
  #mutate(antibiotics = if_else(empirical == 'FALSE', 'not exposed', 'exposed')) %>% 
  mutate(lbl = str_glue('{sample_num} samples\nfrom {pt_num} patients'))

mod_original <- log(simpson_reciprocal) ~ 0 +        
                intensity+
                abx+
               fg_fruit:abx+
                fg_meat:abx+
                fg_milk:abx+
                fg_oils:abx+
                fg_egg:abx+
                fg_grain:abx+
                fg_sweets:abx+
                fg_legume:abx+
                fg_veggie:abx+
                TPN+
                EN+
               (1 | pid) +
                (1 | timebin)
get_prior(mod_original,data = meta )
```


```{r}
div_priors_original <- c(# for the food group variables 
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_egg"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_fruit"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_grain"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_legume"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_meat"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_milk"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_oils"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_sweets"),
            prior(normal(0, 1), class = 'b', coef = "abx0_no_abx:fg_veggie"),
            # interaction terms
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_egg"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_fruit"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_grain"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_legume"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_meat"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_milk"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_oils"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_sweets"),
            prior(normal(0, 1), class = 'b', coef = "abx1_FQ:fg_veggie"),
    
            # for the TPN
            prior(normal(0, 0.1), class = 'b', coef = "TPN"),
            # for the EN
            prior(normal(0, 0.1), class = 'b', coef = "EN"),
            # for the empirical
            prior(normal(0, 0.5), class = 'b', coef = "abx1_FQ"),
            # for the intensity
            prior(normal( 2, .1), class = 'b', coef = "intensityablative"),
            prior(normal( 2, .1), class = 'b', coef = "intensityreduced"),
            prior(normal( 2, .1), class = 'b', coef = "intensitynonablative")
            )

model_div_original <- brm( mod_original,  
              data = meta, 
              warmup = 1000, iter = 3000, 
              prior = div_priors_original,
              cores = ncores, 
              chains = 2, 
               control = list(adapt_delta = 0.99),
              seed = 123, sample_prior = T)

# save it for future use
post_res <- suppressWarnings(posterior_samples(model_div_original)) 
post_res %>%  write_csv('../data/18_model_div_original_no_abx_and_FQ.csv')


```

```{r}
post_res <- read_csv('../data/18_model_div_original_no_abx_and_FQ.csv') %>% 
   select(starts_with('b')) %>% 
  select(!contains('intensity')) %>% 
  gather('shortname','coeff') %>% 
  mutate(shortname = str_replace(shortname, 'b_abx._',''))

post_res %>% 
  group_by(shortname) %>% # Group by shortname to calculate medians per group
  mutate(median_coeff = median(coeff)) %>% # Calculate median for each shortname
  ungroup() %>% # Important to ungroup after calculating the median
  mutate(shortname = fct_reorder(shortname, median_coeff)) %>% 
  group_by(shortname) %>% # Group again to get intervals
  mutate(
    lower = quantile(coeff, 0.025), # Calculate lower bound of the interval
    upper = quantile(coeff, 0.975), # Calculate upper bound of the interval
    significant = ifelse(lower >= 0 | upper <= 0, "Significant", "Not Significant")
  ) %>%
  ungroup() %>%
  ggplot() +
    stat_pointinterval(
      aes(x = coeff, y = shortname, color = significant), # Color by significance
      .width = .95,
      fatten_point = 1.2
    ) +
    geom_vline(xintercept = 0, col = 'blue', size = 0.5) +
    scale_color_manual(values = c("Significant" = "red", "Not Significant" = "black")) + # Set colors
    labs(x = "Coefficient", y = "Shortname", color = "95% CI") + # Improved labels
    theme_bw()
ggsave('../data/18_model_div_original_no_abx_and_FQ.pdf', width = 7)  
```
```{r}
# for the above model I also wanna show that what time were they collected     
meta %>%  
  mutate(log_div = log(simpson_reciprocal)) %>% 
  mutate(antibiotics = if_else(exposure_category == 'no_abx', 'not exposed', 'exposed'),
         antibiotics = factor(antibiotics, levels = c('not exposed','exposed'))) %>% 
  ggscatter(x = 'sdrt', y = 'log_div', color = 'antibiotics',
            ylab = 'log(diversity)',xlab = 'sdrt',
            alpha = 0.35, shape = 16, size = 1,
            add = "reg.line",  # Add regressin line
           add.params = list(color = 'antibiotics', fill = 'antibiotics', alpha = 0.3, size = 1.5), # Customize line
           conf.int = TRUE, # Add confidence interval
           cor.coef = TRUE, # Add correlation coefficient.
           cor.coeff.args = list(method = "spearman",  label.sep = "\n", cor.coef.name = c("rho"),p.accuracy = 0.01, r.accuracy = 0.01,label.x.npc = "left", label.y.npc = "bottom", size = 3.5)) +
  #geom_text(data = num_annot, aes(label = lbl), 
   #           x = Inf, y = Inf, hjust = 0.6, vjust = 1.5) +
  scale_fill_manual('antibiotics', values = palette, labels=c('not exposed', 'exposed')) +
  scale_colour_manual('antibiotics',values = palette, labels=c('not exposed', 'exposed')) +
  facet_wrap(~ antibiotics, labeller = 'label_both', dir = 'h') +
  theme(aspect.ratio = 1/1.15,   
        #legend.position = 'none', 
          strip.background = element_blank(),
        strip.text.x = element_blank(), 
     axis.text=element_text(size=9), axis.title=element_text(size=9)) 
```


  