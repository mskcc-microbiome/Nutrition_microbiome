---
title: "Germ free"
output: html_document
date: "2025-07-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(janitor)
library(ggrepel)
library(scales)
library(patchwork)
```


```{r}
# Manually create a tibble that contains every event for every group.
# This "long" data format is ideal for plotting with ggplot2.
# This version includes the stool plating at 144h for the E. faecalis groups.
experiment_design_df <- tribble(
  ~group_name, ~y_position, ~color_group, ~time_h, ~event_type,
  # Group 1: E. faecalis + Sucrose Water
  "E. faecalis + Sucrose Water", 4, "Sucrose Water",   0, "BHI Anaerobic Culture",
  "E. faecalis + Sucrose Water", 4, "Sucrose Water",   4, "Stool Plating",
  "E. faecalis + Sucrose Water", 4, "Sucrose Water",   8, "Stool Plating",
  "E. faecalis + Sucrose Water", 4, "Sucrose Water",  24, "Stool Plating",
  "E. faecalis + Sucrose Water", 4, "Sucrose Water",  48, "Stool Plating",
  "E. faecalis + Sucrose Water", 4, "Sucrose Water", 144, "Stool Plating", # Final stool plating

  # Group 2: E. faecalis + Regular Water
  "E. faecalis + Regular Water", 3, "Regular Water",   0, "BHI Anaerobic Culture",
  "E. faecalis + Regular Water", 3, "Regular Water",   4, "Stool Plating",
  "E. faecalis + Regular Water", 3, "Regular Water",   8, "Stool Plating",
  "E. faecalis + Regular Water", 3, "Regular Water",  24, "Stool Plating",
  "E. faecalis + Regular Water", 3, "Regular Water",  48, "Stool Plating",
  "E. faecalis + Regular Water", 3, "Regular Water", 144, "Stool Plating", # Final stool plating

  # Group 3: PBS + Sucrose Water
  "PBS + Sucrose Water", 2, "Sucrose Water",   0, "BHI Anaerobic Culture",
  "PBS + Sucrose Water", 2, "Sucrose Water",   4, "Stool Plating",
  "PBS + Sucrose Water", 2, "Sucrose Water",  48, "BHI Anaerobic Culture",
  "PBS + Sucrose Water", 2, "Sucrose Water", 144, "", # No final stool plating for PBS group

  # Group 4: PBS + Regular Water
  "PBS + Regular Water", 1, "Regular Water",   0, "BHI Anaerobic Culture",
  "PBS + Regular Water", 1, "Regular Water",   4, "Stool Plating",
  "PBS + Regular Water", 1, "Regular Water",  48, "BHI Anaerobic Culture",
  "PBS + Regular Water", 1, "Regular Water", 144, ""  # No final stool plating for PBS group
)

# Now, create the diagram using ggplot.
ggplot(experiment_design_df, aes(x = time_h, y = y_position)) +
  # Draw the horizontal timelines for each group.
  geom_line(aes(group = group_name), color = "gray40", linewidth = 0.8) +
  
  # Add points for each event, mapping shape to event_type and color to color_group.
  geom_point(aes(shape = event_type, color = color_group), size = 4, alpha = 0.9) +
  
  # Manually define the colors and shapes to match the request.
  scale_color_manual(values = c("Sucrose Water" = "#F8766D", "Regular Water" = "#00BFC4")) +
  scale_shape_manual(values = c("BHI Anaerobic Culture" = 15, "Stool Plating" = 17, "Sacrifice" = 16)) + # 15=square, 17=triangle, 16=circle
  
  # Add the group labels to the left of the timelines.
  geom_text(
    data = experiment_design_df %>% distinct(group_name, y_position),
    aes(x = -2, y = y_position, label = group_name),
    hjust = 1,
    fontface = "bold"
  ) +
  
  # Use a clean theme for a diagrammatic look.
  theme_classic(base_size = 14) +
  theme(
    axis.line.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) +
  
  # Add informative titles and labels.
  labs(
    title = "Germ-Free Mouse Experiment Design",
    x = "Time Post-Gavage (Hours)",
    color = "Water Treatment",
    shape = "Action"
  ) +
  
  # Customize the x-axis breaks to show all key time points.
  # The label for 144h is updated to include the sacrifice information.
  scale_x_continuous(
    breaks = c(0, 4, 8, 24, 48, 144),
    labels = c("0", "4", "8", "24", "48", "144\n(Sacrifice)")
  ) +
  
  # Expand plot limits so labels on the left are not cut off.
  coord_cartesian(xlim = c(-45, 150))


ggsave('../data/R33_gf_design_new.pdf', width = 10)
```


# the CFU

for this figure:


-plot with a thickish line for the group median and thin semi-transparent spaghetti tracings for inividual mice
-add p value; can be with Vardi test or GEE

```{r}
# Load the data from the CSV file.
# The `read_csv` function is great because it handles column types automatically.
raw_data <- read_csv("../data/7_29_25_germ_free_faecalis_gavage - sheet1.csv") %>% 
  # We can only plot values greater than 0 on a log scale.
  mutate(CFUs_per_GramStool = if_else(CFUs_per_GramStool == 0, 1, CFUs_per_GramStool)) %>% 
  mutate(log10_CFUs_per_GramStool = log10(CFUs_per_GramStool))
```


```{r}
# add the pre-innoculation (hour 0) enterococcus abundance (0 from bhi anaerobic culturing)  
baseline_data <- tibble(
  # The 'Time Point' is the same for all baseline measurements.
  `Time Point` = rep("0h (pre-innoculation)", 10),
  
  # A vector containing the unique group IDs for each of the 10 mice.
  `Mouse Group` = c("1-1", "1-3", "1-10", 
                    "2-1", "2-3", "2-10", 
                    "3-1", "3-3", 
                    "4-1", "4-3"),
                    
  # The notes column specifies the source of the germ-free confirmation.
  Notes = rep("BHI anaerobic culturing", 10),
  
  # The CFU/gram is set to 1, representing the limit of detection (no growth).
  `CFUs_per_GramStool` = rep(1, 10),
  
  # The log10 of 1 is 0.
  `log10_CFUs_per_GramStool` = rep(0, 10)
)


no_gavage_culturing_48 <- tibble(
  # The 'Time Point' is the same for all baseline measurements.
  `Time Point` = rep("48h", 4),
  
  # A vector containing the unique group IDs for each of the 10 mice.
  `Mouse Group` = c(
                    "3-1", "3-3", 
                    "4-1", "4-3"),
                    
  # The notes column specifies the source of the germ-free confirmation.
  Notes = rep("BHI anaerobic culturing", 4),
  
  # The CFU/gram is set to 1, representing the limit of detection (no growth).
  `CFUs_per_GramStool` = rep(1, 4),
  
  # The log10 of 1 is 0.
  `log10_CFUs_per_GramStool` = rep(0, 4)
)

all_raw <- bind_rows(baseline_data, raw_data , no_gavage_culturing_48)
```


```{r}
# Clean and transform the data for plotting.
plot_data <- all_raw %>%
  # Use mutate to create new, cleaner columns.
  mutate(
    # Convert the 'Time Point' text into a numerical hour for the x-axis.
    Time_h = case_when(
      `Time Point` == "0h (pre-innoculation)" ~ 0,
      `Time Point` == "4h post gavage" ~ 4,
      `Time Point` == "48h" ~ 48,
      `Time Point` == "8h post gavage" ~ 8,
      `Time Point` == "24h post gavage" ~ 24,
      `Time Point` == "48h post gavage" ~ 48,
      `Time Point` == "144h post gavage" ~ 144
    ),
    # Create descriptive labels for the four treatment groups.
    Treatment = case_when(
      str_starts(`Mouse Group`, "1-") ~ "E. faecalis + Sucrose Water",
      str_starts(`Mouse Group`, "2-") ~ "E. faecalis + Regular Water",
      str_starts(`Mouse Group`, "3-") ~ "PBS + Sucrose Water",
      str_starts(`Mouse Group`, "4-") ~ "PBS + Regular Water"
    ),
    # Ensure the treatment groups are ordered correctly in the plot panels.
    Treatment = factor(Treatment, levels = c(
      "E. faecalis + Sucrose Water", "E. faecalis + Regular Water",
      "PBS + Sucrose Water", "PBS + Regular Water"
    ))
  ) %>%
  # Remove any rows where time could not be parsed.
  filter(!is.na(Time_h))

plot_data %>% write_csv('../data/R33_germ_free_data_for_plot.csv')
```


```{r}
# --- Plot Generation ---

# --- Split Data for Two Plots ---

# Data for the top row (gavage groups)
gavage_plot_data <- plot_data %>%
  filter(str_starts(`Mouse Group`, "[12]-"))

# Data for the bottom row (PBS control groups)
pbs_plot_data <- plot_data %>%
  filter(str_starts(`Mouse Group`, "[34]-"))

# Calculate mean for each subset
gavage_mean_data <- gavage_plot_data %>%
  group_by(Treatment, Time_h) %>%
  summarise(Mean_CFU = mean(`CFUs_per_GramStool`, na.rm = TRUE), .groups = 'drop')

# the median
gavage_median_data <- gavage_plot_data %>%
  group_by(Treatment, Time_h) %>%
  summarise(median_CFU = median(`CFUs_per_GramStool`, na.rm = TRUE), .groups = 'drop')

pbs_mean_data <- pbs_plot_data %>%
  group_by(Treatment, Time_h) %>%
  summarise(Mean_CFU = mean(`CFUs_per_GramStool`, na.rm = TRUE), .groups = 'drop')


# Calculate the full y-axis range across all data to ensure scales are identical.
# The lower limit is set to 1 (for log scale) and the upper limit is the max CFU value.
y_limits <- c(1, max(plot_data$`CFUs_per_GramStool`, na.rm = TRUE))
# Define consistent x-axis limits for all plots.
x_limits <- c(0, 144)
# Define consistent x-axis breaks for all plots.
x_breaks <- c(0, 4, 8, 24, 48, 144)

# --- Plot Generation ---

# Define a common theme to reuse
common_theme <- theme_bw(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5, color = "gray30"),
    strip.text = element_text(face = "bold", size = 11),
    panel.grid.minor = element_blank()
  )

# Plot 1: Top Row (Gavage Groups)
p1 <- ggplot() +
  geom_line(data = gavage_plot_data, aes(x = Time_h, y = `CFUs_per_GramStool`, group = `Mouse Group`, color = Treatment), alpha = 0.3, linewidth = 0.5) +
  geom_point(data = gavage_plot_data, aes(x = Time_h, y = `CFUs_per_GramStool`, group = `Mouse Group`, color = Treatment), alpha = 0.3) +
  geom_line(data = gavage_mean_data, aes(x = Time_h, y = Mean_CFU, color = Treatment), linewidth = 1.2) +
  scale_y_log10(labels = trans_format("log10", math_format(10^.x)), oob = oob_squish_infinite, limits = y_limits) +
 # Set both the breaks and the limits for the x-axis.
  scale_x_continuous(breaks = x_breaks, limits = x_limits) +
  facet_wrap(~Treatment, ncol = 2) +
  labs(x = "Time Post-Gavage (Hours)", y = "CFU / gram of feces") +
  common_theme

# Plot 2: Bottom Row (PBS Groups)
p2 <- ggplot() +
  geom_line(data = pbs_plot_data, aes(x = Time_h, y = `CFUs_per_GramStool`, group = `Mouse Group`, color = Treatment), alpha = 0.3, linewidth = 0.5) +
  geom_point(data = pbs_plot_data, aes(x = Time_h, y = `CFUs_per_GramStool`, group = `Mouse Group`, color = Treatment), alpha = 0.3) +
  geom_line(data = pbs_mean_data, aes(x = Time_h, y = Mean_CFU, color = Treatment), linewidth = 1.2) +
  scale_y_log10(labels = trans_format("log10", math_format(10^.x)), oob = oob_squish_infinite, limits = y_limits) +
  # Set both the breaks and the limits for the x-axis.
  scale_x_continuous(breaks = x_breaks, limits = x_limits) +
  facet_wrap(~Treatment, ncol = 2) +
  # Remove the x-axis title and labels for the bottom plot
  labs(x = "Time (Hours)",  y = "CFU / gram of feces") +
  common_theme 

# Combine the two plots vertically using patchwork
p1 / p2 +
  plot_annotation(
    title = "Bacterial Colonization Timeline in Germ-Free Mice",
    subtitle = "Individual mouse trajectories with group means",
    theme = theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 20),
                  plot.subtitle = element_text(hjust = 0.5, color = "gray30", size = 14))
  )


ggsave('../data/R33_gf_full_course.jpg', width = 10, height = 7)
```

```{r}
# if annotating the median as the line
p1_with_median <- ggplot() +
  geom_line(data = gavage_plot_data, aes(x = Time_h, y = `CFUs_per_GramStool`, group = `Mouse Group`, color = Treatment), alpha = 0.3, linewidth = 0.5) +
  geom_point(data = gavage_plot_data, aes(x = Time_h, y = `CFUs_per_GramStool`, group = `Mouse Group`, color = Treatment), alpha = 0.3) +
  geom_line(data = gavage_median_data, aes(x = Time_h, y = median_CFU, color = Treatment), linewidth = 1.2) +
  scale_y_log10(labels = trans_format("log10", math_format(10^.x)), oob = oob_squish_infinite, limits = y_limits) +
 # Set both the breaks and the limits for the x-axis.
  scale_x_continuous(breaks = x_breaks, limits = x_limits) +
  facet_wrap(~Treatment, ncol = 2) +
  labs(x = "Time Post-Gavage (Hours)", y = "CFU / gram of feces") +
  common_theme

p1_with_median / p2 +
  plot_annotation(
    title = "Bacterial Colonization Timeline in Germ-Free Mice",
    subtitle = "Individual mouse trajectories with group medians",
    theme = theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 20),
                  plot.subtitle = element_text(hjust = 0.5, color = "gray30", size = 14))
  )


ggsave('../data/R33_gf_full_course_with_median.jpg', width = 10, height = 7)
```
```{r}
# one figure where I only plot the median and the mean line
summary_data <- bind_rows(
  gavage_median_data %>% mutate(Metric = 'summarized with median') %>% rename(CFU = median_CFU),
  gavage_mean_data %>% mutate(Metric = 'summarized with mean')%>% rename(CFU = Mean_CFU)
)
```


```{r}
ggplot(summary_data, aes(x = Time_h, y = CFU, color = Treatment, linetype = Metric)) +
  # Draw lines connecting the points. The linetype (solid vs. dashed) will distinguish mean from median.
  geom_line(linewidth = 1.2, alpha = 0.8) +
  # Add points to show the exact measurement at each time point.
  geom_point(size = 3.5, alpha = 0.8) +
  
  # Set the Y axis to a log10 scale and format the labels as 10^x.
  scale_y_log10(
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)),
    # We add a limit of 1 so the zero values are included at the baseline.
    limits = c(1, NA)
  ) +
  
  # Use a clean theme and add informative titles and labels.
  theme_bw(base_size = 14) +
  facet_grid(~ Metric) +
  labs(
    title = "Mean vs. Median E. faecalis Colonization",
    subtitle = "Comparing Sucrose vs. Regular Water Groups",
    x = "Time Post-Gavage (Hours)",
    y = "CFU / gram of feces",
    color = "Treatment Group",
    linetype = "Metric"
  ) +
  
  # Customize the plot's appearance.
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    legend.position = "right",
    legend.title = element_text(face = "bold")
  )

ggsave('../data/R33_gm_summaries_2.jpg', width = 10, height = 5)
```



# the AUC test 

```{r}
library(DescTools) 
library(ggpubr)

analysis_data <- plot_data %>%
  # First, filter for only the groups of interest (E. faecalis gavage).
  filter(str_starts(`Mouse Group`, "1-") | str_starts(`Mouse Group`, "2-"))

# Now, calculate the AUC for each mouse.
# We group by mouse ID and treatment, then summarize to get one AUC value per mouse.
auc_results <- analysis_data %>%
  group_by(`Mouse Group`, Treatment) %>%
  summarize(
    # The AUC function from DescTools calculates the area under the curve.
    # We use the log-transformed CFU values for this calculation.
    auc_value = AUC(x = Time_h, y = log10_CFUs_per_GramStool),
    # The .groups = 'drop' argument cleans up the grouping structure afterward.
    .groups = 'drop'
  )

# Let's look at the calculated AUC values for each mouse.
print("AUC calculated for each mouse:")
print(auc_results)

# Finally, perform the Wilcoxon rank-sum test (Mann-Whitney U test).
# This compares the distribution of AUC values between the two treatment groups.
# It's ideal here because the sample size is small and we can't assume normality.
statistical_test <- wilcox.test(auc_value ~ Treatment, data = auc_results)

# Print the results of the statistical test.
print("--- Wilcoxon Rank-Sum Test Results ---")
print(statistical_test)

# To visualize the result, a simple boxplot of the AUC values is helpful.
ggplot(auc_results, aes(x = Treatment, y = auc_value, fill = Treatment)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.1, size = 3) +
  # This function from ggpubr runs the test and adds the p-value to the plot.
  stat_compare_means(
    method = "wilcox.test", 
    comparisons = list(c("E. faecalis + Sucrose Water", "E. faecalis + Regular Water")),
    label = "p.format" # Displays the p-value in a standard format.
  ) +
  labs(
    title = "Comparison of Total Bacterial Load (AUC)",
    x = "Treatment Group",
    y = "Area Under Curve (log10 CFU * hours)"
  ) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none")


```

