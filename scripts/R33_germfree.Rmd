---
title: "Germ free"
output: html_document
date: "2025-07-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(janitor)
library(ggrepel)
library(scales)
library(patchwork)
```

```{r}

# First, we set up a data frame that defines the four experimental groups.
# Giving each group a unique y_position helps us stack them vertically in the plot.
groups_df <- tibble(
  group_id = 1:4,
  gavage = c("E. faecalis", "E. faecalis", "PBS", "PBS"),
  water = c("Sucrose Water", "Regular Water", "Sucrose Water", "Regular Water"),
  group_label = paste(gavage, water, sep = " + "),
  y_position = c(4, 3, 2, 1) # This staggers the timelines vertically.
)

# Next, we define all the events and their timing in hours.
# Day 3 is represented as 72 hours to keep the x-axis consistent.
# We also assign a category to each event to control its shape in the plot.
events_df <- tibble(
  time_point = c(0, 5, 10, 20, 72),
  event_label = c("Gavage", "Stool Collection", "Stool Collection", "Stool Collection", "Sacrifice"),
  event_shape = c("Gavage", "Stool", "Stool", "Stool", "Stool")
)

# Here, we combine the groups and events to create the full data frame for plotting.
# expand_grid() creates a row for every combination of group and event.
experiment_df <- expand_grid(
  groups_df,
  events_df
)

# Now, we create the diagram using ggplot.
ggplot(experiment_df, aes(x = time_point, y = y_position)) +
  # This draws the main horizontal timelines for each group.
  geom_line(aes(group = group_id), color = "gray50", linewidth = 1) +

  # This adds points for each event, using different shapes to distinguish them.
  geom_point(aes(shape = event_shape), size = 5, color = "steelblue") +
  # Manually set the shapes: 17=triangle, 16=circle, 15=square.
  scale_shape_manual(values = c("Gavage" = 17, "Stool" = 16, "Sacrifice" = 15)) +

  # This adds the text labels for each experimental group to the left of the timelines.
  geom_text(
    data = groups_df,
    aes(x = -1, y = y_position, label = group_label),
    hjust = 1, # Aligns the text to the right, just before the timeline starts.
    fontface = "bold",
    size = 4
  ) +

  # This section cleans up the plot to make it look like a diagram rather than a standard chart.
  theme_void() + # Removes background, gridlines, and axes.
  theme(
    axis.text.x = element_text(color = "black", size = 11, face = "bold"),
    axis.title.x = element_text(color = "black", size = 14, face = "bold", margin = margin(t = 10)),
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 14, hjust = 0.5, margin = margin(b = 20)),
    plot.margin = margin(20, 20, 20, 20),
    legend.position = "none" # The shapes are intuitive, so we hide the legend.
  ) +

  # Add the main titles and a label for the x-axis.
  labs(
    x = "Experimental Timeline",
    title = "Germ-Free Mouse Experiment Design",
    subtitle = "Timeline of Treatment and Sample Collection"
  ) +

  # This customizes the labels on the x-axis to be more descriptive.
  scale_x_continuous(
    breaks = c(0, 5, 10, 20, 72),
    labels = c("Time 0\n(Gavage)", "5 hr", "10 hr", "20 hr", "Day 3\n(Sacrifice)")
  ) +

  # Finally, this expands the plot area slightly so the labels on the left aren't cut off.
  coord_cartesian(xlim = c(-20, 80))

ggsave('../data/R33_gf_design.pdf', width = 10)
```
# the CFU

for this figure:


-plot with a thickish line for the group median and thin semi-transparent spaghetti tracings for inividual mice
-add p value; can be with Vardi test or GEE

```{r}
# Load the data from the CSV file.
# The `read_csv` function is great because it handles column types automatically.
raw_data <- read_csv("../data/7_29_25_germ_free_faecalis_gavage - sheet1.csv") %>% 
  # We can only plot values greater than 0 on a log scale.
  mutate(CFUs_per_GramStool = if_else(CFUs_per_GramStool == 0, 1, CFUs_per_GramStool)) %>% 
  mutate(log10_CFUs_per_GramStool = log10(CFUs_per_GramStool))
```


```{r}
# add the pre-innoculation (hour 0) enterococcus abundance (0 from bhi anaerobic culturing)  
baseline_data <- tibble(
  # The 'Time Point' is the same for all baseline measurements.
  `Time Point` = rep("0h (pre-innoculation)", 10),
  
  # A vector containing the unique group IDs for each of the 10 mice.
  `Mouse Group` = c("1-1", "1-3", "1-10", 
                    "2-1", "2-3", "2-10", 
                    "3-1", "3-3", 
                    "4-1", "4-3"),
                    
  # The notes column specifies the source of the germ-free confirmation.
  Notes = rep("BHI anaerobic culturing", 10),
  
  # The CFU/gram is set to 1, representing the limit of detection (no growth).
  `CFUs_per_GramStool` = rep(1, 10),
  
  # The log10 of 1 is 0.
  `log10_CFUs_per_GramStool` = rep(0, 10)
)


no_gavage_culturing_48 <- tibble(
  # The 'Time Point' is the same for all baseline measurements.
  `Time Point` = rep("48h", 4),
  
  # A vector containing the unique group IDs for each of the 10 mice.
  `Mouse Group` = c(
                    "3-1", "3-3", 
                    "4-1", "4-3"),
                    
  # The notes column specifies the source of the germ-free confirmation.
  Notes = rep("BHI anaerobic culturing", 4),
  
  # The CFU/gram is set to 1, representing the limit of detection (no growth).
  `CFUs_per_GramStool` = rep(1, 4),
  
  # The log10 of 1 is 0.
  `log10_CFUs_per_GramStool` = rep(0, 4)
)

all_raw <- bind_rows(baseline_data, raw_data , no_gavage_culturing_48)
```


```{r}
# Clean and transform the data for plotting.
plot_data <- all_raw %>%
  # Use mutate to create new, cleaner columns.
  mutate(
    # Convert the 'Time Point' text into a numerical hour for the x-axis.
    Time_h = case_when(
      `Time Point` == "0h (pre-innoculation)" ~ 0,
      `Time Point` == "4h post gavage" ~ 4,
      `Time Point` == "48h" ~ 48,
      `Time Point` == "8h post gavage" ~ 8,
      `Time Point` == "24h post gavage" ~ 24,
      `Time Point` == "48h post gavage" ~ 48,
      `Time Point` == "144h post gavage" ~ 144
    ),
    # Create descriptive labels for the four treatment groups.
    Treatment = case_when(
      str_starts(`Mouse Group`, "1-") ~ "E. faecalis + Sucrose Water",
      str_starts(`Mouse Group`, "2-") ~ "E. faecalis + Regular Water",
      str_starts(`Mouse Group`, "3-") ~ "PBS + Sucrose Water",
      str_starts(`Mouse Group`, "4-") ~ "PBS + Regular Water"
    ),
    # Ensure the treatment groups are ordered correctly in the plot panels.
    Treatment = factor(Treatment, levels = c(
      "E. faecalis + Sucrose Water", "E. faecalis + Regular Water",
      "PBS + Sucrose Water", "PBS + Regular Water"
    ))
  ) %>%
  # Remove any rows where time could not be parsed.
  filter(!is.na(Time_h))



# --- Plot Generation ---

# --- Split Data for Two Plots ---

# Data for the top row (gavage groups)
gavage_plot_data <- plot_data %>%
  filter(str_starts(`Mouse Group`, "[12]-"))

# Data for the bottom row (PBS control groups)
pbs_plot_data <- plot_data %>%
  filter(str_starts(`Mouse Group`, "[34]-"))

# Calculate mean for each subset
gavage_mean_data <- gavage_plot_data %>%
  group_by(Treatment, Time_h) %>%
  summarise(Mean_CFU = mean(`CFUs_per_GramStool`, na.rm = TRUE), .groups = 'drop')

# the median
gavage_median_data <- gavage_plot_data %>%
  group_by(Treatment, Time_h) %>%
  summarise(median_CFU = median(`CFUs_per_GramStool`, na.rm = TRUE), .groups = 'drop')

pbs_mean_data <- pbs_plot_data %>%
  group_by(Treatment, Time_h) %>%
  summarise(Mean_CFU = mean(`CFUs_per_GramStool`, na.rm = TRUE), .groups = 'drop')


# Calculate the full y-axis range across all data to ensure scales are identical.
# The lower limit is set to 1 (for log scale) and the upper limit is the max CFU value.
y_limits <- c(1, max(plot_data$`CFUs_per_GramStool`, na.rm = TRUE))
# Define consistent x-axis limits for all plots.
x_limits <- c(0, 144)
# Define consistent x-axis breaks for all plots.
x_breaks <- c(0, 4, 8, 24, 48, 144)

# --- Plot Generation ---

# Define a common theme to reuse
common_theme <- theme_bw(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5, color = "gray30"),
    strip.text = element_text(face = "bold", size = 11),
    panel.grid.minor = element_blank()
  )

# Plot 1: Top Row (Gavage Groups)
p1 <- ggplot() +
  geom_line(data = gavage_plot_data, aes(x = Time_h, y = `CFUs_per_GramStool`, group = `Mouse Group`, color = Treatment), alpha = 0.3, linewidth = 0.5) +
  geom_point(data = gavage_plot_data, aes(x = Time_h, y = `CFUs_per_GramStool`, group = `Mouse Group`, color = Treatment), alpha = 0.3) +
  geom_line(data = gavage_mean_data, aes(x = Time_h, y = Mean_CFU, color = Treatment), linewidth = 1.2) +
  scale_y_log10(labels = trans_format("log10", math_format(10^.x)), oob = oob_squish_infinite, limits = y_limits) +
 # Set both the breaks and the limits for the x-axis.
  scale_x_continuous(breaks = x_breaks, limits = x_limits) +
  facet_wrap(~Treatment, ncol = 2) +
  labs(x = "Time Post-Gavage (Hours)", y = "CFU / gram of feces") +
  common_theme

# Plot 2: Bottom Row (PBS Groups)
p2 <- ggplot() +
  geom_line(data = pbs_plot_data, aes(x = Time_h, y = `CFUs_per_GramStool`, group = `Mouse Group`, color = Treatment), alpha = 0.3, linewidth = 0.5) +
  geom_point(data = pbs_plot_data, aes(x = Time_h, y = `CFUs_per_GramStool`, group = `Mouse Group`, color = Treatment), alpha = 0.3) +
  geom_line(data = pbs_mean_data, aes(x = Time_h, y = Mean_CFU, color = Treatment), linewidth = 1.2) +
  scale_y_log10(labels = trans_format("log10", math_format(10^.x)), oob = oob_squish_infinite, limits = y_limits) +
  # Set both the breaks and the limits for the x-axis.
  scale_x_continuous(breaks = x_breaks, limits = x_limits) +
  facet_wrap(~Treatment, ncol = 2) +
  # Remove the x-axis title and labels for the bottom plot
  labs(x = "Time (Hours)",  y = "CFU / gram of feces") +
  common_theme 

# Combine the two plots vertically using patchwork
p1 / p2 +
  plot_annotation(
    title = "Bacterial Colonization Timeline in Germ-Free Mice",
    subtitle = "Individual mouse trajectories with group means",
    theme = theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 20),
                  plot.subtitle = element_text(hjust = 0.5, color = "gray30", size = 14))
  )


ggsave('../data/R33_gf_full_course.jpg', width = 10, height = 7)
```

```{r}
# if annotating the median as the line
p1_with_median <- ggplot() +
  geom_line(data = gavage_plot_data, aes(x = Time_h, y = `CFUs_per_GramStool`, group = `Mouse Group`, color = Treatment), alpha = 0.3, linewidth = 0.5) +
  geom_point(data = gavage_plot_data, aes(x = Time_h, y = `CFUs_per_GramStool`, group = `Mouse Group`, color = Treatment), alpha = 0.3) +
  geom_line(data = gavage_median_data, aes(x = Time_h, y = median_CFU, color = Treatment), linewidth = 1.2) +
  scale_y_log10(labels = trans_format("log10", math_format(10^.x)), oob = oob_squish_infinite, limits = y_limits) +
 # Set both the breaks and the limits for the x-axis.
  scale_x_continuous(breaks = x_breaks, limits = x_limits) +
  facet_wrap(~Treatment, ncol = 2) +
  labs(x = "Time Post-Gavage (Hours)", y = "CFU / gram of feces") +
  common_theme

p1_with_median / p2 +
  plot_annotation(
    title = "Bacterial Colonization Timeline in Germ-Free Mice",
    subtitle = "Individual mouse trajectories with group medians",
    theme = theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 20),
                  plot.subtitle = element_text(hjust = 0.5, color = "gray30", size = 14))
  )


ggsave('../data/R33_gf_full_course_with_median.jpg', width = 10, height = 7)
```



# the AUC test 

```{r}
library(DescTools) 
library(ggpubr)

analysis_data <- plot_data %>%
  # First, filter for only the groups of interest (E. faecalis gavage).
  filter(str_starts(`Mouse Group`, "1-") | str_starts(`Mouse Group`, "2-"))

# Now, calculate the AUC for each mouse.
# We group by mouse ID and treatment, then summarize to get one AUC value per mouse.
auc_results <- analysis_data %>%
  group_by(`Mouse Group`, Treatment) %>%
  summarize(
    # The AUC function from DescTools calculates the area under the curve.
    # We use the log-transformed CFU values for this calculation.
    auc_value = AUC(x = Time_h, y = log10_CFUs_per_GramStool),
    # The .groups = 'drop' argument cleans up the grouping structure afterward.
    .groups = 'drop'
  )

# Let's look at the calculated AUC values for each mouse.
print("AUC calculated for each mouse:")
print(auc_results)

# Finally, perform the Wilcoxon rank-sum test (Mann-Whitney U test).
# This compares the distribution of AUC values between the two treatment groups.
# It's ideal here because the sample size is small and we can't assume normality.
statistical_test <- wilcox.test(auc_value ~ Treatment, data = auc_results)

# Print the results of the statistical test.
print("--- Wilcoxon Rank-Sum Test Results ---")
print(statistical_test)

# To visualize the result, a simple boxplot of the AUC values is helpful.
ggplot(auc_results, aes(x = Treatment, y = auc_value, fill = Treatment)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.1, size = 3) +
  # This function from ggpubr runs the test and adds the p-value to the plot.
  stat_compare_means(
    method = "wilcox.test", 
    comparisons = list(c("E. faecalis + Sucrose Water", "E. faecalis + Regular Water")),
    label = "p.format" # Displays the p-value in a standard format.
  ) +
  labs(
    title = "Comparison of Total Bacterial Load (AUC)",
    x = "Treatment Group",
    y = "Area Under Curve (log10 CFU * hours)"
  ) +
  theme_classic(base_size = 14) +
  theme(legend.position = "none")


```

