---
title: "Clinical outcome"
output: html_document
date: "2024-07-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(LCAtoolbox)
library(gtsummary)
library(ggsurvfit)
library(tidycmprsk)
library(survival)
library(ggpubr)
library(gt)
library(cowplot)
library(survminer)
library(patchwork)
```


# load the cleaned data

```{r}
# load("../data/df_main.Rdata")
# link <- read_csv('../../MSS_pipeline-/scripts/food_tree/data/152_pid_match.csv')
# 
# df_main <- df_main |>
#   mutate(gvhdppx_CNI = as.numeric(gvhd_ppx == "CNI-based"),
#          gvhdppx_PTCy = as.numeric(gvhd_ppx == "PTCy-based"))
# 
# 
# colnames(df_main)
# df_main <- df_main %>%
#   select(source:gvhdppx_PTCy) %>%
#   mutate(mrn = as.numeric(mrn_str)) %>%
#   full_join(link) %>%
#   select(-d100_a_gvhd_onset, -mrn_str, -agvhd_onset,  -mrn) %>%
#   relocate(pid, .before = 'source')
# 
# df_main %>% write_rds('../data/R02_cleaned_clinical_outcome.rds')

# the below table has the pid
df_main <- read_rds('../data/R02_cleaned_clinical_outcome.rds') %>%
  mutate(modal_diet = as.character(modal_diet),
         modal_diet = if_else(modal_diet == 'High intake', 'Higher-intake', 'Lower-intake/sugar-enriched'),
         modal_diet = factor(modal_diet, levels = c('Lower-intake/sugar-enriched','Higher-intake'))) %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(source_and_gvhdppx = str_glue('{source}+{gvhd_ppx}'),
         source_and_gvhdppx = factor(source_and_gvhdppx, levels = c('TCD+TCD','Cord+CNI-based','Unmodified+CNI-based','Unmodified+PTCy-based')))
df_main %>% count(source_and_gvhdppx)
```
 
```{r}
colnames(df_main)
df_main %>% count(type_gvhd_simple)
df_main %>% count(type_gvhd)
```
 
 
# OS model



```{r survival}
# since the below is not significant, so we will stick to the lower intake and higher intake survival curve
# higher_OS <- survfit2(Surv(OStime_30,OSevent)~day_exposed_cat, data = df_main |> filter(OStime_30 > 0 & modal_diet == "Higher-intake")) %>%
#   ggsurvfit(linewidth = 0.8) +
#   add_pvalue("annotation",size=5) +
#   add_risktable()+
#   ylab("Survival probability") +
#   xlab("Days relative to HCT, landmarked at day 12")+
#   ylim(c(0,1)) +
#   ggtitle("Patients with higher intake")+
#   theme(aspect.ratio = 1)
# 
# lower_OS <- survfit2(Surv(OStime_30,OSevent)~day_exposed_cat, data = df_main |> filter(OStime_30 > 0 & modal_diet == "Lower-intake/sugar-enriched")) %>%
#   ggsurvfit(linewidth = 0.8) +
#   add_pvalue("annotation",size=5) +
#   add_risktable()+
#   ylab("Survival probability") +
#   xlab("Days relative to HCT, landmarked at day 12")+
#   ylim(c(0,1)) +
#   ggtitle("Patients with lower intake (sugar-enriched)") +
#   theme(aspect.ratio = 1)
```

## survival 

```{r survival}
# survival between two clusters
OS_clusers <- survfit2(Surv(OStime_30,OSevent)~modal_diet  , data = df_main |> filter(OStime_30 > 0 )) %>%
  ggsurvfit(linewidth = 0.8) +
  add_pvalue("annotation",size=5) +
  add_risktable()+
  ylab("Survival probability") +
  xlab("Days relative to HCT, landmarked at day 12")+
   scale_color_manual(values = c( "darkslateblue",  "darkgoldenrod2"), name = '') +
  ylim(c(0,1)) +
  ggtitle("")+
  theme(aspect.ratio = 1/1.5, legend.position = c(0.5, 0.3))
OS_clusers

survival_plot <- list(
  ggsurvfit::ggsurvfit_build(OS_clusers)
) |> 
  wrap_plots()
```


## model fit

```{r OS_model}
# rename the columns so that they look nice in the output table!
input_df <- df_main |> 
  filter(OStime_30 > 0) %>% 
  rename(Diet_pattern_cluster = modal_diet,
         Exposure_days_to_abx =day_exposed,
         Conditioning_intensity = intensity,
         Graft_type_and_GvHD_prophylaxis = source_and_gvhdppx)


fit <- coxph(Surv(OStime_30,OSevent)~Diet_pattern_cluster*Exposure_days_to_abx  + Conditioning_intensity + Graft_type_and_GvHD_prophylaxis,
             data= input_df)


# fit_original <- coxph(Surv(OStime_30,OSevent)~modal_diet*day_exposed  + intensity + source + gvhd_ppx,
#              data=df_main |> filter(OStime_30 > 0) ) 
```

```{r OS_model}
fit |> 
  tbl_regression(exponentiate = FALSE) |> 
  bold_p() |> 
  as_gt() |> 
  gtsave(filename="../data/09_OS_model.png")

```
 
```{r}
coef(fit)[2]
```
 

```{r}
## The following lines construct a Wald test on the association between abx exposure and OS for high intake patients.
diff <- sum(coef(fit)[c(2,8)])
p <- aod::wald.test(Sigma=vcov(fit)[c(2,8),c(2,8)],
                    b=coef(fit)[c(2,9)],
                    L=t(c(1,1)))

## Visualizing associations between abx and OS for low and high intake patient groups:
loghr <- data.frame(exposure = 0:20,
                    hr = exp(c(coef(fit)[2]*0:20,
                               diff*0:20)),
                    group = c(rep("Low intake",21),
                              rep("High intake",21)),
                    ub = exp(c((coef(fit)[2]+sqrt(vcov(fit)[2,2])*1.96)*0:20,
                               (diff+1.96*sqrt(sum(vcov(fit)[c(2,8),c(2,8)])))*0:20)),
                    lb = exp(c((coef(fit)[2]-sqrt(vcov(fit)[2,2])*1.96)*0:20,
                               (diff-1.96*sqrt(sum(vcov(fit)[c(2,8),c(2,8)])))*0:20))
)
```

# abx_diet_logHR

```{r abx_VS_diet_logHR}
abx_diet_logHR <- loghr |> 
  mutate(group = if_else(group == 'Low intake', 'Lower-intake/sugar-enriched', 'Higher-intake'),
         group = factor(group, levels = c('Lower-intake/sugar-enriched','Higher-intake'))) %>% 
  ggplot(aes(x=exposure,y=hr)) + 
  geom_line(aes(color=group), size = 1.5)+
  geom_ribbon(aes(ymin=lb,ymax=ub),alpha=0.2) +
  geom_hline(yintercept = 1,color="black",linetype=2)+
  scale_y_continuous(transform = "log",labels=function(x) sprintf("%.0f", x))+
  #facet_grid(.~group, labeller = labeller(facet_var = c("Higher intake" = "Lower intake", "Lower intake" = "Higher intake"))) +
  facet_grid(.~group) +
  ylab("log(Hazard ratio) of death\ncompared to non-exposure patients") + 
  xlab("Number of days exposed to broad-spectrum\nantibiotics between day -7 to 12\nrelative to transplant") + theme_light()+
  scale_color_manual(values = c( "darkslateblue", 'darkgoldenrod2'), name = '') +
  theme(aspect.ratio = 1,  legend.position = 'none') 
     
abx_diet_logHR
```

# ignored for now

```{r}
tidycmprsk::cuminc(Surv(tevent_30,TRMevent)~day_exposed_cat, data = df_main |> filter(OStime_30 > 0 & modal_diet == "Higher intake")) %>%
  ggcuminc(linewidth = 0.8, outcome="TRM") +
  add_risktable()+
  ylab("TRM cumulative incidence") +
  xlab("Days relative to HCT, landmarked at day 12")+
  ylim(c(0,0.15))+
  ggtitle("Patients with high intake")

tidycmprsk::cuminc(Surv(tevent_30,TRMevent)~day_exposed_cat, data = df_main |> filter(OStime_30 > 0 & modal_diet == "Low intake")) %>%
  ggcuminc(linewidth = 0.8, outcome="TRM") +
  add_risktable()+
  ylab("TRM cumulative incidence") +
  xlab("Days relative to HCT, landmarked at day 12")+
  ylim(c(0,0.15))+
  ggtitle("Patients with low intake")



fitTRM <- crr(Surv(tevent_30,TRMevent) ~ as.factor(modal_diet)*day_exposed + source + intensity + gvhdppx_PTCy, data=df_main |> filter(tevent_30 > 0)) |>
  tbl_regression(exponentiate = FALSE) |>
  bold_p() |>
  as_gt() |>
  gtsave(filename="../data/TRM_model.html")

tidycmprsk::cuminc(Surv(tevent_30,GRMevent)~day_exposed_cat, data = df_main |> filter(OStime_30 > 0 & modal_diet == "High intake"& source!="TCD")) %>%
  ggcuminc(linewidth = 0.8, outcome="GRM") +
  add_risktable()+
  ylab("GRM cumulative incidence") +
  xlab("Days relative to HCT, landmarked at day 12")+
  ylim(c(0,0.15))+
  ggtitle("Non-TCD Patients with high intake")

tidycmprsk::cuminc(Surv(tevent_30,GRMevent)~day_exposed_cat, data = df_main |> filter(OStime_30 > 0 & modal_diet == "Low intake"& source!="TCD")) %>%
  ggcuminc(linewidth = 0.8, outcome="GRM") +
  add_risktable()+
  ylab("GRM cumulative incidence") +
  xlab("Days relative to HCT, landmarked at day 12")+
  ylim(c(0,0.15))+
  ggtitle("Non-TCD Patients with low intake")

fitGRM <- crr(Surv(tevent_30,GRMevent)~as.factor(modal_diet)*day_exposed + source + intensity + gvhd_ppx,data=df_main |> filter(tevent_30 > 0 & source!="TCD")) |>
  tbl_regression(exponentiate = FALSE)|>
  bold_p() |>
  as_gt() |>
  gtsave(filename="../data/GRM_model.html")


tidycmprsk::cuminc(Surv(tgvhd_event-12,type_gvhd_simple)~modal_diet, data = df_main |> filter(source!="TCD" & tgvhd_event-12 > 0)) %>%
  ggcuminc(linewidth = 0.8, outcome="aGVHD") +
  add_pvalue("annotation",size=5) +
  add_risktable()+
  # scale_color_manual(values=c("blue","red"))+
  ylab("aGVHD onset cumulative incidence") +
  xlab("Days relative to HCT (Landmarked at day 12)")+
  ylim(c(0,0.8))

tidycmprsk::cuminc(Surv(tgvhd_event-12,type_gvhd_simple)~day_exposed_cat, data = df_main |> filter(source!="TCD" & tgvhd_event-12 > 0 & modal_diet == "High intake")) %>%
  ggcuminc(linewidth = 0.8, outcome="aGVHD") +
  add_risktable()+
  ylab("aGVHD onset cumulative incidence") +
  xlab("Days relative to HCT, landmarked at day 12")+
  ylim(c(0,0.8))+
  ggtitle("Patients with high intake")

tidycmprsk::cuminc(Surv(tgvhd_event-12,type_gvhd_simple)~day_exposed_cat, data = df_main |> filter(source!="TCD" & tgvhd_event-12 > 0 & modal_diet == "Low intake")) %>%
  ggcuminc(linewidth = 0.8, outcome="aGVHD") +
  add_risktable()+
  ylab("aGVHD onset cumulative incidence") +
  xlab("Days relative to HCT, landmarked at day 12")+
  ylim(c(0,0.8))+
  ggtitle("Patients with low intake")

ggsave("../data/aGVHDonset.pdf")

fitAGVHD <- crr(Surv(tgvhd_event-12,type_gvhd_simple)~modal_diet + day_exposed + intensity + source + gvhd_ppx, data = df_main |> filter(source!="TCD" & tgvhd_event-12 > 0)) |>
  tbl_regression(exponentiate = FALSE)|>
  bold_p() |>
  as_gt() |>
  gtsave(filename="../data/aGVHDonset_model.html")
list.files('~/Work/projects/MSS_pipeline-/scripts/food_tree/data/')
```

#  now F3

```{r}
# the legend for the stacked bar graph
bar_leg <-  plot_grid(ggpubr::get_legend(Average_intake))
ggsave('../data/09_bar_leg.pdf')
```

```{r}
title <- ggdraw() + 
  draw_label(
    "Fig. 3",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    plot.margin = margin(0, 0, 0, 5)
  )

top <- plot_grid(pdiet2, pdiet2_comp, Average_intake_plot, Average_composition,
                 label_size = 12, ncol = 2,labels = c('A','B','C','D'),
                align = 'vh', axis = 'lrtb')




bottom <- plot_grid(survival_plot, abx_diet_logHR,
                 label_size = 12, ncol = 2,labels = c('E','F'),rel_widths  = c(1,1),
                align = 'vh', axis = 'lrtb')

all <- plot_grid(top, bottom, align = 'vh', axis = 'lrtb', nrow = 2, rel_heights = c(2,1.5))
 
combined <- plot_grid(
  title, all,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.05, 1)
)+theme(plot.margin = unit(c(1,1,1,1), "cm"))

ggsave('../data/09_clinical_outcome.pdf',
      width = 210, height = 297, units = "mm", device = 'pdf', plot = combined, dpi = 300)  
```


# supp figure  

```{r}
# just print the multivar table to the correct size

title <- ggdraw() + 
  draw_label(
    "Fig. S11",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    plot.margin = margin(0, 0, 0, 5)
  )


table_OS <- ggdraw() + draw_image("../data/09_OS_model.png", scale = .6)



combined <- plot_grid(
  title, table_OS,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.05, 1)
)+theme(plot.margin = unit(c(1,1,1,1), "cm"))

ggsave('../data/S11_clinical_outcome_supp_R09.pdf',
      width = 210, height = 297, units = "mm", device = 'pdf', plot = combined, dpi = 300)  
```
  

# revised a-gvhd onset analysis

```{r}
library(tidycmprsk)
library(ggsurvfit)
library(gtsummary)
library(gt)
library(tidyverse) 
load('../data/df_main_Sep18.Rdata')
  
df_main <- df_main %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(source_and_gvhdppx = str_glue('{source}+{gvhd_ppx}'))

df_main %>% count(type_gvhd_simple)
```

## aGVHD onset cumulative incidence ~ modal_diet

```{r}
# aGVHD onset cumulative incidence ~ modal_diet
cuminc_cluster <- tidycmprsk::cuminc(Surv(tgvhd_event-12,type_gvhd_simple)~modal_diet, data = df_main |> filter(source!="TCD" & tgvhd_event-12 > 0)) %>%
  ggcuminc(linewidth = 0.8, outcome="aGVHD") +
  add_risktable()+
  ylab("aGVHD onset cumulative incidence") +
  xlab("Days relative to HCT (Landmarked at day 12)")+
  ylim(c(0,0.8))


cuminc_cluster_plot <- list(
  ggsurvfit::ggsurvfit_build(cuminc_cluster)
) |> 
  wrap_plots()
```


```{r}
# aGVHD onset cumulative incidence ~ modal_diet
# high intake
tidycmprsk::cuminc(Surv(tgvhd_event-12,type_gvhd_simple)~day_exposed_cat, data = df_main |> filter(source!="TCD" & tgvhd_event-12 > 0 & modal_diet == "High intake")) %>%
  ggcuminc(linewidth = 0.8, outcome="aGVHD") +
  add_risktable()+
  ylab("aGVHD onset cumulative incidence") + 
  xlab("Days relative to HCT, landmarked at day 12")+
  ylim(c(0,0.8))+ 
  ggtitle("Patients with high intake")
```


```{r}
# aGVHD onset cumulative incidence ~ modal_diet
# low intake
tidycmprsk::cuminc(Surv(tgvhd_event-12,type_gvhd_simple)~day_exposed_cat, data = df_main |> filter(source!="TCD" & tgvhd_event-12 > 0 & modal_diet == "Low intake")) %>%
  ggcuminc(linewidth = 0.8, outcome="aGVHD") +
  add_risktable()+
  ylab("aGVHD onset cumulative incidence") + 
  xlab("Days relative to HCT, landmarked at day 12")+
  ylim(c(0,0.8))+ 
  ggtitle("Patients with low intake")
```

## aGVHDonset : multivariate

```{r}
# aGVHDonset : multivariate
fitAGVHD <- crr(Surv(tgvhd_event-12,type_gvhd_simple)~modal_diet + day_exposed + intensity + source_and_gvhdppx, data = df_main |> filter(source!="TCD" & tgvhd_event-12 > 0)) |> 
  tbl_regression(exponentiate = FALSE)|> 
  bold_p() |> 
  as_gt() |> 
  gtsave(filename="../data/aGVHDonset_model_multi.png")

# I tried the interactive version: modal_diet * day_exposed and the interaction term is not significant, so I can just have them as indenpendent ones. 
```

```{r}
# aGVHDonset : univariate
fitAGVHD <- crr(Surv(tgvhd_event-12,type_gvhd_simple)~modal_diet, data = df_main |> filter(source!="TCD" & tgvhd_event-12 > 0)) |> 
  tbl_regression(exponentiate = FALSE)|> 
  bold_p() |> 
  as_gt() |> 
  gtsave(filename="../data/aGVHDonset_model_uni.html")  
```

## R3 figure

```{r}
# I think it would be a good idea to make this R only figure including the c i curve with the two clusters and the multivariate model with the crr
 title <- ggdraw() + 
  draw_label(
    "Fig. R3",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    plot.margin = margin(0, 0, 0, 0)
  )


aGVHDonset_model_multi <- ggdraw() + draw_image("../data/aGVHDonset_model_multi.png", scale = 1)

plot_ <- plot_grid(cuminc_cluster_plot, aGVHDonset_model_multi,   nrow = 2, align = 'vh', axis = 'lrtb', labels = c('A','B'), rel_widths = c(2, 2))

combined <- plot_grid(
  title, plot_,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)+theme(plot.margin = unit(c(1,1,1,1), "cm"))

ggsave('../data/Fig_R3_aGVHD_onset.pdf',
      width = 210, height = 297, units = "mm", device = 'pdf', plot = combined, dpi = 300)  
```

